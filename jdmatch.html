<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JD Match Resume Generator - HireReady</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>
  <style>
    /* THEME: HireReady - Using existing design tokens from styles.css */
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 50%, #1a1420 100%);
      color: var(--text);
      min-height: 100vh;
      background-attachment: fixed;
    }

    .jdm-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER - Match HireReady topbar style */
    .jdm-header {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 16px 28px;
      background: rgba(11, 10, 18, 0.98);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .jdm-back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(182, 156, 255, 0.1);
      border: 1px solid rgba(182, 156, 255, 0.3);
      border-radius: 8px;
      color: var(--accentA);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-back-btn:hover {
      background: rgba(182, 156, 255, 0.18);
      border-color: rgba(182, 156, 255, 0.5);
      color: var(--accentA);
      transform: translateY(-1px);
    }

    .jdm-title {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(90deg, var(--accentA) 0%, var(--accentB) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* HERO SECTION */
    .jdm-hero {
      padding: 52px 28px 48px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
    }

    .jdm-hero-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 10px;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    .jdm-hero-subtitle {
      font-size: 14px;
      color: var(--muted2);
      margin: 0;
      line-height: 1.65;
    }

    /* MAIN LAYOUT - 3 Column Workspace */
    .jdm-main {
      flex: 1;
      width: 100%;
    }

    .jdm-main-container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 32px 28px;
      width: 100%;
    }

    .jdm-workspace {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 24px;
      align-items: start;
    }

    .jdm-workspace-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .jdm-workspace-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px 24px 22px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .jdm-workspace-section:hover {
      border-color: rgba(182, 156, 255, 0.35);
      box-shadow: 0 6px 28px rgba(0, 0, 0, 0.38), 0 1px 0 rgba(182, 156, 255, 0.08) inset;
    }

    .jdm-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .jdm-section-title::before {
      content: '';
      width: 3px;
      height: 16px;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      border-radius: 2px;
    }

    @media (max-width: 1200px) {
      .jdm-workspace {
        grid-template-columns: 1fr 1fr;
      }
      .jdm-workspace-column:nth-child(3) {
        grid-column: 1 / -1;
      }
    }

    @media (max-width: 768px) {
      .jdm-workspace {
        grid-template-columns: 1fr;
      }
      .jdm-main-container {
        padding: 16px 16px;
      }
      .jdm-hero {
        padding: 24px;
      }
    }

    /* STEP WIZARD - Premium guided workflow */
    .jdm-wizard {
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
      position: sticky;
      top: 61px;
      z-index: 90;
    }

    .jdm-wizard-container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .jdm-wizard-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .jdm-wizard-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      z-index: 0;
    }

    .jdm-wizard-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      position: relative;
      z-index: 1;
      padding: 0 12px;
    }

    .jdm-wizard-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--muted2);
      transition: all 0.3s ease;
      margin-bottom: 8px;
    }

    .jdm-wizard-step-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted2);
      text-align: center;
      margin-bottom: 4px;
      transition: all 0.3s ease;
    }

    .jdm-wizard-step-sublabel {
      font-size: 10px;
      color: var(--muted2);
      text-align: center;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .jdm-wizard-step.active .jdm-wizard-step-circle {
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      border-color: var(--accentA);
      color: white;
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.5), 0 4px 12px rgba(182, 156, 255, 0.3);
      animation: pulseGlow 2s ease-in-out infinite;
    }

    .jdm-wizard-step.active .jdm-wizard-step-label {
      color: var(--accentA);
      font-weight: 700;
    }

    .jdm-wizard-step.active .jdm-wizard-step-sublabel {
      color: var(--accentA);
      opacity: 0.8;
    }

    .jdm-wizard-step.completed .jdm-wizard-step-circle {
      background: rgba(34, 197, 94, 0.15);
      border-color: #22c55e;
      color: #22c55e;
    }

    .jdm-wizard-step:hover:not(.active) .jdm-wizard-step-circle {
      border-color: rgba(182, 156, 255, 0.4);
      background: rgba(182, 156, 255, 0.08);
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(182, 156, 255, 0.5), 0 4px 12px rgba(182, 156, 255, 0.3); }
      50% { box-shadow: 0 0 30px rgba(182, 156, 255, 0.7), 0 6px 16px rgba(182, 156, 255, 0.4); }
    }

    @media (max-width: 768px) {
      .jdm-wizard-step-sublabel { display: none; }
      .jdm-wizard-step-label { font-size: 11px; }
      .jdm-wizard-step-circle { width: 36px; height: 36px; font-size: 12px; }
    }

    /* PANEL CONTAINER */
    .jdm-panel {
      display: none;
      animation: fadeInUp 0.3s ease;
    }

    .jdm-panel.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* FORM SECTION - Match HireReady form styling */
    .jdm-form-group {
      margin-bottom: 20px;
    }

    .jdm-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 12px;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      line-height: 1.5;
    }

    .jdm-hint {
      display: block;
      font-size: 12px;
      color: var(--muted2);
      margin-bottom: 10px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: normal;
      line-height: 1.6;
    }

    .jdm-input,
    .jdm-textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .jdm-input:focus,
    .jdm-textarea:focus {
      outline: none;
      background: rgba(182, 156, 255, 0.06);
      border-color: rgba(182, 156, 255, 0.4);
      box-shadow: 0 0 0 3px rgba(182, 156, 255, 0.1);
    }

    /* Dark-themed select dropdown */
    select.jdm-select-dark {
      background-color: #1a1824;
      color: var(--text);
      border: 1px solid var(--border);
      appearance: auto;
      -webkit-appearance: auto;
    }
    select.jdm-select-dark:focus {
      outline: none;
      border-color: rgba(182, 156, 255, 0.4);
      box-shadow: 0 0 0 3px rgba(182, 156, 255, 0.1);
    }
    select.jdm-select-dark option {
      background-color: #1a1824;
      color: var(--text);
      padding: 8px 12px;
    }
    select.jdm-select-dark option:checked,
    select.jdm-select-dark option:hover {
      background-color: #2d2640;
      color: var(--text);
    }

    .jdm-textarea {
      resize: vertical;
      min-height: 120px;
      font-family: inherit;
    }

    /* TARGET MATCH with SLIDER */
    .jdm-target-section {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 24px;
    }

    .jdm-radio-group {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .jdm-radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .jdm-radio-option input[type="radio"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: var(--accentA);
    }

    .jdm-radio-option label {
      cursor: pointer;
      margin: 0;
      font-size: 13px;
      color: var(--text);
    }

    .jdm-slider-group {
      display: none;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }

    .jdm-slider-group.active {
      display: block;
    }

    .jdm-slider-wrapper {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .jdm-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.08);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .jdm-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(182, 156, 255, 0.4);
    }

    .jdm-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(182, 156, 255, 0.4);
    }

    .jdm-slider-input {
      width: 70px;
      padding: 8px 10px;
      background: rgba(182, 156, 255, 0.1);
      border: 1px solid rgba(182, 156, 255, 0.3);
      border-radius: 6px;
      color: var(--accentA);
      font-weight: 600;
      font-size: 13px;
      text-align: center;
    }

    .jdm-slider-value-display {
      min-width: 80px;
      text-align: right;
      font-size: 13px;
      color: var(--accentA);
      font-weight: 600;
    }

    /* SKILLS INPUT - COMMA SEPARATED */
    .jdm-skills-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .jdm-skills-input {
      padding: 12px 14px;
    }

    /* BASE RESUME */
    .jdm-resume-panel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 24px;
    }

    .jdm-resume-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      border-bottom: 1px solid var(--border);
    }

    .jdm-resume-tab-btn {
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted2);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-resume-tab-btn.active {
      color: var(--accentA);
      border-bottom-color: var(--accentA);
    }

    .jdm-resume-content {
      display: none;
    }

    .jdm-resume-content.active {
      display: block;
    }

    .jdm-upload-area {
      border: 2px dashed rgba(182, 156, 255, 0.3);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 12px;
    }

    .jdm-upload-area:hover {
      border-color: rgba(182, 156, 255, 0.6);
      background: rgba(182, 156, 255, 0.05);
    }

    .jdm-upload-area input {
      display: none;
    }

    .jdm-upload-text {
      color: var(--muted2);
      font-size: 12px;
    }

    .jdm-resume-actions {
      display: flex;
      gap: 8px;
    }

    .jdm-btn-secondary {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.12);
    }

    /* PRIMARY BUTTON - Match HireReady button style */
    .jdm-btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accentA) 0%, var(--accentB) 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .jdm-btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(182, 156, 255, 0.3);
    }

    .jdm-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .jdm-btn-primary.loading {
      background: linear-gradient(90deg, var(--accentA) 0%, var(--accentB) 50%, var(--accentA) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    /* RIGHT SIDEBAR */
    .jdm-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: 80px;
      height: fit-content;
    }

    .jdm-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    .jdm-card:hover {
      border-color: rgba(182, 156, 255, 0.4);
      background: rgba(182, 156, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .jdm-card-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .jdm-summary-item {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .jdm-summary-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .jdm-summary-label {
      color: var(--muted2);
    }

    .jdm-summary-value {
      color: var(--accentA);
      font-weight: 600;
    }

    /* ========================================
       RADIANT GLOW SYSTEM - Premium Interactive Effects
       ======================================== */
    
    /* Glow on Primary Buttons */
    .jdm-btn-primary:hover:not(:disabled),
    .jdm-btn-primary:focus:not(:disabled) {
      box-shadow: 0 0 24px rgba(182, 156, 255, 0.6), 0 12px 24px rgba(182, 156, 255, 0.3);
      filter: brightness(1.1);
    }

    .jdm-btn-primary:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(182, 156, 255, 0.2), 0 0 24px rgba(182, 156, 255, 0.6);
    }

    /* Glow on Inputs */
    .jdm-input:focus,
    .jdm-textarea:focus {
      box-shadow: 0 0 0 3px rgba(182, 156, 255, 0.15), 0 0 16px rgba(182, 156, 255, 0.3);
    }

    /* Glow on Template Cards */
    .jdm-template-card.selected {
      border-color: var(--accentA) !important;
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.5), 0 4px 16px rgba(182, 156, 255, 0.3);
      animation: cardSelectPulse 0.6s ease-out;
    }

    @keyframes cardSelectPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 rgba(182, 156, 255, 0); }
      50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(182, 156, 255, 0.7); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(182, 156, 255, 0.5); }
    }

    /* Glow on Workspace Sections */
    .jdm-workspace-section:focus-within {
      border-color: rgba(182, 156, 255, 0.5);
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.2), 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* ========================================
       DRAG & DROP UPLOAD
       ======================================== */
    
    .jdm-upload-zone {
      border: 2px dashed rgba(182, 156, 255, 0.3);
      border-radius: 12px;
      padding: 32px 20px;
      text-align: center;
      background: rgba(182, 156, 255, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .jdm-upload-zone:hover {
      border-color: rgba(182, 156, 255, 0.5);
      background: rgba(182, 156, 255, 0.1);
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.2);
    }

    .jdm-upload-zone.dragover {
      border-color: var(--accentA);
      background: rgba(182, 156, 255, 0.15);
      box-shadow: 0 0 30px rgba(182, 156, 255, 0.4);
    }

    .jdm-upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .jdm-upload-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .jdm-upload-hint {
      font-size: 12px;
      color: var(--muted2);
    }

    /* File Preview Card */
    .jdm-file-card {
      background: rgba(182, 156, 255, 0.1);
      border: 1px solid rgba(182, 156, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .jdm-file-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }

    .jdm-file-info {
      flex: 1;
    }

    .jdm-file-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .jdm-file-size {
      font-size: 11px;
      color: var(--muted2);
    }

    .jdm-file-actions {
      display: flex;
      gap: 8px;
    }

    .jdm-icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .jdm-icon-btn:hover {
      background: rgba(182, 156, 255, 0.15);
      border-color: var(--accentA);
      color: var(--accentA);
    }

    .jdm-icon-btn.danger:hover {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
      color: #ef4444;
    }

    /* File Status Indicator */
    .jdm-file-status {
      padding: 10px 14px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      font-size: 12px;
      color: #22c55e;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: fadeIn 0.3s ease;
    }

    .jdm-file-status.loading {
      background: rgba(251, 191, 36, 0.1);
      border-color: rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Resume Input Toggle */
    .jdm-input-toggle {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px;
      margin-bottom: 16px;
    }

    .jdm-toggle-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--muted2);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .jdm-toggle-btn.active {
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      color: white;
      box-shadow: 0 2px 8px rgba(182, 156, 255, 0.3);
    }

    .jdm-toggle-btn:hover:not(.active) {
      background: rgba(182, 156, 255, 0.1);
      color: var(--accentA);
    }

    /* ========================================
       MATCH INTELLIGENCE CONTROLS
       ======================================== */
    
    /* ATS Strictness Slider */
    .jdm-strictness-control {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .jdm-strictness-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 0 4px;
    }

    .jdm-strictness-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .jdm-strictness-value {
      padding: 4px 12px;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: white;
      box-shadow: 0 2px 8px rgba(182, 156, 255, 0.3);
    }

    .jdm-slider-container {
      position: relative;
      padding: 8px 0;
    }

    .jdm-slider-enhanced {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, 
        rgba(239, 68, 68, 0.2) 0%,
        rgba(251, 191, 36, 0.2) 50%,
        rgba(34, 197, 94, 0.2) 100%);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .jdm-slider-enhanced::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(182, 156, 255, 0.4), 0 0 0 4px rgba(182, 156, 255, 0.1);
      transition: all 0.2s ease;
    }

    .jdm-slider-enhanced::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.6), 0 4px 12px rgba(182, 156, 255, 0.4);
    }

    .jdm-slider-enhanced::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(182, 156, 255, 0.4), 0 0 0 4px rgba(182, 156, 255, 0.1);
      transition: all 0.2s ease;
    }

    .jdm-slider-enhanced::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.6), 0 4px 12px rgba(182, 156, 255, 0.4);
    }

    .jdm-slider-marks {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 10px;
      color: var(--muted2);
    }

    /* Skill Frequency Stepper */
    .jdm-skills-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .jdm-skill-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .jdm-skill-row:hover {
      background: rgba(182, 156, 255, 0.08);
      border-color: rgba(182, 156, 255, 0.3);
    }

    .jdm-skill-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }

    .jdm-skill-stepper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .jdm-stepper-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      transition: all 0.2s ease;
    }

    .jdm-stepper-btn:hover {
      background: rgba(182, 156, 255, 0.15);
      border-color: var(--accentA);
      color: var(--accentA);
      box-shadow: 0 0 12px rgba(182, 156, 255, 0.3);
    }

    .jdm-stepper-value {
      min-width: 32px;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--accentA);
    }

    .jdm-skill-remove {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      background: rgba(239, 68, 68, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #ef4444;
      transition: all 0.2s ease;
    }

    .jdm-skill-remove:hover {
      background: rgba(239, 68, 68, 0.2);
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
    }

    /* ========================================
       PHASED GENERATION PROGRESS
       ======================================== */
    
    .jdm-progress-overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 6, 10, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .jdm-progress-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .jdm-progress-container {
      max-width: 500px;
      width: 90%;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .jdm-progress-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 24px;
    }

    .jdm-progress-phases {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .jdm-progress-phase {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      opacity: 0.3;
      transition: all 0.4s ease;
    }

    .jdm-progress-phase.active {
      opacity: 1;
      border-color: var(--accentA);
      background: rgba(182, 156, 255, 0.1);
      box-shadow: 0 0 20px rgba(182, 156, 255, 0.3);
    }

    .jdm-progress-phase.completed {
      opacity: 1;
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .jdm-progress-phase-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .jdm-progress-phase.active .jdm-progress-phase-icon {
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      color: white;
      animation: spin 1s linear infinite;
    }

    .jdm-progress-phase.completed .jdm-progress-phase-icon {
      background: #22c55e;
      color: white;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .jdm-progress-phase-text {
      flex: 1;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .jdm-progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      overflow: hidden;
    }

    .jdm-progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      border-radius: 4px;
      transition: width 0.4s ease;
      box-shadow: 0 0 12px rgba(182, 156, 255, 0.5);
    }

    .jdm-progress-percentage {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 700;
      color: var(--accentA);
    }

    /* ========================================
       TEMPLATE DRAWER
       ======================================== */
    
    .jdm-drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 900;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .jdm-drawer-overlay.active {
      display: block;
    }

    .jdm-drawer {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 500px;
      max-width: 90vw;
      background: var(--bg1);
      border-left: 1px solid var(--border);
      box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
      z-index: 950;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .jdm-drawer.active {
      transform: translateX(0);
    }

    .jdm-drawer-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .jdm-drawer-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .jdm-drawer-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--muted2);
      transition: all 0.2s ease;
    }

    .jdm-drawer-close:hover {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
      color: #ef4444;
    }

    .jdm-drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .jdm-drawer-preview {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: white;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .jdm-drawer-actions {
      padding: 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    /* TEMPLATES SECTION */
    .jdm-templates-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .jdm-search-box,
    .jdm-sort-select {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
    }

    .jdm-search-box {
      flex: 1;
    }

    .jdm-sort-select {
      cursor: pointer;
    }

    .jdm-templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }

    /* TEMPLATE CARD - FIX FOR BLANK PREVIEWS */
    .jdm-template-card {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .jdm-template-card:hover {
      border-color: rgba(182, 156, 255, 0.4);
      background: rgba(182, 156, 255, 0.05);
      transform: translateY(-2px);
    }

    .jdm-template-card.selected {
      border-color: var(--accentA);
      background: rgba(182, 156, 255, 0.1);
    }

    /* TEMPLATE PREVIEW - Now with image or fallback */
    .jdm-template-preview {
      width: 100%;
      height: 120px;
      background: linear-gradient(135deg, rgba(182, 156, 255, 0.1) 0%, rgba(109, 169, 255, 0.08) 100%);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted2);
      font-size: 11px;
      position: relative;
      overflow: hidden;
    }

    .jdm-template-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .jdm-template-preview.loading::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: skeletonShimmer 1.5s infinite;
    }

    @keyframes skeletonShimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .jdm-template-preview.error {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .tpl-thumb-fallback { width:100%; height:120px; border-radius:8px; border:1px solid rgba(255,255,255,.10); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); position:relative; overflow:hidden; box-sizing:border-box; }
    .tpl-thumb-fallback.fill { height:260px; min-height:100%; width:100%; border-radius:6px; }
    #selectedTemplatePreview { min-height: 260px; height: 260px; display: block; width: 100%; position: relative; overflow: hidden; border-radius: 8px; }
    .tpl-thumb-lines { padding:14px; display:flex; flex-direction:column; gap:8px; opacity:.85; }
    .tpl-thumb-lines .line { display:block; height:8px; border-radius:999px; background: rgba(255,255,255,.10); }
    .tpl-thumb-lines .w-90 { width:90%; } .tpl-thumb-lines .w-80 { width:80%; } .tpl-thumb-lines .w-70 { width:70%; } .tpl-thumb-lines .w-60 { width:60%; } .tpl-thumb-lines .w-50 { width:50%; }
    .tpl-thumb-tag { position:absolute; right:10px; bottom:10px; font-size:11px; padding:4px 8px; border-radius:999px; background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.10); color: rgba(255,255,255,.85); white-space:nowrap; max-width:80%; overflow:hidden; text-overflow:ellipsis; z-index:2; }

    .jdm-template-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      font-size: 12px;
    }

    .jdm-template-tag {
      display: inline-block;
      font-size: 10px;
      color: var(--muted2);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 3px;
      margin-bottom: 8px;
    }

    .jdm-template-select-btn {
      width: 100%;
      padding: 8px;
      background: rgba(182, 156, 255, 0.15);
      border: 1px solid rgba(182, 156, 255, 0.3);
      border-radius: 6px;
      color: var(--accentA);
      font-weight: 600;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-template-select-btn:hover {
      background: rgba(182, 156, 255, 0.25);
    }

    .jdm-template-card.selected .jdm-template-select-btn {
      background: rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
      color: #22c55e;
    }

    .jdm-template-checkmark {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: #22c55e;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .jdm-template-card.selected .jdm-template-checkmark {
      display: flex;
    }

    /* HISTORY SECTION */
    .jdm-history-empty {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .jdm-history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .jdm-history-item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .jdm-history-item:hover {
      border-color: rgba(182, 156, 255, 0.4);
      background: rgba(182, 156, 255, 0.08);
    }

    .jdm-history-header {
      padding: 12px 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .jdm-history-title {
      font-weight: 600;
      color: var(--text);
      font-size: 13px;
    }

    .jdm-history-meta {
      font-size: 11px;
      color: var(--muted2);
      margin-top: 2px;
    }

    .jdm-history-expand-icon {
      color: var(--accentA);
      font-size: 18px;
      transition: transform 0.2s ease;
    }

    .jdm-history-item.expanded .jdm-history-expand-icon {
      transform: rotate(180deg);
    }

    .jdm-history-content {
      display: none;
      padding: 0 14px 14px;
      border-top: 1px solid var(--border);
    }

    .jdm-history-item.expanded .jdm-history-content {
      display: block;
    }

    .jdm-history-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
      font-size: 11px;
    }

    .jdm-history-metric {
      background: rgba(182, 156, 255, 0.1);
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(182, 156, 255, 0.2);
    }

    .jdm-history-metric-label {
      color: var(--muted2);
      display: block;
      margin-bottom: 2px;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.5px;
    }

    .jdm-history-metric-value {
      color: var(--accentA);
      font-weight: 700;
      font-size: 14px;
    }

    .jdm-history-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .jdm-action-btn {
      flex: 1;
      min-width: 60px;
      padding: 6px 8px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .jdm-action-btn.view {
      background: rgba(182, 156, 255, 0.15);
      color: var(--accentA);
      border: 1px solid rgba(182, 156, 255, 0.3);
    }

    .jdm-action-btn.view:hover {
      background: rgba(182, 156, 255, 0.25);
      transform: scale(1.02);
    }

    .jdm-action-btn.download {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .jdm-action-btn.download:hover {
      background: rgba(34, 197, 94, 0.25);
      transform: scale(1.02);
    }

    .jdm-action-btn.delete {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .jdm-action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.25);
      transform: scale(1.02);
    }

    /* SETTINGS */
    .jdm-settings-item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 16px;
    }

    .jdm-settings-item-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      font-size: 13px;
    }

    .jdm-settings-item-text {
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .jdm-btn-danger {
      padding: 10px 12px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: #ef4444;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-btn-danger:hover {
      background: rgba(239, 68, 68, 0.25);
      transform: scale(1.02);
    }

    /* RESULTS SECTION */
    .jdm-results {
      display: none;
      animation: fadeInUp 0.3s ease;
    }

    .jdm-results.active {
      display: block;
    }

    .jdm-metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .jdm-metric-card {
      background: rgba(182, 156, 255, 0.1);
      border: 1px solid rgba(182, 156, 255, 0.2);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .jdm-metric-card:hover {
      border-color: rgba(182, 156, 255, 0.4);
      background: rgba(182, 156, 255, 0.15);
      transform: translateY(-2px);
    }

    .jdm-metric-label {
      font-size: 11px;
      color: var(--muted2);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .jdm-metric-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accentA);
    }

    .jdm-preview-btn {
      width: 100%;
      padding: 12px;
      background: rgba(182, 156, 255, 0.15);
      border: 1px solid rgba(182, 156, 255, 0.3);
      border-radius: 12px;
      color: var(--accentA);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .jdm-preview-btn:hover {
      background: rgba(182, 156, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(182, 156, 255, 0.3);
    }

    .jdm-download-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .jdm-download-btn {
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-download-btn.pdf {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .jdm-download-btn.pdf:hover {
      background: rgba(239, 68, 68, 0.25);
      transform: scale(1.02);
    }

    .jdm-download-btn.doc {
      background: rgba(109, 169, 255, 0.15);
      color: var(--accentB);
      border: 1px solid rgba(109, 169, 255, 0.3);
    }

    .jdm-download-btn.doc:hover {
      background: rgba(109, 169, 255, 0.25);
      transform: scale(1.02);
    }

    .jdm-download-btn.html {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .jdm-download-btn.html:hover {
      background: rgba(34, 197, 94, 0.25);
      transform: scale(1.02);
    }

    /* TOAST */
    .jdm-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 14px 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      z-index: 9999;
      animation: slideInRight 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      max-width: 350px;
    }

    .jdm-toast.success {
      border-color: rgba(34, 197, 94, 0.3);
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .jdm-toast.error {
      border-color: rgba(239, 68, 68, 0.3);
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .jdm-toast.info {
      border-color: rgba(182, 156, 255, 0.3);
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      color: white;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ========================================
       KEYWORD GAP PANEL
       ======================================== */
    .jdm-gap-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .jdm-gap-tag {
      padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .jdm-gap-tag.missing {
      background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35); color: #f87171;
    }
    .jdm-gap-tag.missing:hover { background: rgba(239,68,68,0.25); }
    .jdm-gap-tag.present {
      background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.35); color: #4ade80;
    }
    .jdm-gap-tag.inject {
      background: rgba(182,156,255,0.12); border: 1px dashed rgba(182,156,255,0.4); color: var(--accentA);
    }
    .jdm-gap-tag.inject:hover { background: rgba(182,156,255,0.22); }
    .jdm-gap-score-bar {
      height: 6px; border-radius: 3px;
      background: linear-gradient(90deg, #f87171, #fbbf24, #4ade80);
      margin: 8px 0 4px;
    }
    .jdm-gap-score-fill {
      height: 6px; border-radius: 3px;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      transition: width 0.6s ease;
    }

    /* ========================================
       TONE CONTROL
       ======================================== */
    .jdm-tone-options { display: flex; gap: 8px; margin-top: 8px; }
    .jdm-tone-btn {
      flex: 1; padding: 8px 4px; border-radius: 8px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03); color: var(--muted2); font-size: 11px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .jdm-tone-btn.active {
      border-color: var(--accentA); background: rgba(182,156,255,0.12); color: var(--accentA);
    }
    .jdm-tone-btn:hover { border-color: rgba(182,156,255,0.4); color: var(--text); }

    /* ========================================
       COVER LETTER GENERATOR
       ======================================== */
    .jdm-cover-output {
      display: none; margin-top: 12px; padding: 14px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 10px; font-size: 12px; color: var(--text); line-height: 1.7;
      max-height: 300px; overflow-y: auto; white-space: pre-wrap;
    }
    .jdm-cover-output.active { display: block; }

    /* ========================================
       JOB TRACKER
       ======================================== */
    .jdm-tracker-item {
      padding: 12px; border: 1px solid var(--border); border-radius: 10px;
      margin-bottom: 8px; background: rgba(255,255,255,0.02);
      display: flex; justify-content: space-between; align-items: center;
    }
    .jdm-tracker-company { font-size: 13px; font-weight: 600; color: var(--text); }
    .jdm-tracker-role { font-size: 11px; color: var(--muted2); margin-top: 2px; }
    .jdm-status-badge {
      padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .jdm-status-badge.applied { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3); }
    .jdm-status-badge.interview { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
    .jdm-status-badge.offer { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); }
    .jdm-status-badge.rejected { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
    .jdm-tracker-empty { text-align: center; padding: 20px; color: var(--muted2); font-size: 12px; }
    .jdm-tracker-form {
      padding: 12px; background: rgba(182,156,255,0.05);
      border: 1px dashed rgba(182,156,255,0.3); border-radius: 10px; margin-bottom: 12px;
      display: none;
    }
    .jdm-tracker-form.active { display: block; }

    /* ========================================
       DIFF VIEW
       ======================================== */
    .jdm-diff-container {
      display: none; margin-top: 12px;
      border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
    }
    .jdm-diff-container.active { display: block; }
    .jdm-diff-header {
      display: grid; grid-template-columns: 1fr 1fr;
      background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border);
    }
    .jdm-diff-header > div {
      padding: 8px 12px; font-size: 11px; font-weight: 700; color: var(--muted2);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .jdm-diff-body {
      display: grid; grid-template-columns: 1fr 1fr;
      max-height: 300px; overflow-y: auto;
    }
    .jdm-diff-side {
      padding: 12px; font-size: 11px; line-height: 1.7; color: var(--text);
      border-right: 1px solid var(--border); white-space: pre-wrap; word-break: break-word;
    }
    .jdm-diff-side:last-child { border-right: none; }
    .diff-added { background: rgba(34,197,94,0.12); color: #4ade80; }
    .diff-removed { background: rgba(239,68,68,0.12); color: #f87171; text-decoration: line-through; }

    /* ========================================
       BLACKLIST
       ======================================== */
    .jdm-blacklist-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; min-height: 32px; }
    .jdm-blacklist-tag {
      padding: 4px 10px; border-radius: 20px;
      background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
      color: #f87171; font-size: 11px; font-weight: 600;
      display: flex; align-items: center; gap: 6px; cursor: default;
    }
    .jdm-blacklist-tag span { cursor: pointer; opacity: 0.7; }
    .jdm-blacklist-tag span:hover { opacity: 1; }

    /* ========================================
       AUTO-SAVE INDICATOR
       ======================================== */
    .jdm-autosave-indicator {
      position: fixed; bottom: 20px; left: 20px;
      padding: 6px 14px; border-radius: 20px;
      background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3);
      color: #4ade80; font-size: 11px; font-weight: 600;
      opacity: 0; transition: opacity 0.3s; z-index: 1000; pointer-events: none;
    }
    .jdm-autosave-indicator.show { opacity: 1; }

    /* ========================================
       KEYBOARD SHORTCUTS
       ======================================== */
    .jdm-shortcuts-modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.7); z-index: 9999;
      align-items: center; justify-content: center;
    }
    .jdm-shortcuts-modal.active { display: flex; }
    .jdm-shortcuts-box {
      background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
      padding: 28px; min-width: 320px; max-width: 400px;
    }
    .jdm-shortcuts-title {
      font-size: 16px; font-weight: 700; color: var(--text);
      margin-bottom: 20px; display: flex; justify-content: space-between;
    }
    .jdm-shortcut-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 13px; color: var(--muted);
    }
    .jdm-shortcut-key {
      padding: 3px 8px; border-radius: 6px;
      background: rgba(255,255,255,0.08); border: 1px solid var(--border);
      font-size: 11px; font-weight: 700; color: var(--text); font-family: monospace;
    }

    /* ========================================
       RESUME EDITOR
       ======================================== */
    
    .jdm-editor {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .jdm-editor.active {
      display: block;
    }

    .jdm-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .jdm-editor-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
    }

    .jdm-editor-section {
      margin-bottom: 24px;
    }

    .jdm-editor-section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--accentA);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .jdm-editor-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .jdm-editor-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .jdm-editor-add-btn {
      width: 100%;
      padding: 10px;
      background: rgba(182, 156, 255, 0.1);
      border: 1px dashed rgba(182, 156, 255, 0.3);
      border-radius: 8px;
      color: var(--accentA);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jdm-editor-add-btn:hover {
      background: rgba(182, 156, 255, 0.15);
      border-style: solid;
    }

    .jdm-editor-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .jdm-header {
        padding: 12px 20px;
      }

      .jdm-main {
        padding: 20px;
      }

      .jdm-templates-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }

      .jdm-metrics-grid {
        grid-template-columns: 1fr;
      }

      .jdm-download-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="jdm-wrapper">
    <!-- HEADER -->
    <div class="jdm-header">
      <button class="jdm-back-btn" onclick="goBack()">&#8592; Back to Portal</button>
      <h1 class="jdm-title">JD Match Resume Generator</h1>
      <button class="jdm-back-btn" onclick="openShortcuts()" title="Keyboard Shortcuts" style="font-size:16px;">&#x2328;&#xfe0f; Shortcuts</button>
      <button class="jdm-back-btn" onclick="openHowItWorks()" title="How it works" style="font-size:16px;">&#x2753; How it works</button>
    </div>

    <!-- HERO SECTION -->
    <div class="jdm-hero">
      <h2 class="jdm-hero-title">Transform Your Resume to Match Any Job</h2>
      <p class="jdm-hero-subtitle">Intelligent workspace for creating ATS-optimized, job-matched resumes with data-driven insights</p>
    </div>

    <!-- STEP WIZARD -->
    <div class="jdm-wizard">
      <div class="jdm-wizard-container">
        <div class="jdm-wizard-steps">
          <div class="jdm-wizard-step active" data-step="1" onclick="goToStep(1)">
            <div class="jdm-wizard-step-circle">1</div>
            <div class="jdm-wizard-step-label">Base Resume</div>
            <div class="jdm-wizard-step-sublabel">Upload your resume</div>
          </div>
          <div class="jdm-wizard-step" data-step="2" onclick="goToStep(2)">
            <div class="jdm-wizard-step-circle">2</div>
            <div class="jdm-wizard-step-label">Job Description</div>
            <div class="jdm-wizard-step-sublabel">Paste target JD</div>
          </div>
          <div class="jdm-wizard-step" data-step="3" onclick="goToStep(3)">
            <div class="jdm-wizard-step-circle">3</div>
            <div class="jdm-wizard-step-label">Match Controls</div>
            <div class="jdm-wizard-step-sublabel">Configure settings</div>
          </div>
          <div class="jdm-wizard-step" data-step="4" onclick="goToStep(4)">
            <div class="jdm-wizard-step-circle">4</div>
            <div class="jdm-wizard-step-label">Template</div>
            <div class="jdm-wizard-step-sublabel">Select design</div>
          </div>
          <div class="jdm-wizard-step" data-step="5" onclick="goToStep(5)">
            <div class="jdm-wizard-step-circle">5</div>
            <div class="jdm-wizard-step-label">Generate</div>
            <div class="jdm-wizard-step-sublabel">Create resume</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN WORKSPACE -->
    <div class="jdm-main">
      <div class="jdm-main-container">
        <div class="jdm-workspace">
        <!-- LEFT COLUMN: INPUT FORMS -->
        <div class="jdm-workspace-column">
          <!-- Base Resume Upload -->
          <div class="jdm-workspace-section" id="baseResumeSection">
            <h3 class="jdm-section-title">Base Resume</h3>
            
            <!-- Input Method Toggle -->
            <div class="jdm-input-toggle">
              <button class="jdm-toggle-btn active" id="uploadModeBtn" onclick="switchInputMode('upload')">Upload/Paste Resume</button>
              <button class="jdm-toggle-btn" id="adminModeBtn" onclick="switchInputMode('admin')">Use Admin-Approved Data</button>
            </div>

            <!-- Upload Mode -->
            <div id="uploadModeContainer">
              <div class="jdm-upload-zone" id="uploadZone">
                <input type="file" id="baseResumeFile" accept=".txt,.docx,.doc,.pdf" style="display: none;" onchange="handleFileUpload(event)">
                <div class="jdm-upload-icon">📄</div>
                <div class="jdm-upload-text">Drag & drop your resume here</div>
                <div class="jdm-upload-hint">or click to browse (TXT, DOCX, PDF)</div>
              </div>
              <div id="fileCardContainer"></div>
              <div id="fileStatusContainer"></div>
              <div style="margin-top: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <div style="flex: 1; height: 1px; background: var(--border);"></div>
                  <span style="color: var(--muted2); font-size: 12px; font-weight: 600;">OR PASTE TEXT</span>
                  <div style="flex: 1; height: 1px; background: var(--border);"></div>
                </div>
                <textarea id="baseResumePaste" class="jdm-textarea" placeholder="Paste your resume text here…" style="min-height: 150px;"></textarea>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                  <button type="button" class="jdm-btn-secondary" onclick="saveBaseResume()" style="flex: 1;">Save Resume</button>
                  <button type="button" class="jdm-btn-secondary" onclick="clearBaseResume()" style="flex: 1;">Clear</button>
                </div>
              </div>
            </div>

            <!-- Admin Data Mode -->
            <div id="adminModeContainer" style="display: none;">
              <div style="padding: 16px; background: rgba(109, 169, 255, 0.1); border: 1px solid rgba(109, 169, 255, 0.3); border-radius: 10px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 8px;">✔</div>
                <div style="font-size: 13px; font-weight: 600; color: var(--accentB); margin-bottom: 4px;">Using Admin-Approved Profile Data</div>
                <div style="font-size: 11px; color: var(--muted2);" id="adminDataStatus">Loading candidate details...</div>
              </div>
            </div>
          </div>

          <!-- Company & Job Description -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Job Details</h3>
            <div class="jdm-form-group">
              <label class="jdm-label">Company Name</label>
              <input type="text" id="companyName" class="jdm-input" placeholder="E.g., Stripe, Linear, Vercel" required>
            </div>
            <div class="jdm-form-group" style="margin-bottom: 0;">
              <label class="jdm-label">Job Description</label>
              <span class="jdm-hint">Paste the complete job posting for precise matching</span>
              <textarea id="jobDescription" class="jdm-textarea" placeholder="Paste full job description here…" style="min-height: 200px;" required></textarea>
            </div>
          </div>
        </div>

        <!-- CENTER COLUMN: MATCH INTELLIGENCE -->
        <div class="jdm-workspace-column">
          <!-- ATS Strictness Control -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">ATS Strictness Level</h3>
            <div class="jdm-strictness-control">
              <div class="jdm-strictness-header">
                <span class="jdm-strictness-label">Match Target</span>
                <span class="jdm-strictness-value" id="strictnessDisplay">92%</span>
              </div>
              <!-- Auto/Manual Toggle -->
              <div class="jdm-radio-group" style="margin-bottom: 12px;">
                <div class="jdm-radio-option">
                  <input type="radio" id="autoMode" name="targetMode" value="auto" checked onchange="toggleSlider()">
                  <label for="autoMode">Auto (90-95%)</label>
                </div>
                <div class="jdm-radio-option">
                  <input type="radio" id="manualMode" name="targetMode" value="manual" onchange="toggleSlider()">
                  <label for="manualMode">Manual</label>
                </div>
              </div>
              <div id="sliderGroup" class="jdm-slider-group">
                <div class="jdm-slider-wrapper">
                  <input type="range" id="targetSlider" class="jdm-slider" min="5" max="100" step="1" value="75" oninput="updateSliderValue(this.value)">
                  <input type="number" id="targetInput" class="jdm-slider-input" min="5" max="100" step="1" value="75" oninput="updateSliderValue(this.value)">
                  <div class="jdm-slider-value-display" id="sliderDisplay">92%</div>
                </div>
              </div>
              <div class="jdm-slider-container">
                <input type="range" id="strictnessSlider" class="jdm-slider-enhanced" min="70" max="100" value="92" oninput="updateStrictnessValue(this.value)" style="display:none;">
                <div class="jdm-slider-marks">
                  <span>70% Relaxed</span>
                  <span>85% Balanced</span>
                  <span>100% Strict</span>
                </div>
              </div>
              <div style="margin-top: 12px; padding: 12px; background: rgba(182, 156, 255, 0.05); border-radius: 8px; font-size: 11px; color: var(--muted2);">
                💡 Higher percentage = stricter ATS keyword matching
              </div>
            </div>
          </div>

          <!-- Skill Frequency Controller -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Skill Frequency</h3>
            <div class="jdm-form-group">
              <input type="text" id="skillInput" class="jdm-input" placeholder="Add skill (press Enter)" onkeypress="handleSkillKeypress(event)">
            </div>
            <div class="jdm-skills-list" id="skillsList">
              <!-- Skills will be dynamically added here -->
            </div>
          </div>

          <!-- Must Include Skills -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Must Include Skills</h3>
            <div class="jdm-form-group" style="margin-bottom:0;">
              <span class="jdm-hint">Comma-separated, e.g., React, Node.js, TypeScript</span>
              <input type="text" id="skillsInput" class="jdm-input" placeholder="React, Node.js, TypeScript, AWS" style="margin-top:8px;">
            </div>
          </div>

          <!-- Keyword Blacklist -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Keyword Blacklist</h3>
            <span class="jdm-hint">Words/phrases that should never appear in your resume</span>
            <div class="jdm-form-group" style="margin-top:10px;">
              <input type="text" id="blacklistInput" class="jdm-input" placeholder="Type word and press Enter" onkeypress="handleBlacklistKeypress(event)">
            </div>
            <div class="jdm-blacklist-tags" id="blacklistTags"></div>
          </div>

          <!-- Tone Control -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Rewrite Tone</h3>
            <span class="jdm-hint">How aggressively the AI rewrites your resume content</span>
            <div class="jdm-tone-options">
              <button class="jdm-tone-btn active" id="toneConservative" onclick="setTone('conservative')">🛡 Conservative<br><span style="font-size:10px;font-weight:400;">Minimal edits</span></button>
              <button class="jdm-tone-btn" id="toneBalanced" onclick="setTone('balanced')">⚡ Balanced<br><span style="font-size:10px;font-weight:400;">Smart rewrite</span></button>
              <button class="jdm-tone-btn" id="toneAggressive" onclick="setTone('aggressive')">🚀 Aggressive<br><span style="font-size:10px;font-weight:400;">Full optimize</span></button>
            </div>
            <div style="margin-top:10px;padding:10px;background:rgba(182,156,255,0.05);border-radius:8px;font-size:11px;color:var(--muted2);" id="toneDescription">Preserves your original writing style with minimal keyword additions.</div>
          </div>

          <!-- Keyword Gap Analysis -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Keyword Gap Analysis</h3>
            <span class="jdm-hint">Click a missing keyword to add it to Must Include Skills</span>
            <div id="gapAnalysisContent">
              <div style="text-align:center;padding:20px;color:var(--muted2);font-size:12px;">Paste a Job Description to see keyword gaps</div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: TEMPLATES & OUTPUT -->
        <div class="jdm-workspace-column">
          <!-- Template Selector -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Resume Template</h3>
            <div id="templateQuickView" style="cursor: pointer;" onclick="openTemplateDrawer()">
              <div style="aspect-ratio: 8.5/11; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; background: linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.01)); margin-bottom: 12px;">
                <div id="selectedTemplatePreview" style="width:100%;"></div>
              </div>
              <div style="text-align: center; padding: 12px; background: rgba(182, 156, 255, 0.1); border-radius: 8px;">
                <div style="font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 4px;" id="selectedTemplateName">Template 01</div>
                <div style="font-size: 11px; color: var(--muted2);">Click to change template</div>
              </div>
            </div>
          </div>

          <!-- Generate Button & Output -->
          <div class="jdm-workspace-section">
            <button type="button" class="jdm-btn-primary" id="generateBtn" onclick="handleGenerate()">
              <span>🚀 Generate Matched Resume</span>
            </button>
            
            <!-- Results (hidden until generated) -->
            <div id="outputSection" style="display: none; margin-top: 20px;">
              <div style="padding: 16px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 8px;">✔ Resume Generated</div>
                <div style="font-size: 11px; color: var(--muted);">Your tailored resume is ready!</div>
              </div>
              
              <div class="jdm-metrics-grid" id="metricsGrid"></div>
              
              <button class="jdm-preview-btn" onclick="previewResume()">📄 Preview Resume</button>
              
              <div class="jdm-download-group">
                <button class="jdm-download-btn pdf" onclick="downloadPDF()">PDF</button>
                <button class="jdm-download-btn doc" onclick="downloadDOC()">DOC</button>
                <button class="jdm-download-btn html" onclick="downloadHTML()">HTML</button>
              </div>
              
              <button class="jdm-btn-secondary" onclick="saveToHistory()" style="width: 100%; margin-top: 12px;">Save to History</button>

              <!-- Resume Editor Button -->
              <button class="jdm-btn-secondary" onclick="toggleEditor()" id="editorToggleBtn" style="width: 100%; margin-top: 8px;">✅ Edit Resume Content</button>
            </div>

            <!-- Resume Editor (hidden initially) -->
            <div id="resumeEditor" class="jdm-editor">
              <div class="jdm-editor-header">
                <span class="jdm-editor-title">Edit Resume Content</span>
                <button class="jdm-icon-btn" onclick="toggleEditor()">✕</button>
              </div>

              <!-- Summary Section -->
              <div class="jdm-editor-section">
                <div class="jdm-editor-section-title">Professional Summary</div>
                <textarea id="editorSummary" class="jdm-textarea" placeholder="Edit professional summary..." style="min-height: 100px;"></textarea>
              </div>

              <!-- Skills Section -->
              <div class="jdm-editor-section">
                <div class="jdm-editor-section-title">Skills</div>
                <textarea id="editorSkills" class="jdm-textarea" placeholder="Edit skills (comma-separated)..." style="min-height: 80px;"></textarea>
              </div>

              <!-- Employment Section -->
              <div class="jdm-editor-section">
                <div class="jdm-editor-section-title">Employment History</div>
                <div id="employmentContainer"></div>
                <button class="jdm-editor-add-btn" onclick="addEmploymentEntry()">+ Add Employment</button>
              </div>

              <!-- Education Section -->
              <div class="jdm-editor-section">
                <div class="jdm-editor-section-title">Education</div>
                <div id="educationContainer"></div>
                <button class="jdm-editor-add-btn" onclick="addEducationEntry()">+ Add Education</button>
              </div>

              <!-- Actions -->
              <div class="jdm-editor-actions">
                <button class="jdm-btn-primary" onclick="saveDraft()" style="flex: 1;">💾 Save Draft</button>
                <button class="jdm-btn-secondary" onclick="regenerateResume()" style="flex: 1;">🔄 Regenerate</button>
              </div>
            </div>
          </div>

          <!-- Quick Access Tabs (History & Settings) -->
          <div class="jdm-workspace-section">
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
              <button class="jdm-btn-secondary" onclick="toggleQuickPanel('history')" style="flex: 1;">📋 History</button>
              <button class="jdm-btn-secondary" onclick="toggleQuickPanel('settings')" style="flex: 1;">⚙️ Settings</button>
            </div>
            <div id="historyQuickPanel" style="display: none;"></div>
            <div id="settingsQuickPanel" style="display: none;"></div>
          </div>

          <!-- Cover Letter Generator -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Cover Letter Generator</h3>
            <span class="jdm-hint">Auto-generate a cover letter from your resume + JD</span>
            <div class="jdm-form-group" style="margin-top:10px;">
              <label class="jdm-label">Tone</label>
              <select id="coverTone" class="jdm-input jdm-select-dark">
                <option value="professional">Professional</option>
                <option value="enthusiastic">Enthusiastic</option>
                <option value="concise">Concise</option>
              </select>
            </div>
            <button class="jdm-btn-secondary" onclick="generateCoverLetter()" style="width:100%;margin-top:8px;">✉️ Generate Cover Letter</button>
            <div class="jdm-cover-output" id="coverLetterOutput"></div>
            <div id="coverLetterActions" style="display:none;margin-top:8px;display:none;gap:8px;">
              <button class="jdm-btn-secondary" onclick="copyCoverLetter()" style="flex:1;">📋 Copy</button>
              <button class="jdm-btn-secondary" onclick="downloadCoverLetter()" style="flex:1;">⬇️ Download</button>
            </div>
          </div>

          <!-- Before vs After Diff View -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Before vs After</h3>
            <span class="jdm-hint">Compare original resume with generated version</span>
            <button class="jdm-btn-secondary" onclick="toggleDiffView()" style="width:100%;margin-top:10px;" id="diffToggleBtn">🔄 Show Diff View</button>
            <div class="jdm-diff-container" id="diffContainer">
              <div class="jdm-diff-header">
                <div>📄 Original</div>
                <div>✨ Generated</div>
              </div>
              <div class="jdm-diff-body">
                <div class="jdm-diff-side" id="diffOriginal">Upload a resume and generate to see comparison</div>
                <div class="jdm-diff-side" id="diffGenerated">Generated content will appear here</div>
              </div>
            </div>
          </div>

          <!-- Job Tracker -->
          <div class="jdm-workspace-section">
            <h3 class="jdm-section-title">Job Tracker</h3>
            <button class="jdm-btn-secondary" onclick="toggleTrackerForm()" style="width:100%;margin-bottom:10px;">+ Add Job Application</button>
            <div class="jdm-tracker-form" id="trackerForm">
              <div class="jdm-form-group">
                <input type="text" id="trackerCompany" class="jdm-input" placeholder="Company Name" style="margin-bottom:8px;">
                <input type="text" id="trackerRole" class="jdm-input" placeholder="Job Title / Role" style="margin-bottom:8px;">
                <select id="trackerStatus" class="jdm-input" style="margin-bottom:8px;">
                  <option value="applied">Applied</option>
                  <option value="interview">Interview</option>
                  <option value="offer">Offer</option>
                  <option value="rejected">Rejected</option>
                </select>
                <div style="display:flex;gap:8px;">
                  <button class="jdm-btn-primary" onclick="addTrackerEntry()" style="flex:1;">Save</button>
                  <button class="jdm-btn-secondary" onclick="toggleTrackerForm()" style="flex:1;">Cancel</button>
                </div>
              </div>
            </div>
            <div id="trackerList"></div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- OLD PANELS (Hidden - for backward compatibility) -->
    <div style="display: none;">
      <div id="generate" class="jdm-panel active"></div>
      <div id="templates" class="jdm-panel"></div>
      <div id="history" class="jdm-panel"></div>
      <div id="settings" class="jdm-panel"></div>
    </div>

    <!-- AUTO-SAVE INDICATOR -->
    <div class="jdm-autosave-indicator" id="autosaveIndicator">✓ Auto-saved</div>

    <!-- KEYBOARD SHORTCUTS MODAL -->
    <div class="jdm-shortcuts-modal" id="shortcutsModal" onclick="if(event.target===this)closeShortcuts()">
      <div class="jdm-shortcuts-box">
        <div class="jdm-shortcuts-title">
          <span>⌨️ Keyboard Shortcuts</span>
          <button onclick="closeShortcuts()" style="background:none;border:none;color:var(--muted2);cursor:pointer;font-size:18px;">&#x2715;</button>
        </div>
        <div class="jdm-shortcut-row"><span>Generate Resume</span><kbd class="jdm-shortcut-key">Ctrl + G</kbd></div>
        <div class="jdm-shortcut-row"><span>Save Draft</span><kbd class="jdm-shortcut-key">Ctrl + S</kbd></div>
        <div class="jdm-shortcut-row"><span>Clear All Fields</span><kbd class="jdm-shortcut-key">Ctrl + Shift + X</kbd></div>
        <div class="jdm-shortcut-row"><span>Open Template Picker</span><kbd class="jdm-shortcut-key">Ctrl + T</kbd></div>
        <div class="jdm-shortcut-row"><span>Show This Help</span><kbd class="jdm-shortcut-key">?</kbd></div>
        <div class="jdm-shortcut-row"><span>Preview Resume</span><kbd class="jdm-shortcut-key">Ctrl + P</kbd></div>
      </div>
    </div>

    <!-- HOW IT WORKS MODAL -->
    <div class="jdm-shortcuts-modal" id="howItWorksModal" onclick="if(event.target===this)closeHowItWorks()">
      <div class="jdm-shortcuts-box" style="max-width:660px;max-height:85vh;overflow-y:auto;">
        <div class="jdm-shortcuts-title">
          <span>&#x2753; How it works</span>
          <button onclick="closeHowItWorks()" style="background:none;border:none;color:var(--muted2);cursor:pointer;font-size:18px;">&#x2715;</button>
        </div>

        <div style="display:flex;flex-direction:column;gap:16px;padding-top:4px;">

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F4C4; Base Resume — Upload OR Paste</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Add your existing resume either by uploading a <strong>TXT, DOCX, or PDF</strong> file, or by pasting plain text. Both options produce the same result — the AI uses whichever text is available. <em>Example: drag a PDF from your desktop and the text is auto-extracted.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x2714; Admin-Approved Data Mode</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Switch to <em>Use Admin-Approved Data</em> to generate a resume using the profile data pre-loaded by your recruiter or admin — no upload needed. The data badge shows when it is ready.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F3AF; ATS Strictness — Auto vs Manual</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;"><strong>Auto</strong> targets 90–95% keyword match automatically. <strong>Manual</strong> lets you pick any value from 5–100% using the slider. Higher values force more keyword alignment; lower values allow more creative rewrites. <em>Example: set 80% for a creative role, 95% for a corporate role.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F522; Skill Frequency</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Add a skill and use the <strong>+/−</strong> stepper to set how many times it should appear in the resume. The AI tries to weave the skill naturally at that frequency. <em>Example: set React ×3 to ensure it appears in summary, skills, and experience.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x2705; Must Include Skills</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Enter comma-separated skills that must be present in the generated resume, regardless of the base resume. <em>Example: <code>TypeScript, AWS, Agile</code> ensures these appear even if your original resume omits them.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F6AB; Keyword Blacklist</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Type a word and press <kbd style="background:rgba(255,255,255,0.1);padding:1px 5px;border-radius:4px;">Enter</kbd> to add it to the blacklist. The AI will never include blacklisted words. <em>Example: blacklist <code>junior</code> or <code>intern</code> to avoid those labels.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F5E3; Rewrite Tone</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;"><strong>Conservative</strong> keeps your original language with minimal edits. <strong>Balanced</strong> smartly rewrites bullet points for impact. <strong>Aggressive</strong> fully restructures the content for maximum ATS score. <em>Choose Conservative for niche roles where originality matters.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F50D; Keyword Gap Analysis</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">After you paste a job description, click <em>Analyze Gaps</em> to see which JD keywords are <span style="color:#ef4444;">missing</span> from your resume (red) and which are already <span style="color:#22c55e;">present</span> (green). <strong>Click any red keyword</strong> to add it to Must Include Skills instantly.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F5BC; Template Picker</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Click the template thumbnail to open the template drawer with 12 designs. Each template applies a different visual layout to the same resume content. <em>Tip: choose a clean single-column template for ATS-heavy applicant tracking systems.</em></div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F680; Generate + Metrics</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Click <strong>Generate Matched Resume</strong> to produce the AI-tailored version. After generation, four key metrics appear: <em>JD Match</em> (how well keywords align), <em>ATS Score</em> (machine readability), <em>Keyword Coverage</em>, and <em>Clarity Score</em>. A JD Match above 85% is generally strong.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x270F; Resume Editor</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">After generating, click <strong>Edit Resume Content</strong> to adjust the Summary, Skills, Employment, and Education sections manually. Hit <em>Regenerate</em> to re-run generation with your edits applied.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x2709; Cover Letter Generator</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Pick a tone (Professional / Enthusiastic / Concise) and click Generate to produce a matching cover letter based on your resume and the job description. Copy or download the result from the action buttons below.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F504; Before vs After Diff</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Click <em>Show Diff View</em> to see a side-by-side comparison of your original resume (left) and the generated version (right). Useful to verify what the AI changed and ensure nothing important was removed.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F4CB; Job Tracker</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">Click <strong>+ Add Job Application</strong> to log each position you apply to with company name, role, and status (Applied / Interview / Offer / Rejected). Entries are stored in your browser and persist across sessions.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x1F4BE; Auto-Save Window</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">All fields are auto-saved to your browser every 1.5 seconds as you type. If you refresh or close the tab, your data is restored automatically within a 1-hour session window. An <em>✓ Auto-saved</em> indicator appears at the bottom-left when data is saved.</div>
          </div>

          <div style="background:rgba(182,156,255,0.07);border-radius:10px;padding:14px 16px;">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">&#x2328; Keyboard Shortcuts Reference</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;margin-top:6px;">
                <span>Generate Resume</span><kbd style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;font-size:11px;">Ctrl + G</kbd>
                <span>Save Draft</span><kbd style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;font-size:11px;">Ctrl + S</kbd>
                <span>Open Template</span><kbd style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;font-size:11px;">Ctrl + T</kbd>
                <span>Preview Resume</span><kbd style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;font-size:11px;">Ctrl + P</kbd>
                <span>Clear All Fields</span><kbd style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;font-size:11px;">Ctrl+Shift+X</kbd>
                <span>Show Shortcuts</span><kbd style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;font-size:11px;">?</kbd>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- PHASED PROGRESS OVERLAY -->
    <div class="jdm-progress-overlay" id="progressOverlay">
      <div class="jdm-progress-container">
        <div class="jdm-progress-title">Generating Your Resume</div>
        <div class="jdm-progress-phases">
          <div class="jdm-progress-phase" data-phase="1">
            <div class="jdm-progress-phase-icon">📄</div>
            <div class="jdm-progress-phase-text">Parsing Base Resume</div>
          </div>
          <div class="jdm-progress-phase" data-phase="2">
            <div class="jdm-progress-phase-icon">🎯</div>
            <div class="jdm-progress-phase-text">Understanding Job Description</div>
          </div>
          <div class="jdm-progress-phase" data-phase="3">
            <div class="jdm-progress-phase-icon">🔍</div>
            <div class="jdm-progress-phase-text">Optimizing Keywords</div>
          </div>
          <div class="jdm-progress-phase" data-phase="4">
            <div class="jdm-progress-phase-icon">⚡</div>
            <div class="jdm-progress-phase-text">ATS Structuring</div>
          </div>
          <div class="jdm-progress-phase" data-phase="5">
            <div class="jdm-progress-phase-icon">✅</div>
            <div class="jdm-progress-phase-text">Finalizing</div>
          </div>
        </div>
        <div class="jdm-progress-bar">
          <div class="jdm-progress-bar-fill" id="progressBar" style="width: 0%;"></div>
        </div>
        <div class="jdm-progress-percentage" id="progressPercentage">0%</div>
      </div>
    </div>

    <!-- TEMPLATE DRAWER -->
    <div class="jdm-drawer-overlay" id="drawerOverlay" onclick="closeTemplateDrawer()"></div>
    <div class="jdm-drawer" id="templateDrawer">
      <div class="jdm-drawer-header">
        <div class="jdm-drawer-title">Choose Template</div>
        <button class="jdm-drawer-close" onclick="closeTemplateDrawer()">×</button>
      </div>
      <div class="jdm-drawer-content">
        <div class="jdm-templates-controls">
          <input type="text" id="templateSearch" class="jdm-search-box" placeholder="Search templates…" oninput="filterTemplates()">
          <select id="templateSort" class="jdm-sort-select" onchange="filterTemplates()">
            <option value="default">All Styles</option>
            <option value="modern">Modern</option>
            <option value="clean">Clean</option>
            <option value="professional">Professional</option>
            <option value="classic">Classic</option>
          </select>
        </div>
        <div class="jdm-templates-grid" id="templatesGrid"></div>
      </div>
      <div class="jdm-drawer-actions">
        <button class="jdm-btn-secondary" onclick="closeTemplateDrawer()" style="flex: 1;">Cancel</button>
        <button class="jdm-btn-primary" onclick="confirmTemplateSelection()" style="flex: 2;">Select Template</button>
      </div>
    </div>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer"></div>

  <!-- PREVIEW MODAL (Hidden until needed) -->
  <div id="previewModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; padding: 20px;">
    <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 8px; max-width: 900px; margin: auto; height: 100%; display: flex; flex-direction: column; padding: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="color: #e2e8f0; margin: 0; font-size: 18px;">Resume Preview</h3>
        <button onclick="document.getElementById('previewModal').style.display='none'" style="background: none; border: none; color: #64748b; font-size: 24px; cursor: pointer;">×</button>
      </div>
      <iframe id="previewIframe" style="flex: 1; border: none; border-radius: 6px; background: white;"></iframe>
    </div>
  </div>

  <script>
    // ========================
    // GLOBAL STATE
    // ========================
    let currentCandidateId = null;
    let currentGeneration = null;
    let baseResumeText = '';
    let selectedTemplate = 't02';
    let highlightedTemplate = 't02';

    // ========================
    // RESUME TEMPLATE ENGINE
    // Canonical structure + 12 CSS-only variations
    // ========================

    const _esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const _list = s => Array.isArray(s) ? s.filter(Boolean) : (s||'').split(/[,\n]+/).map(x=>x.trim()).filter(Boolean);

    const _PRINT_RULES = `@page{size:A4;margin:1.2cm 1.3cm;}html,body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}h2,h3{break-after:avoid-page;page-break-after:avoid;}.section,.role-block,.proj-box,ul,li,p{break-inside:auto;page-break-inside:auto;}@media print{.grid-3{display:block!important;}.skills-row{display:block!important;}.cap-card,.skill-item{display:inline-block!important;width:auto!important;margin-right:10px;}}`;

    function buildCanonicalResumeHTML(data, cssText) {
      const d = data || {};
      const skills = _list(d.skills);
      const competencies = _list(d.competencies || d.coreCompetencies || '');
      const experience = Array.isArray(d.experience) ? d.experience : [];
      const education = Array.isArray(d.education) ? d.education : [];
      const projects = Array.isArray(d.projects) ? d.projects : [];
      const certs = Array.isArray(d.certifications) ? d.certifications : [];
      const contactParts = [d.location, d.email, d.phone, d.linkedin, d.website].filter(Boolean);
      const contactLine = contactParts.map(_esc).join(' &nbsp;|&nbsp; ');
      const expHtml = experience.map(e => {
        const bt = _esc(e.title||e.role||e.position||'');
        const bc = _esc(e.company||e.org||e.employer||'');
        const bd = _esc(e.dates||e.date||e.period||'');
        const bullets = e.bullets||e.points||e.achievements||e.responsibilities||[];
        const subs = (e.projects||[]).map(p =>
          `<div class="proj-box"><div class="proj-name">${_esc(p.name||p.title||'')}</div>${(p.description||p.desc)?`<div class="proj-desc">${_esc(p.description||p.desc)}</div>`:''}</div>`
        ).join('');
        return `<div class="role-block"><div class="role-top"><span class="role-title">${bt}</span><span class="role-dates">${bd}</span></div>${bc?`<div class="role-co">${bc}</div>`:''}${bullets.length?`<ul class="r-bullets">${bullets.map(b=>`<li>${_esc(b)}</li>`).join('')}</ul>`:''}${subs}</div>`;
      }).join('');
      const projHtml = projects.map(p => {
        const nm = _esc(p.name||p.title||''); const ds = _esc(p.description||p.desc||'');
        return nm||ds ? `<div class="proj-box"><div class="proj-name">${nm}</div>${ds?`<div class="proj-desc">${ds}</div>`:''}</div>` : '';
      }).join('');
      const eduHtml = education.map(e =>
        `<div class="edu-row"><div class="edu-top"><span class="edu-deg">${_esc(e.degree||e.qualification||e.level||'')}</span><span class="edu-dt">${_esc(e.dates||e.date||e.year||'')}</span></div>${(e.school||e.institution)?`<div class="edu-sch">${_esc(e.school||e.institution||'')}</div>`:''}</div>`
      ).join('');
      const certHtml = certs.map(c => `<li class="cert-item">${_esc(typeof c==='string'?c:(c.name||c.title||''))}</li>`).join('');
      const sectionsArr = [
        d.summary ? `<div class="section sum-sec"><h2 class="sec-title">Professional Summary</h2><p class="summary-p">${_esc(d.summary)}</p></div>` : '',
        competencies.length ? `<div class="section cap-sec"><h2 class="sec-title">Core Professional Competencies</h2><div class="grid-3">${competencies.map(c=>`<div class="cap-card">${_esc(c)}</div>`).join('')}</div></div>` : '',
        skills.length ? `<div class="section skl-sec"><h2 class="sec-title">Technical Skills and Tools</h2><div class="skills-row">${skills.map(s=>`<span class="skill-item">${_esc(s)}</span>`).join('')}</div></div>` : '',
        expHtml ? `<div class="section exp-sec"><h2 class="sec-title">Professional Experience</h2>${expHtml}</div>` : '',
        projHtml ? `<div class="section prj-sec"><h2 class="sec-title">Projects</h2>${projHtml}</div>` : '',
        eduHtml ? `<div class="section edu-sec"><h2 class="sec-title">Education</h2>${eduHtml}</div>` : '',
        d.monitoring ? `<div class="section"><h2 class="sec-title">Monitoring Performance and Quality</h2><p class="summary-p">${_esc(d.monitoring)}</p></div>` : '',
        d.compliance ? `<div class="section"><h2 class="sec-title">Compliance and Process Governance</h2><p class="summary-p">${_esc(d.compliance)}</p></div>` : '',
        certHtml ? `<div class="section crt-sec"><h2 class="sec-title">Certifications and Trainings</h2><ul class="cert-list">${certHtml}</ul></div>` : '',
        d.additionalInfo ? `<div class="section"><h2 class="sec-title">Additional Information</h2><p class="summary-p">${_esc(d.additionalInfo)}</p></div>` : ''
      ].filter(Boolean).join('');
      const body = `<div class="resume"><div class="r-head"><h1 class="r-name">${_esc(d.name||'Candidate Name')}</h1>${contactLine?`<div class="r-contact">${contactLine}</div>`:''}</div><div class="r-body">${sectionsArr}</div></div>`;
      return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>${cssText}${_PRINT_RULES}</style></head><body>${body}</body></html>`;
    }

    const _CSS_BASE = `*{box-sizing:border-box;margin:0;padding:0;}.resume{max-width:780px;margin:0 auto;padding:20px 24px;}.r-body{padding:0;}.role-block{margin-bottom:10px;}.proj-box{margin:5px 0 5px 14px;}.proj-name{font-weight:700;}.proj-desc{font-size:9pt;}.edu-row{margin-bottom:7px;}.edu-top{display:flex;justify-content:space-between;}.cert-list{padding-left:16px;}.cert-item{margin-bottom:2px;}.role-top{display:flex;justify-content:space-between;}`;

    const _CSS_T01 = _CSS_BASE + `body{font-family:Arial,Helvetica,sans-serif;font-size:10.5pt;color:#1a1a1a;line-height:1.45;background:#fff;}h1.r-name{font-size:17pt;color:#003366;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}.r-contact{font-size:9.5pt;color:#444;margin-bottom:14px;}.section{margin-bottom:12px;}h2.sec-title{font-size:10pt;color:#003366;text-transform:uppercase;letter-spacing:.8px;border-bottom:1.5px solid #003366;padding-bottom:2px;margin-bottom:7px;}.summary-p{font-size:10pt;}.grid-3{display:flex;flex-wrap:wrap;gap:3px 18px;}.cap-card{font-size:10pt;}.cap-card::before{content:"• ";}.skills-row{display:flex;flex-wrap:wrap;gap:3px 16px;}.skill-item{font-size:10pt;}.skill-item::before{content:"▪ ";color:#003366;}.role-title{font-weight:700;font-size:10.5pt;}.role-dates{font-size:9.5pt;color:#555;}.role-co{font-style:italic;color:#333;font-size:10pt;margin-bottom:3px;}.r-bullets{padding-left:16px;font-size:10pt;}.r-bullets li{margin-bottom:2px;}.edu-deg{font-weight:700;font-size:10.5pt;}.edu-dt{font-size:9.5pt;color:#555;}.edu-sch{font-size:10pt;font-style:italic;color:#333;}.cert-list{font-size:10pt;}`;

    const _CSS_T02 = _CSS_BASE + `body{font-family:'Segoe UI',Arial,sans-serif;font-size:10.5pt;color:#1e1e2e;line-height:1.5;background:#fff;}h1.r-name{font-size:22pt;font-weight:300;color:#1e293b;letter-spacing:-0.5px;margin-bottom:5px;}.r-contact{font-size:9pt;color:#64748b;margin-bottom:16px;}.section{margin-bottom:14px;}h2.sec-title{font-size:9pt;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1.5px;border-bottom:1px solid #e2e8f0;padding-bottom:3px;margin-bottom:8px;}.summary-p{font-size:10.5pt;color:#334155;line-height:1.55;}.grid-3{display:flex;flex-wrap:wrap;gap:4px 20px;}.cap-card{font-size:10pt;color:#334155;}.cap-card::before{content:"– ";color:#94a3b8;}.skills-row{display:flex;flex-wrap:wrap;gap:4px 16px;}.skill-item{font-size:9.5pt;color:#334155;}.skill-item::before{content:"— ";color:#94a3b8;}.role-title{font-weight:600;font-size:10.5pt;color:#1e293b;}.role-dates{font-size:9pt;color:#94a3b8;}.role-co{font-size:10pt;color:#475569;margin-bottom:4px;}.r-bullets{padding-left:14px;}.r-bullets li{font-size:10pt;color:#334155;margin-bottom:2px;}.edu-deg{font-weight:600;font-size:10.5pt;}.edu-dt{font-size:9pt;color:#94a3b8;}.edu-sch{font-size:10pt;color:#475569;}.cert-list{font-size:10pt;color:#334155;}`;

    const _CSS_T03 = _CSS_BASE + `body{font-family:Georgia,'Times New Roman',serif;font-size:10.5pt;color:#1a150e;line-height:1.5;background:#fff;}.r-head{text-align:center;border-bottom:3px double #7c5c2e;padding-bottom:14px;margin-bottom:16px;}h1.r-name{font-size:20pt;font-weight:700;color:#2c1a08;letter-spacing:2px;text-transform:uppercase;}.r-contact{font-size:9.5pt;color:#5a4228;margin-top:6px;font-style:italic;}.section{margin-bottom:13px;}h2.sec-title{font-size:10pt;font-weight:700;color:#4a2e10;text-transform:uppercase;letter-spacing:2px;text-align:center;border-bottom:1px solid #c8a86a;padding-bottom:3px;margin-bottom:7px;}.summary-p{font-style:italic;color:#2c2010;}.grid-3{columns:2;column-gap:20px;}.cap-card{font-size:10pt;display:block;padding:1px 0;}.cap-card::before{content:"• ";}.skills-row{columns:2;column-gap:20px;}.skill-item{font-size:10pt;display:block;padding:1px 0;}.skill-item::before{content:"• ";}.role-title{font-weight:700;font-size:10.5pt;color:#2c1a08;}.role-dates{font-size:9.5pt;color:#7c5c2e;font-style:italic;}.role-co{font-size:10pt;font-variant:small-caps;color:#4a3820;margin-bottom:4px;}.r-bullets{padding-left:16px;}.r-bullets li{font-size:10pt;margin-bottom:2px;}.edu-deg{font-weight:700;font-variant:small-caps;font-size:10.5pt;}.edu-dt{font-size:9.5pt;color:#7c5c2e;font-style:italic;}.edu-sch{font-size:10pt;font-style:italic;color:#4a3820;}.cert-list{font-size:10pt;}@media print{.grid-3{columns:1!important;}.skills-row{columns:1!important;}.cap-card,.skill-item{display:inline-block!important;width:auto!important;margin-right:12px;}}`;

    const _CSS_T04 = _CSS_BASE + `body{font-family:'Calibri',Arial,sans-serif;font-size:9.5pt;color:#1a1a2e;line-height:1.4;background:#fff;}.r-head{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #1a3a5c;padding-bottom:10px;margin-bottom:12px;}h1.r-name{font-size:16pt;font-weight:700;color:#1a3a5c;}.r-contact{font-size:8.5pt;color:#456;text-align:right;line-height:1.6;}.section{margin-bottom:9px;}h2.sec-title{font-size:9pt;font-weight:700;color:#fff;background:#1a3a5c;text-transform:uppercase;letter-spacing:1px;padding:2px 7px;margin-bottom:6px;display:inline-block;}.summary-p{font-size:9.5pt;}.grid-3{display:flex;flex-wrap:wrap;gap:2px 16px;}.cap-card{font-size:9pt;}.cap-card::before{content:"▸ ";color:#1a3a5c;}.skills-row{display:flex;flex-wrap:wrap;gap:2px 14px;}.skill-item{font-size:9pt;}.skill-item::before{content:"▪ ";color:#1a3a5c;}.role-title{font-weight:700;font-size:9.5pt;color:#1a3a5c;}.role-dates{font-size:8.5pt;color:#556;}.role-co{font-size:9pt;font-style:italic;color:#334;margin-bottom:2px;}.r-bullets{padding-left:14px;}.r-bullets li{font-size:9pt;margin-bottom:1px;}.edu-deg{font-weight:700;font-size:9.5pt;}.edu-dt{font-size:8.5pt;color:#556;}.edu-sch{font-size:9pt;font-style:italic;color:#334;}.cert-list{font-size:9pt;}@media print{.r-head{display:block!important;}.r-contact{text-align:left!important;margin-top:4px;}}`;

    const _CSS_T05 = _CSS_BASE + `body{font-family:Verdana,Arial,sans-serif;font-size:10pt;color:#111827;line-height:1.5;background:#fff;}h1.r-name{font-size:19pt;color:#0d7a6e;font-weight:700;margin-bottom:4px;}.r-contact{font-size:9pt;color:#374151;margin-bottom:16px;}.section{margin-bottom:13px;}h2.sec-title{font-size:11pt;font-weight:700;color:#0d7a6e;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid #0d7a6e;padding-bottom:3px;margin-bottom:7px;}.summary-p{font-size:10pt;color:#1f2937;}.grid-3{display:flex;flex-wrap:wrap;gap:4px 20px;}.cap-card{font-size:10pt;}.cap-card::before{content:"✓ ";color:#0d7a6e;}.skills-row{display:flex;flex-wrap:wrap;gap:4px 18px;}.skill-item{font-size:9.5pt;}.skill-item::before{content:"✓ ";color:#0d7a6e;}.role-title{font-weight:700;font-size:10.5pt;}.role-dates{font-size:9pt;color:#6b7280;}.role-co{font-size:10pt;color:#374151;margin-bottom:3px;}.r-bullets{padding-left:15px;}.r-bullets li{font-size:10pt;margin-bottom:2px;}.edu-deg{font-weight:700;font-size:10pt;}.edu-dt{font-size:9pt;color:#6b7280;}.edu-sch{font-size:9.5pt;color:#374151;}.cert-list{font-size:10pt;}`;

    const _CSS_T06 = _CSS_BASE + `body{font-family:'Trebuchet MS',Arial,sans-serif;font-size:10pt;color:#1e1b4b;line-height:1.5;background:#fff;}h1.r-name{font-size:20pt;color:#1e1b4b;font-weight:700;letter-spacing:-0.3px;margin-bottom:4px;}.r-contact{font-size:9pt;color:#4338ca;margin-bottom:18px;}.section{border-left:3px solid #4f46e5;padding-left:14px;margin-bottom:14px;}h2.sec-title{font-size:10pt;font-weight:700;color:#4f46e5;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}.summary-p{color:#312e81;}.grid-3{display:flex;flex-wrap:wrap;gap:4px 16px;}.cap-card{font-size:9.5pt;}.cap-card::before{content:"› ";color:#4f46e5;font-weight:700;}.skills-row{display:flex;flex-wrap:wrap;gap:4px 16px;}.skill-item{font-size:9.5pt;}.skill-item::before{content:"› ";color:#4f46e5;font-weight:700;}.role-title{font-weight:700;font-size:10.5pt;color:#1e1b4b;}.role-dates{font-size:9pt;color:#6366f1;}.role-co{font-size:10pt;color:#4338ca;margin-bottom:3px;}.r-bullets{padding-left:15px;}.r-bullets li{font-size:10pt;color:#312e81;margin-bottom:2px;}.edu-deg{font-weight:700;}.edu-dt{font-size:9pt;color:#6366f1;}.edu-sch{font-size:10pt;color:#4338ca;}.cert-list{font-size:10pt;color:#312e81;}`;

    const _CSS_T07 = _CSS_BASE + `body{font-family:Arial,sans-serif;font-size:10pt;color:#111827;line-height:1.5;background:#fff;}.resume{padding:0;}.r-head{background:#0f172a;color:#f8fafc;padding:18px 24px 14px;}h1.r-name{font-size:22pt;font-weight:700;color:#f8fafc;letter-spacing:-0.5px;margin-bottom:5px;}.r-contact{font-size:9pt;color:#94a3b8;}.r-body{padding:16px 24px;}.section{margin-bottom:13px;}h2.sec-title{font-size:10.5pt;font-weight:700;color:#0f172a;text-transform:uppercase;letter-spacing:.8px;border-bottom:2px solid #e2e8f0;padding-bottom:3px;margin-bottom:7px;}.summary-p{color:#1f2937;}.grid-3{display:flex;flex-wrap:wrap;gap:3px 16px;}.cap-card{font-size:9.5pt;}.cap-card::before{content:"· ";font-size:11pt;line-height:0;vertical-align:middle;}.skills-row{display:flex;flex-wrap:wrap;gap:3px 16px;}.skill-item{font-size:9.5pt;}.skill-item::before{content:"· ";font-size:11pt;line-height:0;vertical-align:middle;}.role-title{font-weight:700;}.role-dates{font-size:9pt;color:#6b7280;}.role-co{font-size:10pt;font-weight:600;color:#374151;margin-bottom:3px;}.r-bullets{padding-left:15px;}.r-bullets li{margin-bottom:2px;}.edu-deg{font-weight:700;}.edu-dt{font-size:9pt;color:#6b7280;}.edu-sch{font-size:10pt;color:#374151;}.cert-list{font-size:10pt;}@media print{.r-head{background:#0f172a!important;-webkit-print-color-adjust:exact;}.r-body{padding:8px 0!important;}}`;

    const _CSS_T08 = _CSS_BASE + `body{font-family:'Segoe UI',Arial,sans-serif;font-size:10pt;color:#1a1a2e;line-height:1.5;background:#fff;}.resume{max-width:820px;padding:0;}.r-head{background:#f0f4f8;padding:16px 24px 12px;border-bottom:2.5px solid #2d6a4f;}h1.r-name{font-size:18pt;font-weight:700;color:#1b4332;}.r-contact{font-size:9pt;color:#2d6a4f;margin-top:4px;}.r-body{display:grid;grid-template-columns:36% 1fr;}.section.skl-sec,.section.cap-sec,.section.crt-sec,.section.edu-sec{grid-column:1;background:#f8fafb;border-right:1px solid #d1fae5;padding:12px 14px;}.section.sum-sec,.section.exp-sec,.section.prj-sec{grid-column:2;padding:12px 16px;}.section{margin:0;}h2.sec-title{font-size:9pt;font-weight:700;color:#1b4332;text-transform:uppercase;letter-spacing:1px;border-bottom:1.5px solid #2d6a4f;padding-bottom:2px;margin-bottom:6px;}.summary-p{font-size:10pt;}.grid-3{display:flex;flex-wrap:wrap;gap:3px 12px;}.cap-card{font-size:9pt;}.cap-card::before{content:"▸ ";color:#2d6a4f;}.skills-row{display:flex;flex-wrap:wrap;gap:3px 12px;}.skill-item{font-size:9pt;}.skill-item::before{content:"▸ ";color:#2d6a4f;}.role-title{font-weight:700;font-size:10pt;color:#1b4332;}.role-dates{font-size:9pt;color:#6b7280;}.role-co{font-size:9.5pt;color:#2d6a4f;margin-bottom:3px;}.r-bullets{padding-left:14px;}.r-bullets li{font-size:9.5pt;margin-bottom:2px;}.edu-deg{font-weight:700;font-size:9.5pt;}.edu-dt{font-size:9pt;color:#6b7280;}.edu-sch{font-size:9pt;color:#2d6a4f;}.cert-list{font-size:9pt;}@media print{.r-head{background:#f0f4f8!important;}.r-body{display:block!important;}.section.skl-sec,.section.cap-sec,.section.crt-sec,.section.edu-sec,.section.sum-sec,.section.exp-sec,.section.prj-sec{grid-column:auto!important;background:none!important;border-right:none!important;padding:0 0 12px!important;}}`;

    const _CSS_T09 = _CSS_BASE + `body{font-family:Arial,Helvetica,sans-serif;font-size:10pt;color:#111;line-height:1.5;background:#fff;}h1.r-name{font-size:18pt;color:#7c3aed;font-weight:700;margin-bottom:3px;}.r-contact{font-size:9pt;color:#5b21b6;margin-bottom:14px;}.section{margin-bottom:13px;}h2.sec-title{font-size:10pt;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:.8px;border-bottom:1.5px solid #ddd6fe;padding-bottom:2px;margin-bottom:7px;}.section.skl-sec{background:#faf5ff;border:1.5px solid #ddd6fe;border-radius:3px;padding:10px 14px;margin-bottom:14px;}.section.skl-sec h2.sec-title{border-bottom-color:#7c3aed;}.summary-p{color:#1f1f2e;}.grid-3{display:flex;flex-wrap:wrap;gap:3px 14px;}.cap-card{font-size:10pt;}.cap-card::before{content:"✦ ";color:#7c3aed;font-size:8pt;}.skills-row{display:flex;flex-wrap:wrap;gap:3px 14px;}.skill-item{font-size:9.5pt;color:#4c1d95;}.skill-item::before{content:"✦ ";font-size:8pt;vertical-align:middle;}.role-title{font-weight:700;font-size:10.5pt;color:#1a1a2e;}.role-dates{font-size:9pt;color:#7c3aed;}.role-co{font-size:10pt;color:#374151;margin-bottom:3px;}.r-bullets{padding-left:15px;}.r-bullets li{font-size:10pt;margin-bottom:2px;}.edu-deg{font-weight:700;}.edu-dt{font-size:9pt;color:#7c3aed;}.edu-sch{font-size:10pt;color:#374151;}.cert-list{font-size:10pt;}@media print{.section.skl-sec{background:#faf5ff!important;border:1px solid #ddd6fe!important;}}`;

    const _CSS_T10 = _CSS_BASE + `body{font-family:'Segoe UI',Arial,sans-serif;font-size:10pt;color:#1a1a1a;line-height:1.5;background:#fff;}.r-head{display:flex;justify-content:space-between;align-items:flex-end;border-bottom:2.5px solid #b45309;padding-bottom:12px;margin-bottom:14px;}h1.r-name{font-size:19pt;color:#78350f;font-weight:700;}.r-contact{font-size:9pt;color:#92400e;text-align:right;line-height:1.7;}.section{margin-bottom:13px;}h2.sec-title{font-size:10.5pt;font-weight:700;color:#92400e;text-transform:uppercase;letter-spacing:.7px;border-left:4px solid #b45309;padding-left:8px;margin-bottom:7px;}.section.exp-sec h2.sec-title{font-size:12pt;}.summary-p{color:#1c1917;}.grid-3{display:flex;flex-wrap:wrap;gap:3px 15px;}.cap-card{font-size:10pt;}.cap-card::before{content:"• ";color:#b45309;}.skills-row{display:flex;flex-wrap:wrap;gap:3px 15px;}.skill-item{font-size:9.5pt;}.skill-item::before{content:"• ";color:#b45309;}.role-title{font-weight:700;font-size:10.5pt;color:#1c1917;}.role-dates{font-size:9pt;color:#b45309;font-weight:600;}.role-co{font-size:10pt;color:#44403c;font-weight:600;margin-bottom:3px;}.r-bullets{padding-left:15px;}.r-bullets li{font-size:10pt;margin-bottom:2px;}.edu-deg{font-weight:700;font-size:10pt;}.edu-dt{font-size:9pt;color:#b45309;}.edu-sch{font-size:10pt;color:#44403c;}.cert-list{font-size:10pt;}@media print{.r-head{display:block!important;}.r-contact{text-align:left!important;margin-top:4px;}}`;

    const _CSS_T11 = _CSS_BASE + `body{font-family:'Palatino Linotype',Palatino,Georgia,serif;font-size:10.5pt;color:#1a1a1a;line-height:1.6;background:#fff;}.r-head{text-align:center;margin-bottom:14px;}h1.r-name{font-size:18pt;font-weight:700;color:#1e3a5f;margin-bottom:4px;letter-spacing:.5px;}.r-contact{font-size:9.5pt;color:#2c4a6e;}.section{margin-bottom:14px;}h2.sec-title{font-size:10.5pt;font-weight:700;color:#1e3a5f;text-transform:uppercase;letter-spacing:1.5px;border-bottom:1px solid #1e3a5f;padding-bottom:3px;margin-bottom:7px;}.summary-p{text-align:justify;}.grid-3{columns:2;column-gap:22px;}.cap-card{font-size:10pt;display:block;padding:1px 0;}.cap-card::before{content:"• ";}.skills-row{columns:2;column-gap:22px;}.skill-item{font-size:10pt;display:block;padding:1px 0;}.skill-item::before{content:"• ";}.role-title{font-weight:700;font-size:10.5pt;color:#1e3a5f;}.role-dates{font-size:9.5pt;color:#4a6a8a;font-style:italic;}.role-co{font-size:10pt;font-style:italic;color:#2c4a6e;margin-bottom:3px;}.r-bullets{padding-left:18px;list-style-type:disc;}.r-bullets li{font-size:10pt;margin-bottom:2px;}.edu-deg{font-weight:700;font-size:10.5pt;color:#1e3a5f;}.edu-dt{font-size:9.5pt;color:#4a6a8a;font-style:italic;}.edu-sch{font-size:10pt;font-style:italic;color:#2c4a6e;}.cert-list{font-size:10pt;}@media print{.grid-3{columns:1!important;}.skills-row{columns:1!important;}.cap-card,.skill-item{display:inline-block!important;width:auto!important;margin-right:14px;}}`;

    const _CSS_T12 = _CSS_BASE + `body{font-family:Arial,sans-serif;font-size:10pt;color:#111827;line-height:1.5;background:#fff;}h1.r-name{font-size:18pt;color:#065f46;font-weight:700;margin-bottom:3px;}.r-contact{font-size:9pt;color:#047857;margin-bottom:14px;}.section{margin-bottom:13px;}h2.sec-title{font-size:10pt;font-weight:700;color:#065f46;text-transform:uppercase;letter-spacing:1px;border-bottom:1.5px solid #a7f3d0;padding-bottom:3px;margin-bottom:7px;}.summary-p{color:#111827;}.grid-3{display:flex;flex-wrap:wrap;gap:3px 14px;}.cap-card{font-size:9.5pt;}.cap-card::before{content:"◉ ";color:#059669;font-size:7pt;vertical-align:middle;}.skills-row{display:flex;flex-wrap:wrap;gap:3px 14px;}.skill-item{font-size:9.5pt;}.skill-item::before{content:"◉ ";color:#059669;font-size:7pt;vertical-align:middle;}.section.exp-sec .role-block{position:relative;padding-left:18px;margin-bottom:11px;}.section.exp-sec .role-block::before{content:"";position:absolute;left:4px;top:5px;width:8px;height:8px;border-radius:50%;background:#059669;}.section.exp-sec .role-block::after{content:"";position:absolute;left:7.5px;top:13px;bottom:-5px;width:1px;background:#a7f3d0;}.section.exp-sec .role-block:last-child::after{display:none;}.role-title{font-weight:700;font-size:10.5pt;color:#065f46;}.role-dates{font-size:9pt;color:#6b7280;}.role-co{font-size:10pt;color:#047857;margin-bottom:3px;}.r-bullets{padding-left:14px;}.r-bullets li{font-size:10pt;margin-bottom:2px;}.edu-deg{font-weight:700;font-size:10pt;}.edu-dt{font-size:9pt;color:#6b7280;}.edu-sch{font-size:10pt;color:#047857;}.cert-list{font-size:10pt;}@media print{.section.exp-sec .role-block{padding-left:0!important;position:static!important;}.section.exp-sec .role-block::before,.section.exp-sec .role-block::after{display:none!important;}}`;

    const TEMPLATES = [
      { id: 't01', name: 'Classic ATS',         tag: 'Classic',       render: d => buildCanonicalResumeHTML(d, _CSS_T01) },
      { id: 't02', name: 'Modern Minimal',       tag: 'Modern',        render: d => buildCanonicalResumeHTML(d, _CSS_T02) },
      { id: 't03', name: 'Executive Serif',      tag: 'Premium',       render: d => buildCanonicalResumeHTML(d, _CSS_T03) },
      { id: 't04', name: 'Compact Professional', tag: 'Professional',  render: d => buildCanonicalResumeHTML(d, _CSS_T04) },
      { id: 't05', name: 'Divider Sections',     tag: 'Clean',         render: d => buildCanonicalResumeHTML(d, _CSS_T05) },
      { id: 't06', name: 'Left Accent Line',     tag: 'Modern',        render: d => buildCanonicalResumeHTML(d, _CSS_T06) },
      { id: 't07', name: 'Bold Header Bar',      tag: 'Premium',       render: d => buildCanonicalResumeHTML(d, _CSS_T07) },
      { id: 't08', name: 'Clean Two-Column',     tag: 'Professional',  render: d => buildCanonicalResumeHTML(d, _CSS_T08) },
      { id: 't09', name: 'Skills-First',         tag: 'Modern',        render: d => buildCanonicalResumeHTML(d, _CSS_T09) },
      { id: 't10', name: 'Experience-First',     tag: 'Classic',       render: d => buildCanonicalResumeHTML(d, _CSS_T10) },
      { id: 't11', name: 'Academic Clean',       tag: 'Clean',         render: d => buildCanonicalResumeHTML(d, _CSS_T11) },
      { id: 't12', name: 'Timeline Light',       tag: 'Modern',        render: d => buildCanonicalResumeHTML(d, _CSS_T12) }
    ];
    let currentStep = 1;
    let completedSteps = new Set();
    let skillsMap = new Map(); // {skill: frequency}
    let uploadedFile = null;
    let inputMode = 'upload'; // 'upload' or 'admin'
    let adminCandidateData = null;
    let editedResumeData = null;

    // ========================
    // INPUT MODE SWITCHING
    // ========================
    function switchInputMode(mode) {
      inputMode = mode;
      document.getElementById('uploadModeBtn').classList.toggle('active', mode === 'upload');
      document.getElementById('adminModeBtn').classList.toggle('active', mode === 'admin');
      document.getElementById('uploadModeContainer').style.display = mode === 'upload' ? 'block' : 'none';
      document.getElementById('adminModeContainer').style.display = mode === 'admin' ? 'block' : 'none';

      if (mode === 'admin') {
        loadAdminApprovedData();
      } else {
        markStepCompleted(1);
      }
    }

    async function loadAdminApprovedData() {
      const statusEl = document.getElementById('adminDataStatus');
      statusEl.textContent = 'Loading candidate details...';
      
      try {
        // Initialize Firebase if not already done
        if (!window.db) {
          const firebaseConfig = {
            apiKey: "AIzaSyBl4Mjn-X8hXq_kpVu7YkOjFhQPqh6YFFs",
            authDomain: "hireready-405212.firebaseapp.com",
            projectId: "hireready-405212",
            storageBucket: "hireready-405212.appspot.com",
            messagingSenderId: "966687008821",
            appId: "1:966687008821:web:3c21f43e0ce3e6d5b8e6c7"
          };
          firebase.initializeApp(firebaseConfig);
          window.db = firebase.firestore();
        }

        // Fetch admin-approved candidate details
        const docRef = window.db.collection('candidateDetails').doc(currentCandidateId);
        const docSnap = await docRef.get();

        if (docSnap.exists) {
          adminCandidateData = docSnap.data();
          statusEl.textContent = `Loaded: ${adminCandidateData.personalInfo?.fullName || 'Candidate'}`;
          baseResumeText = formatAdminDataAsResume(adminCandidateData);
          markStepCompleted(1);
          showToast('Admin-approved data loaded successfully!', 'success');
        } else {
          throw new Error('Candidate data not found');
        }
      } catch (error) {
        console.error('Error loading admin data:', error);
        statusEl.textContent = 'Error loading data. Please use upload mode.';
        showToast('Failed to load admin data', 'error');
        setTimeout(() => switchInputMode('upload'), 2000);
      }
    }

    function formatAdminDataAsResume(data) {
      let resume = '';
      
      // Personal Info
      if (data.personalInfo) {
        resume += `${data.personalInfo.fullName || ''}\n`;
        resume += `${data.personalInfo.email || ''} | ${data.personalInfo.phone || ''}\n`;
        resume += `${data.personalInfo.city || ''}, ${data.personalInfo.state || ''}\n\n`;
      }

      // Professional Summary
      if (data.professionalSummary) {
        resume += `PROFESSIONAL SUMMARY\n${data.professionalSummary}\n\n`;
      }

      // Skills
      if (data.skills && data.skills.length > 0) {
        resume += `SKILLS\n${data.skills.join(', ')}\n\n`;
      }

      // Employment
      if (data.employment && data.employment.length > 0) {
        resume += `EMPLOYMENT HISTORY\n`;
        data.employment.forEach(job => {
          resume += `${job.jobTitle || ''} at ${job.company || ''}\n`;
          resume += `${job.startDate || ''} - ${job.current ? 'Present' : job.endDate || ''}\n`;
          resume += `${job.description || ''}\n\n`;
        });
      }

      // Education
      if (data.education && data.education.length > 0) {
        resume += `EDUCATION\n`;
        data.education.forEach(edu => {
          resume += `${edu.degree || ''} in ${edu.fieldOfStudy || ''}\n`;
          resume += `${edu.institution || ''}, ${edu.graduationYear || ''}\n\n`;
        });
      }

      // Certifications
      if (data.certifications && data.certifications.length > 0) {
        resume += `CERTIFICATIONS\n`;
        data.certifications.forEach(cert => {
          resume += `${cert.name || ''} - ${cert.issuingOrganization || ''} (${cert.dateObtained || ''})\n`;
        });
      }

      return resume;
    }

    // ========================
    // ENHANCED FILE UPLOAD WITH STATUS
    // ========================
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      handleFile(file);
    }

    async function handleFile(file) {
      const fileCardContainer = document.getElementById('fileCardContainer');
      const fileStatusContainer = document.getElementById('fileStatusContainer');
      
      // Show loading status
      fileStatusContainer.innerHTML = '<div class="jdm-file-status loading"><span>📄</span> Reading file...</div>';

      uploadedFile = file;
      
      // Display file card
      const fileSize = (file.size / 1024).toFixed(2) + ' KB';
      const fileType = file.name.split('.').pop().toUpperCase();
      
      fileCardContainer.innerHTML = `
        <div class="jdm-file-card">
          <div class="jdm-file-icon">📄</div>
          <div class="jdm-file-info">
            <div class="jdm-file-name">${file.name}</div>
            <div class="jdm-file-size">${fileType} • ${fileSize}</div>
          </div>
          <div class="jdm-file-actions">
            <button class="jdm-icon-btn" onclick="replaceFile()" title="Replace">🔄</button>
            <button class="jdm-icon-btn danger" onclick="removeFile()" title="Remove">🗑️</button>
          </div>
        </div>
      `;

      // Branch by file type and extract text
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'txt') {
        extractTXT(file, fileStatusContainer);
      } else if (ext === 'docx' || ext === 'doc') {
        extractDOCX(file, fileStatusContainer);
      } else if (ext === 'pdf') {
        extractPDF(file, fileStatusContainer);
      } else {
        fileStatusContainer.innerHTML = '<div class="jdm-file-status"><span>✔</span> Resume added. Upload a file or paste text — either works.</div>';
        markStepCompleted(1);
      }
    }

    function replaceFile() {
      document.getElementById('baseResumeFile').click();
    }

    function removeFile() {
      uploadedFile = null;
      baseResumeText = '';
      document.getElementById('fileCardContainer').innerHTML = '';
      document.getElementById('fileStatusContainer').innerHTML = '';
      document.getElementById('baseResumeFile').value = '';
      document.getElementById('baseResumePaste').value = '';
      showToast('File removed', 'success');
    }

    // ========================
    // FILE TEXT EXTRACTION
    // ========================
    function setExtractedResumeText(text, statusEl) {
      document.getElementById('baseResumePaste').value = text;
      baseResumeText = text;
      localStorage.setItem(getStorageKey('base_resume'), text);
      statusEl.innerHTML = '<div class="jdm-file-status"><span>✔</span> Resume text extracted successfully!</div>';
      markStepCompleted(1);
      showToast('Resume text extracted!', 'success');
    }

    async function extractTXT(file, statusEl) {
      try {
        const text = await file.text();
        if (!text || text.trim().length < 5) {
          statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> TXT file appears empty. Please paste text manually.</div>';
          return;
        }
        setExtractedResumeText(text, statusEl);
      } catch (e) {
        statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> Could not read TXT file. Please paste text manually.</div>';
      }
    }

    async function extractDOCX(file, statusEl) {
      try {
        statusEl.innerHTML = '<div class="jdm-file-status loading"><span>📄</span> Extracting text from DOCX...</div>';
        if (typeof mammoth === 'undefined') {
          statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> DOCX reader not loaded. Please paste text manually.</div>';
          return;
        }
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        const text = result.value || '';
        if (!text || text.trim().length < 50) {
          statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> Could not extract text from DOCX. Please paste text manually.</div>';
          return;
        }
        setExtractedResumeText(text, statusEl);
      } catch (e) {
        statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> Could not read DOCX file. Please paste text manually.</div>';
      }
    }

    async function extractPDF(file, statusEl) {
      try {
        statusEl.innerHTML = '<div class="jdm-file-status loading"><span>📄</span> Extracting text from PDF...</div>';
        if (typeof pdfjsLib === 'undefined') {
          statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> PDF reader not loaded. Please paste text manually.</div>';
          return;
        }
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const pageText = content.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        if (!fullText || fullText.trim().length < 50) {
          statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> This PDF has no selectable text. Please paste your resume text.</div>';
          showToast('Could not extract text from this PDF (it may be scanned). Please paste your resume text.', 'error');
          return;
        }
        setExtractedResumeText(fullText, statusEl);
      } catch (e) {
        statusEl.innerHTML = '<div class="jdm-file-status loading"><span>⚠️</span> Could not read PDF file. Please paste text manually.</div>';
      }
    }

    // ========================
    // RESUME EDITOR
    // ========================
    function toggleEditor() {
      const editor = document.getElementById('resumeEditor');
      const isActive = editor.classList.toggle('active');
      
      if (isActive) {
        populateEditor();
        document.getElementById('editorToggleBtn').textContent = '✕ Close Editor';
      } else {
        document.getElementById('editorToggleBtn').textContent = '✅ Edit Resume Content';
      }
    }

    function populateEditor() {
      // Parse current generated resume data
      if (!currentGeneration) return;
      
      // For now, populate with placeholder data
      // In production, parse currentGeneration.resumeHtml to extract sections
      document.getElementById('editorSummary').value = 'Results-driven professional with X years of experience...';
      document.getElementById('editorSkills').value = Array.from(skillsMap.keys()).join(', ');
      
      renderEmploymentEntries();
      renderEducationEntries();
    }

    let employmentEntries = [];
    let educationEntries = [];

    function renderEmploymentEntries() {
      const container = document.getElementById('employmentContainer');
      
      if (adminCandidateData && adminCandidateData.employment) {
        employmentEntries = adminCandidateData.employment;
      } else if (employmentEntries.length === 0) {
        employmentEntries = [{
          jobTitle: '',
          company: '',
          startDate: '',
          endDate: '',
          description: ''
        }];
      }

      container.innerHTML = employmentEntries.map((entry, idx) => `
        <div class="jdm-editor-item">
          <div class="jdm-editor-item-header">
            <span style="font-size: 12px; font-weight: 600; color: var(--text);">Position ${idx + 1}</span>
            <button class="jdm-icon-btn danger" onclick="removeEmploymentEntry(${idx})">🗑️</button>
          </div>
          <div class="jdm-form-group">
            <input type="text" class="jdm-input" placeholder="Job Title" value="${entry.jobTitle || ''}" onchange="updateEmploymentEntry(${idx}, 'jobTitle', this.value)" style="margin-bottom: 8px;">
            <input type="text" class="jdm-input" placeholder="Company" value="${entry.company || ''}" onchange="updateEmploymentEntry(${idx}, 'company', this.value)" style="margin-bottom: 8px;">
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <input type="text" class="jdm-input" placeholder="Start Date" value="${entry.startDate || ''}" onchange="updateEmploymentEntry(${idx}, 'startDate', this.value)" style="flex: 1;">
              <input type="text" class="jdm-input" placeholder="End Date" value="${entry.endDate || ''}" onchange="updateEmploymentEntry(${idx}, 'endDate', this.value)" style="flex: 1;">
            </div>
            <textarea class="jdm-textarea" placeholder="Description..." onchange="updateEmploymentEntry(${idx}, 'description', this.value)" style="min-height: 80px;">${entry.description || ''}</textarea>
          </div>
        </div>
      `).join('');
    }

    function addEmploymentEntry() {
      employmentEntries.push({
        jobTitle: '',
        company: '',
        startDate: '',
        endDate: '',
        description: ''
      });
      renderEmploymentEntries();
    }

    function updateEmploymentEntry(idx, field, value) {
      if (employmentEntries[idx]) {
        employmentEntries[idx][field] = value;
      }
    }

    function removeEmploymentEntry(idx) {
      if (confirm('Remove this employment entry?')) {
        employmentEntries.splice(idx, 1);
        renderEmploymentEntries();
      }
    }

    function renderEducationEntries() {
      const container = document.getElementById('educationContainer');
      
      if (adminCandidateData && adminCandidateData.education) {
        educationEntries = adminCandidateData.education;
      } else if (educationEntries.length === 0) {
        educationEntries = [{
          degree: '',
          institution: '',
          graduationYear: ''
        }];
      }

      container.innerHTML = educationEntries.map((entry, idx) => `
        <div class="jdm-editor-item">
          <div class="jdm-editor-item-header">
            <span style="font-size: 12px; font-weight: 600; color: var(--text);">Education ${idx + 1}</span>
            <button class="jdm-icon-btn danger" onclick="removeEducationEntry(${idx})">🗑️</button>
          </div>
          <div class="jdm-form-group">
            <input type="text" class="jdm-input" placeholder="Degree" value="${entry.degree || ''}" onchange="updateEducationEntry(${idx}, 'degree', this.value)" style="margin-bottom: 8px;">
            <input type="text" class="jdm-input" placeholder="Institution" value="${entry.institution || ''}" onchange="updateEducationEntry(${idx}, 'institution', this.value)" style="margin-bottom: 8px;">
            <input type="text" class="jdm-input" placeholder="Graduation Year" value="${entry.graduationYear || ''}" onchange="updateEducationEntry(${idx}, 'graduationYear', this.value)">
          </div>
        </div>
      `).join('');
    }

    function addEducationEntry() {
      educationEntries.push({
        degree: '',
        institution: '',
        graduationYear: ''
      });
      renderEducationEntries();
    }

    function updateEducationEntry(idx, field, value) {
      if (educationEntries[idx]) {
        educationEntries[idx][field] = value;
      }
    }

    function removeEducationEntry(idx) {
      if (confirm('Remove this education entry?')) {
        educationEntries.splice(idx, 1);
        renderEducationEntries();
      }
    }

    function saveDraft() {
      editedResumeData = {
        summary: document.getElementById('editorSummary').value,
        skills: document.getElementById('editorSkills').value,
        employment: employmentEntries,
        education: educationEntries
      };
      
      // Store edited data
      localStorage.setItem(getStorageKey('edited_resume'), JSON.stringify(editedResumeData));
      showToast('Draft saved successfully!', 'success');
    }

    async function regenerateResume() {
      if (!confirm('Regenerate resume with current edits? This will create a new resume.')) return;
      
      saveDraft();
      toggleEditor();
      
      // Update baseResumeText with edited data
      baseResumeText = formatEditedDataAsResume(editedResumeData);
      
      // Trigger generation
      await handleGenerate();
    }

    function formatEditedDataAsResume(data) {
      let resume = '';
      
      if (data.summary) {
        resume += `PROFESSIONAL SUMMARY\n${data.summary}\n\n`;
      }

      if (data.skills) {
        resume += `SKILLS\n${data.skills}\n\n`;
      }

      if (data.employment && data.employment.length > 0) {
        resume += `EMPLOYMENT HISTORY\n`;
        data.employment.forEach(job => {
          resume += `${job.jobTitle} at ${job.company}\n`;
          resume += `${job.startDate} - ${job.endDate}\n`;
          resume += `${job.description}\n\n`;
        });
      }

      if (data.education && data.education.length > 0) {
        resume += `EDUCATION\n`;
        data.education.forEach(edu => {
          resume += `${edu.degree}, ${edu.institution}, ${edu.graduationYear}\n`;
        });
      }

      return resume;
    }

    // ========================
    // WIZARD NAVIGATION
    // ========================
    function goToStep(step) {
      currentStep = step;
      updateWizardUI();
      
      // Scroll to relevant section based on step
      const sectionMap = {
        1: 'baseResumeSection',
        2: 'jobDescription',
        3: 'strictnessSlider',
        4: () => openTemplateDrawer(),
        5: 'generateBtn'
      };
      
      const targetId = sectionMap[step];
      if (typeof targetId === 'function') {
        targetId();
      } else if (targetId) {
        const element = document.getElementById(targetId);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    function updateWizardUI() {
      document.querySelectorAll('.jdm-wizard-step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.remove('active', 'completed');
        
        if (stepNum === currentStep) {
          step.classList.add('active');
        } else if (completedSteps.has(stepNum) || stepNum < currentStep) {
          step.classList.add('completed');
          step.querySelector('.jdm-wizard-step-circle').textContent = '✔';
        } else {
          step.querySelector('.jdm-wizard-step-circle').textContent = stepNum;
        }
      });
    }

    function markStepCompleted(step) {
      completedSteps.add(step);
      updateWizardUI();
    }

    // ========================
    // DRAG & DROP FILE UPLOAD
    // ========================
    function initDragDrop() {
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('baseResumeFile');

      uploadZone.addEventListener('click', () => fileInput.click());

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });
    }

    // ========================
    // SKILL FREQUENCY STEPPER
    // ========================
    function handleSkillKeypress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = event.target;
        const skill = input.value.trim();
        if (skill) {
          addSkill(skill);
          input.value = '';
        }
      }
    }

    function addSkill(skill) {
      if (skillsMap.has(skill)) {
        showToast('Skill already added', 'error');
        return;
      }
      skillsMap.set(skill, 3); // Default frequency
      renderSkills();
      showToast(`Added: ${skill}`, 'success');
    }

    function removeSkill(skill) {
      skillsMap.delete(skill);
      renderSkills();
    }

    function updateSkillFrequency(skill, delta) {
      const current = skillsMap.get(skill) || 3;
      const newValue = Math.max(1, Math.min(10, current + delta));
      skillsMap.set(skill, newValue);
      renderSkills();
    }

    function renderSkills() {
      const container = document.getElementById('skillsList');
      if (skillsMap.size === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted2); font-size: 12px;">No skills added yet. Type and press Enter.</div>';
        return;
      }

      container.innerHTML = Array.from(skillsMap.entries()).map(([skill, freq]) => `
        <div class="jdm-skill-row">
          <div class="jdm-skill-name">${skill}</div>
          <div class="jdm-skill-stepper">
            <button class="jdm-stepper-btn" onclick="updateSkillFrequency('${skill}', -1)">−</button>
            <div class="jdm-stepper-value">${freq}</div>
            <button class="jdm-stepper-btn" onclick="updateSkillFrequency('${skill}', 1)">+</button>
          </div>
          <button class="jdm-skill-remove" onclick="removeSkill('${skill}')">×</button>
        </div>
      `).join('');
    }

    // ========================
    // STRICTNESS CONTROL
    // ========================
    function updateStrictnessValue(value) {
      document.getElementById('strictnessDisplay').textContent = value + '%';
    }

    // ========================
    // TEMPLATE DRAWER
    // ========================
    function openTemplateDrawer() {
      highlightedTemplate = selectedTemplate;
      document.getElementById('drawerOverlay').classList.add('active');
      document.getElementById('templateDrawer').classList.add('active');
      renderTemplatesGrid();
    }

    function closeTemplateDrawer() {
      document.getElementById('drawerOverlay').classList.remove('active');
      document.getElementById('templateDrawer').classList.remove('active');
    }

    function confirmTemplateSelection() {
      const template = TEMPLATES.find(t => t.id === highlightedTemplate) || TEMPLATES[0];
      if (!template) { closeTemplateDrawer(); return; }
      selectedTemplate = template.id;
      localStorage.setItem(getStorageKey('selected_template'), template.id);
      document.getElementById('selectedTemplateName').textContent = template.name;
      renderSelectedTemplatePreview(template.id);
      updateSidebar();
      markStepCompleted(4);
      closeTemplateDrawer();
      showToast(`Template selected: ${template.name}`, 'success');
      debugTemplateState();
    }

    // ========================
    // PHASED PROGRESS ANIMATION
    // ========================
    function showPhasedProgress() {
      const overlay = document.getElementById('progressOverlay');
      overlay.classList.add('active');
      
      const phases = [
        { duration: 800, name: 'Parsing Base Resume' },
        { duration: 1000, name: 'Understanding Job Description' },
        { duration: 900, name: 'Optimizing Keywords' },
        { duration: 1100, name: 'ATS Structuring' },
        { duration: 700, name: 'Finalizing' }
      ];

      let currentPhase = 0;
      let totalProgress = 0;

      function animatePhase() {
        if (currentPhase >= phases.length) {
          return Promise.resolve();
        }

        const phaseElement = document.querySelector(`.jdm-progress-phase[data-phase="${currentPhase + 1}"]`);
        phaseElement.classList.add('active');

        const phaseProgress = 100 / phases.length;
        const startProgress = totalProgress;
        const endProgress = totalProgress + phaseProgress;

        return new Promise(resolve => {
          const startTime = Date.now();
          const duration = phases[currentPhase].duration;

          function updateProgress() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentProgress = startProgress + (phaseProgress * progress);

            document.getElementById('progressBar').style.width = currentProgress + '%';
            document.getElementById('progressPercentage').textContent = Math.round(currentProgress) + '%';

            if (progress < 1) {
              requestAnimationFrame(updateProgress);
            } else {
              phaseElement.classList.remove('active');
              phaseElement.classList.add('completed');
              totalProgress = endProgress;
              currentPhase++;
              resolve();
            }
          }

          updateProgress();
        }).then(() => animatePhase());
      }

      return animatePhase();
    }

    function hidePhasedProgress() {
      const overlay = document.getElementById('progressOverlay');
      setTimeout(() => {
        overlay.classList.remove('active');
        // Reset phases
        document.querySelectorAll('.jdm-progress-phase').forEach(p => {
          p.classList.remove('active', 'completed');
        });
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressPercentage').textContent = '0%';
      }, 500);
    }

    // ========================
    // MAIN GENERATION HANDLER
    // ========================
    async function handleGenerate() {
      // Validation
      const companyName = document.getElementById('companyName').value.trim();
      const jobDescription = document.getElementById('jobDescription').value.trim();

      // Determine effective resume text — either file extraction OR manual paste
      const pasteText = document.getElementById('baseResumePaste').value.trim();
      const effectiveResumeText = baseResumeText || pasteText;

      // Check if we have resume data (either uploaded, extracted, pasted, or admin mode)
      if (inputMode === 'upload' && !effectiveResumeText) {
        showToast('Please upload a resume file or paste your resume text', 'error');
        goToStep(1);
        return;
      }

      if (inputMode === 'admin' && !adminCandidateData && !baseResumeText) {
        showToast('Admin data not loaded. Please wait or switch to upload mode.', 'error');
        goToStep(1);
        return;
      }

      if (!companyName || !jobDescription) {
        showToast('Please fill in company name and job description', 'error');
        goToStep(2);
        return;
      }

      markStepCompleted(2);
      markStepCompleted(3);
      markStepCompleted(5);

      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>⚙️ Generating...</span>';

      try {
        // Show phased progress
        showPhasedProgress();

        const strictness = document.getElementById('strictnessSlider').value;
        const skillsArray = Array.from(skillsMap.entries()).map(([skill, freq]) => 
          Array(freq).fill(skill)
        ).flat().join(', ');

        const response = await fetch('/.netlify/functions/generateResume', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            candidateId: currentCandidateId,
            companyName,
            jobDescription,
            targetMatchMode: 'manual',
            targetMatchValue: parseInt(strictness),
            mustIncludeSkills: skillsArray,
            templateId: selectedTemplate,
            baseResumeText: effectiveResumeText
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Generation failed');
        }

        // Wait for progress animation to complete
        await new Promise(resolve => setTimeout(resolve, 500));
        hidePhasedProgress();

        currentGeneration = data;
        displayResults(data);
        showToast('Resume generated successfully!', 'success');

      } catch (error) {
        hidePhasedProgress();
        showToast(`Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>🚀 Generate Matched Resume</span>';
      }
    }

    function displayResults(data) {
      const outputSection = document.getElementById('outputSection');
      const metricsGrid = document.getElementById('metricsGrid');

      metricsGrid.innerHTML = `
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">JD Match</div>
          <div class="jdm-metric-value">${data.metrics?.jdMatch || '—'}%</div>
        </div>
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">ATS Score</div>
          <div class="jdm-metric-value">${data.metrics?.atsFriendliness || '—'}%</div>
        </div>
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">HR Appeal</div>
          <div class="jdm-metric-value">${data.metrics?.hrCatchiness || '—'}%</div>
        </div>
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">Shortlist %</div>
          <div class="jdm-metric-value">${data.metrics?.chancesOfShortlisting || '—'}%</div>
        </div>
      `;

      outputSection.style.display = 'block';
      outputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ========================
    // QUICK PANELS
    // ========================
    function toggleQuickPanel(panelName) {
      const historyPanel = document.getElementById('historyQuickPanel');
      const settingsPanel = document.getElementById('settingsQuickPanel');

      if (panelName === 'history') {
        const isVisible = historyPanel.style.display !== 'none';
        historyPanel.style.display = isVisible ? 'none' : 'block';
        settingsPanel.style.display = 'none';
        if (!isVisible) renderHistory();
      } else {
        const isVisible = settingsPanel.style.display !== 'none';
        settingsPanel.style.display = isVisible ? 'none' : 'block';
        historyPanel.style.display = 'none';
        if (!isVisible) updateSettings();
      }
    }

    // ========================
    // UTILITY FUNCTIONS
    // ========================
    function getCandidateId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('cid') || sessionStorage.getItem('candidateId') || 'test_candidate';
    }

    function getStorageKey(type) {
      return `hr_${type}_${currentCandidateId}`;
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `jdm-toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function goBack() {
      window.location.href = `user.html?cid=${encodeURIComponent(currentCandidateId)}`;
    }

    function updateSidebar() {
      document.getElementById('sidebarTemplate').textContent = TEMPLATES.find(t => t.id === selectedTemplate)?.name || 'Template 01';
      const targetMode = document.querySelector('input[name="targetMode"]:checked').value;
      if (targetMode === 'manual') {
        const value = document.getElementById('targetSlider').value;
        document.getElementById('sidebarTarget').textContent = `Manual (${value}%)`;
      } else {
        document.getElementById('sidebarTarget').textContent = 'Auto (90–95%)';
      }
      const skills = document.getElementById('skillsInput').value;
      document.getElementById('sidebarSkills').textContent = skills ? skills.split(',').length + ' skills' : '–';
      document.getElementById('sidebarResume').textContent = baseResumeText ? 'Saved' : 'Not saved';
    }

    // ========================
    // PANEL SWITCHING
    // ========================
    function switchPanel(panelName) {
      document.querySelectorAll('.jdm-panel').forEach(pane => pane.classList.remove('active'));
      document.querySelectorAll('.jdm-nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(panelName).classList.add('active');
      event.target.classList.add('active');

      if (panelName === 'templates') renderTemplatesGrid();
      if (panelName === 'history') renderHistory();
      if (panelName === 'settings') updateSettings();
    }

    function switchResumeTab(tabName) {
      document.querySelectorAll('.jdm-resume-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.jdm-resume-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName === 'paste' ? 'pasteTab' : 'uploadTab').classList.add('active');
      event.target.classList.add('active');
    }

    // ========================
    // SLIDER CONTROLS
    // ========================
    function toggleSlider() {
      const isManual = document.getElementById('manualMode').checked;
      document.getElementById('sliderGroup').classList.toggle('active', isManual);
      updateSidebar();
    }

    function updateSliderValue(value) {
      value = Math.max(5, Math.min(100, parseInt(value)));
      document.getElementById('targetSlider').value = value;
      document.getElementById('targetInput').value = value;
      document.getElementById('sliderDisplay').textContent = value + '%';
      updateSidebar();
    }

    // ========================
    // BASE RESUME
    // ========================

    function saveBaseResume() {
      const text = document.getElementById('baseResumePaste').value.trim();
      if (!text) {
        showToast('Please paste a resume first', 'error');
        return;
      }
      baseResumeText = text;
      localStorage.setItem(getStorageKey('base_resume'), text);
      showToast('Base resume saved!', 'success');
      updateSidebar();
    }

    function clearBaseResume() {
      baseResumeText = '';
      document.getElementById('baseResumePaste').value = '';
      localStorage.removeItem(getStorageKey('base_resume'));
      showToast('Base resume cleared', 'success');
      updateSidebar();
    }

    // ========================
    // TEMPLATES
    // ========================
    function renderSelectedTemplatePreview(tplId) {
      const el = document.getElementById('selectedTemplatePreview');
      console.debug('[tpl] preview target found?', !!el, el);
      if (el) console.debug('[tpl] selectedTemplatePreview rect:', el.getBoundingClientRect());
      if (!el) return;
      const tpl = TEMPLATES.find(t => t.id === (tplId || selectedTemplate)) || TEMPLATES[0];
      if (!tpl) return;
      const _w1s = ['w-80','w-70','w-60','w-90','w-80','w-70','w-50','w-90','w-80','w-60','w-70','w-80'];
      const _idx = TEMPLATES.indexOf(tpl);
      const _w1 = _w1s[_idx] || 'w-80';
      el.innerHTML = `<div class="tpl-thumb-fallback fill" role="img" aria-label="${tpl.name} preview"><div class="tpl-thumb-lines"><span class="line ${_w1}"></span><span class="line w-60"></span><span class="line w-90"></span><span class="line w-70"></span><span class="line w-50"></span></div><div class="tpl-thumb-tag">${tpl.name}</div></div>`;
    }

    function debugTemplateState() {
      console.debug('[tpl] selectedTemplate:', selectedTemplate, '| highlightedTemplate:', highlightedTemplate, '| TEMPLATES.length:', TEMPLATES.length, '| tpl found:', !!(TEMPLATES.find(t => t.id === selectedTemplate)));
    }

    function renderTemplatesGrid() {
      const grid = document.getElementById('templatesGrid');
      grid.innerHTML = TEMPLATES.map(template => `
        <div class="jdm-template-card ${highlightedTemplate === template.id ? 'selected' : ''}" onclick="selectTemplate('${template.id}')">
          <div class="jdm-template-checkmark">✔</div>
          <div class="jdm-template-preview">
            <div class="tpl-thumb-fallback" role="img" aria-label="${template.name} preview">
              <div class="tpl-thumb-lines">
                <span class="line w-80"></span>
                <span class="line w-60"></span>
                <span class="line w-90"></span>
                <span class="line w-70"></span>
                <span class="line w-50"></span>
              </div>
              <div class="tpl-thumb-tag">${template.name}</div>
            </div>
          </div>
          <div class="jdm-template-name">${template.name}</div>
          <span class="jdm-template-tag">${template.tag}</span>
          <button type="button" class="jdm-template-select-btn">${highlightedTemplate === template.id ? '✔ Selected' : 'Select'}</button>
        </div>
      `).join('');
    }

    function filterTemplates() {
      const search = document.getElementById('templateSearch').value.toLowerCase();
      const sort = document.getElementById('templateSort').value;
      const grid = document.getElementById('templatesGrid');
      
      let filtered = TEMPLATES.filter(t => t.name.toLowerCase().includes(search) || t.tag.toLowerCase().includes(search));
      if (sort !== 'default') {
        filtered = filtered.filter(t => t.tag.toLowerCase() === sort.toLowerCase());
      }

      grid.innerHTML = filtered.map(template => `
        <div class="jdm-template-card ${highlightedTemplate === template.id ? 'selected' : ''}" onclick="selectTemplate('${template.id}')">
          <div class="jdm-template-checkmark">✔</div>
          <div class="jdm-template-preview">
            <div class="tpl-thumb-fallback" role="img" aria-label="${template.name} preview">
              <div class="tpl-thumb-lines">
                <span class="line w-80"></span>
                <span class="line w-60"></span>
                <span class="line w-90"></span>
                <span class="line w-70"></span>
                <span class="line w-50"></span>
              </div>
              <div class="tpl-thumb-tag">${template.name}</div>
            </div>
          </div>
          <div class="jdm-template-name">${template.name}</div>
          <span class="jdm-template-tag">${template.tag}</span>
          <button type="button" class="jdm-template-select-btn">${highlightedTemplate === template.id ? '✔ Selected' : 'Select'}</button>
        </div>
      `).join('');
    }

    function selectTemplate(templateId) {
      const found = TEMPLATES.find(t => t.id === templateId) || TEMPLATES[0];
      if (!found) return;
      highlightedTemplate = found.id;
      renderSelectedTemplatePreview(found.id);
      renderTemplatesGrid();
      showToast(`${found.name} selected!`, 'success');
    }

    // ========================
    // FORM SUBMISSION
    // ========================
    async function handleGenerateSubmit(event) {
      event.preventDefault();

      const companyName = document.getElementById('companyName').value.trim();
      const jobDescription = document.getElementById('jobDescription').value.trim();
      const skillsRaw = document.getElementById('skillsInput').value.trim();
      const targetMode = document.querySelector('input[name="targetMode"]:checked').value;
      const targetValue = targetMode === 'manual' ? parseInt(document.getElementById('targetSlider').value) : null;

      if (!companyName || !jobDescription) {
        showToast('Please fill company name and job description', 'error');
        return;
      }

      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'Generating…';

      try {
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const functionUrl = isLocal
          ? 'https://extraordinary-salamander-7c80d4.netlify.app/.netlify/functions/generateResume'
          : '/.netlify/functions/generateResume';

        const response = await fetch(functionUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            candidateId: currentCandidateId,
            companyName,
            jobDescription,
            targetMatchMode: targetMode,
            targetMatchValue: targetValue,
            mustIncludeSkills: skillsRaw,
            templateId: selectedTemplate,
            baseResumeText: baseResumeText
          })
        });

        const responseText = await response.text();
        let data = null;
        try {
          data = JSON.parse(responseText);
        } catch {
          throw new Error('Invalid server response');
        }

        if (!response.ok || (data && data.ok === false)) {
          throw new Error(data?.error || 'Generation failed');
        }

        currentGeneration = data;
        displayResults(data);
        showToast('Resume generated!', 'success');
        document.getElementById('outputActionsCard').style.display = 'block';

      } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'Generate Resume';
      }
    }

    function displayResults(data) {
      const results = document.getElementById('results');
      const metricsGrid = document.getElementById('metricsGrid');

      metricsGrid.innerHTML = `
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">JD Match</div>
          <div class="jdm-metric-value">${data.metrics?.jdMatch || '–'}%</div>
        </div>
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">ATS Friendliness</div>
          <div class="jdm-metric-value">${data.metrics?.atsFriendliness || '–'}%</div>
        </div>
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">HR Catchiness</div>
          <div class="jdm-metric-value">${data.metrics?.hrCatchiness || '–'}%</div>
        </div>
        <div class="jdm-metric-card">
          <div class="jdm-metric-label">Shortlist Chance</div>
          <div class="jdm-metric-value">${data.metrics?.chancesOfShortlisting || '–'}%</div>
        </div>
      `;

      results.classList.add('active');
    }

    function previewResume() {
      if (!currentGeneration) return;
      document.getElementById('previewIframe').srcdoc = currentGeneration.resumeHtml;
      document.getElementById('previewModal').style.display = 'block';
    }

    // ========================
    // DOWNLOADS
    // ========================
    function downloadPDF() {
      if (!currentGeneration) return;
      const opt = {
        margin: 10,
        filename: currentGeneration.filename,
        image: {type: 'jpeg', quality: 0.98},
        jsPDF: {orientation: 'portrait', unit: 'mm', format: 'a4'}
      };
      const wrapper = document.createElement('div');
      wrapper.innerHTML = currentGeneration.resumeHtml;
      html2pdf().set(opt).from(wrapper).save();
      showToast('PDF downloaded!', 'success');
    }

    function downloadDOC() {
      if (!currentGeneration) return;
      const doc = `<html><head><meta charset='utf-8'></head><body>${currentGeneration.resumeHtml}</body></html>`;
      const blob = new Blob([doc], {type: 'application/msword'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = currentGeneration.filename.replace('.pdf', '.doc');
      link.click();
      showToast('DOC downloaded!', 'success');
    }

    function downloadHTML() {
      if (!currentGeneration) return;
      const link = document.createElement('a');
      link.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(currentGeneration.resumeHtml);
      link.download = currentGeneration.filename.replace('.pdf', '.html');
      link.click();
      showToast('HTML downloaded!', 'success');
    }

    // ========================
    // HISTORY
    // ========================
    function saveToHistory() {
      if (!currentGeneration) return;
      const history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');
      history.unshift({
        id: Date.now().toString(),
        createdAt: new Date().toISOString(),
        companyName: document.getElementById('companyName').value,
        templateId: selectedTemplate,
        targetMatch: currentGeneration.targetMatch,
        mustIncludeSkills: document.getElementById('skillsInput').value,
        shortJDSnippet: document.getElementById('jobDescription').value.substring(0, 100),
        resumeHtml: currentGeneration.resumeHtml,
        metrics: currentGeneration.metrics,
        filename: currentGeneration.filename
      });
      localStorage.setItem(getStorageKey('resume_history'), JSON.stringify(history));
      showToast('Saved to history!', 'success');
    }

    function renderHistory() {
      const container = document.getElementById('historyContainer');
      let history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');

      // Auto-delete >15 days
      const fifteenDaysAgo = Date.now() - (15 * 24 * 60 * 60 * 1000);
      history = history.filter(item => new Date(item.createdAt).getTime() > fifteenDaysAgo);
      localStorage.setItem(getStorageKey('resume_history'), JSON.stringify(history));

      if (history.length === 0) {
        container.innerHTML = '<div class="jdm-history-empty">No history yet. Generate and save a resume.</div>';
        return;
      }

      container.innerHTML = `<div class="jdm-history-list">${history.map((item, idx) => `
        <div class="jdm-history-item">
          <div class="jdm-history-header" onclick="toggleHistoryItem(${idx})">
            <div>
              <div class="jdm-history-title">${item.companyName}</div>
              <div class="jdm-history-meta">${new Date(item.createdAt).toLocaleDateString()} • ${TEMPLATES.find(t => t.id === item.templateId)?.name || 'Template'}</div>
            </div>
            <div class="jdm-history-expand-icon">▼</div>
          </div>
          <div class="jdm-history-content" id="hist-${idx}">
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">${item.shortJDSnippet}...</div>
            <div class="jdm-history-metrics">
              <div class="jdm-history-metric"><span class="jdm-history-metric-label">JD Match</span><span class="jdm-history-metric-value">${item.metrics?.jdMatch || '–'}%</span></div>
              <div class="jdm-history-metric"><span class="jdm-history-metric-label">ATS</span><span class="jdm-history-metric-value">${item.metrics?.atsFriendliness || '–'}%</span></div>
              <div class="jdm-history-metric"><span class="jdm-history-metric-label">HR</span><span class="jdm-history-metric-value">${item.metrics?.hrCatchiness || '–'}%</span></div>
            </div>
            <div class="jdm-history-actions">
              <button class="jdm-action-btn view" onclick="viewHistory(${idx})">View</button>
              <button class="jdm-action-btn download" onclick="downloadHistoryHTML(${idx})">HTML</button>
              <button class="jdm-action-btn download" onclick="downloadHistoryPDF(${idx})">PDF</button>
              <button class="jdm-action-btn download" onclick="downloadHistoryDOC(${idx})">DOC</button>
              <button class="jdm-action-btn delete" onclick="deleteHistory(${idx})">Delete</button>
            </div>
          </div>
        </div>
      `).join('')}</div>`;
    }

    function toggleHistoryItem(idx) {
      const item = document.getElementById(`hist-${idx}`).parentElement;
      item.classList.toggle('expanded');
    }

    function viewHistory(idx) {
      const history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');
      window.open(`data:text/html;charset=utf-8,${encodeURIComponent(history[idx].resumeHtml)}`, '_blank');
    }

    function downloadHistoryHTML(idx) {
      const history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');
      const link = document.createElement('a');
      link.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(history[idx].resumeHtml);
      link.download = history[idx].filename.replace('.pdf', '.html');
      link.click();
    }

    function downloadHistoryPDF(idx) {
      const history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');
      const opt = {margin: 10, filename: history[idx].filename, image: {type: 'jpeg', quality: 0.98}, jsPDF: {orientation: 'portrait', unit: 'mm', format: 'a4'}};
      const wrapper = document.createElement('div');
      wrapper.innerHTML = history[idx].resumeHtml;
      html2pdf().set(opt).from(wrapper).save();
    }

    function downloadHistoryDOC(idx) {
      const history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');
      const blob = new Blob([`<html><head><meta charset='utf-8'></head><body>${history[idx].resumeHtml}</body></html>`], {type: 'application/msword'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = history[idx].filename.replace('.pdf', '.doc');
      link.click();
    }

    function deleteHistory(idx) {
      if (!confirm('Delete this resume?')) return;
      let history = JSON.parse(localStorage.getItem(getStorageKey('resume_history')) || '[]');
      history.splice(idx, 1);
      localStorage.setItem(getStorageKey('resume_history'), JSON.stringify(history));
      renderHistory();
      showToast('Deleted', 'success');
    }

    // ========================
    // SETTINGS
    // ========================
    function updateSettings() {
      const info = baseResumeText ? `Saved (${baseResumeText.length} chars)` : 'Not saved';
      document.getElementById('baseResumeInfo').textContent = info;
      document.getElementById('currentTemplateInfo').textContent = TEMPLATES.find(t => t.id === selectedTemplate)?.name || 'Template 01';
    }

    function clearAllData() {
      if (!confirm('Clear all data? Cannot undo.')) return;
      localStorage.removeItem(getStorageKey('base_resume'));
      localStorage.removeItem(getStorageKey('selected_template'));
      localStorage.removeItem(getStorageKey('resume_history'));
      baseResumeText = '';
      selectedTemplate = TEMPLATES[0]?.id || 't02';
      highlightedTemplate = selectedTemplate;
      document.getElementById('baseResumePaste').value = '';
      document.getElementById('skillsInput').value = '';
      renderTemplatesGrid();
      renderSelectedTemplatePreview();
      updateSettings();
      updateSidebar();
      showToast('All data cleared', 'success');
    }

    // ========================
    // KEYWORD BLACKLIST
    // ========================
    let blacklistWords = [];

    function handleBlacklistKeypress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const val = event.target.value.trim();
        if (val && !blacklistWords.includes(val.toLowerCase())) {
          blacklistWords.push(val.toLowerCase());
          event.target.value = '';
          renderBlacklist();
          autoSave();
          showToast(`"${val}" added to blacklist`, 'success');
        }
      }
    }

    function removeBlacklistWord(word) {
      blacklistWords = blacklistWords.filter(w => w !== word);
      renderBlacklist();
      autoSave();
    }

    function renderBlacklist() {
      const container = document.getElementById('blacklistTags');
      if (blacklistWords.length === 0) {
        container.innerHTML = '<span style="font-size:11px;color:var(--muted2);">No blocked words yet</span>';
        return;
      }
      container.innerHTML = blacklistWords.map(w => `
        <div class="jdm-blacklist-tag">${w}<span onclick="removeBlacklistWord('${w}')">&times;</span></div>
      `).join('');
    }

    // ========================
    // TONE CONTROL
    // ========================
    let selectedTone = 'conservative';
    const toneDescriptions = {
      conservative: 'Preserves your original writing style with minimal keyword additions.',
      balanced: 'Rewrites bullet points for clarity and adds missing JD keywords naturally.',
      aggressive: 'Fully optimizes every sentence for ATS and keyword density. Maximum impact.'
    };

    function setTone(tone) {
      selectedTone = tone;
      document.querySelectorAll('.jdm-tone-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tone' + tone.charAt(0).toUpperCase() + tone.slice(1)).classList.add('active');
      document.getElementById('toneDescription').textContent = toneDescriptions[tone];
      autoSave();
    }

    // ========================
    // KEYWORD GAP ANALYSIS
    // ========================
    function analyzeKeywordGap() {
      const jd = document.getElementById('jobDescription').value.toLowerCase();
      const resume = (baseResumeText || document.getElementById('baseResumePaste').value || '').toLowerCase();
      const container = document.getElementById('gapAnalysisContent');

      if (!jd || jd.length < 50) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted2);font-size:12px;">Paste a Job Description to see keyword gaps</div>';
        return;
      }

      // Extract keywords from JD (words 4+ chars, not common stop words)
      const stopWords = new Set(['with','from','that','this','have','will','your','been','they','their','which','would','about','into','through','during','before','after','above','below','between','each','under','further','then','once','here','there','when','where','also','more','most','other','than','just','because','while','since','although','whether','even','along','across','within','without','should','could','would','these','those','being','having','doing','making','taking','using','going','coming', 'must', 'shall']);
      
      const jdWords = [...new Set(jd.match(/\b[a-z][a-z+#.]{2,}\b/g) || [])]
        .filter(w => !stopWords.has(w) && w.length >= 3)
        .slice(0, 30);

      const missing = jdWords.filter(w => !resume.includes(w));
      const present = jdWords.filter(w => resume.includes(w));
      const score = Math.round((present.length / Math.max(jdWords.length, 1)) * 100);

      container.innerHTML = `
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted2);margin-bottom:4px;">
          <span>Resume keyword coverage</span><span style="color:var(--accentA);font-weight:700;">${score}%</span>
        </div>
        <div class="jdm-gap-score-bar"><div class="jdm-gap-score-fill" style="width:${score}%"></div></div>
        ${missing.length > 0 ? `
          <div style="font-size:11px;font-weight:700;color:#f87171;margin:10px 0 6px;">&#10005; Missing (click to add)</div>
          <div class="jdm-gap-list">${missing.map(w => `<span class="jdm-gap-tag missing inject" onclick="injectKeyword('${w}')" title="Add to Must Include Skills">${w} +</span>`).join('')}</div>
        ` : ''}
        ${present.length > 0 ? `
          <div style="font-size:11px;font-weight:700;color:#4ade80;margin:10px 0 6px;">&#10003; Already present</div>
          <div class="jdm-gap-list">${present.slice(0, 15).map(w => `<span class="jdm-gap-tag present">${w}</span>`).join('')}</div>
        ` : ''}
      `;
    }

    function injectKeyword(word) {
      const input = document.getElementById('skillsInput');
      const existing = input.value.trim();
      input.value = existing ? existing + ', ' + word : word;
      showToast(`"${word}" added to Must Include Skills`, 'success');
      analyzeKeywordGap();
    }

    // ========================
    // COVER LETTER GENERATOR
    // ========================
    async function generateCoverLetter() {
      const company = document.getElementById('companyName').value.trim();
      const jd = document.getElementById('jobDescription').value.trim();
      const tone = document.getElementById('coverTone').value;
      const resume = baseResumeText || document.getElementById('baseResumePaste').value || '';
      const output = document.getElementById('coverLetterOutput');
      const actions = document.getElementById('coverLetterActions');

      if (!company || !jd) {
        showToast('Please fill in Company Name and Job Description first', 'error');
        return;
      }

      output.classList.add('active');
      output.textContent = 'Generating cover letter...';
      actions.style.display = 'none';

      // Build a client-side cover letter (template-based since we may not have serverless for this)
      const name = (adminCandidateData?.personalInfo?.fullName) || 'Hiring Manager';
      const skills = document.getElementById('skillsInput').value || 'relevant skills';

      const tones = {
        professional: `Dear Hiring Manager,\n\nI am writing to express my strong interest in the position at ${company}. With my background and experience, I am confident I can make a significant contribution to your team.\n\nHaving reviewed the job description carefully, I am excited about the opportunity to bring my expertise in ${skills} to ${company}. My experience aligns well with the requirements outlined, and I am eager to contribute to your organization's goals.\n\nI would welcome the opportunity to discuss how my background, skills, and accomplishments would benefit ${company}. Thank you for your time and consideration.\n\nSincerely,\n[Your Name]`,
        enthusiastic: `Dear ${company} Team,\n\nI'm thrilled to apply for this exciting opportunity at ${company}! Your mission and the challenges described in this role align perfectly with my passion and expertise.\n\nI bring hands-on experience with ${skills} and a track record of delivering impactful results. I am especially excited about the chance to work with your team and help drive growth.\n\nI'd love to chat about how I can bring energy and results to ${company}. Looking forward to connecting!\n\nBest,\n[Your Name]`,
        concise: `Dear Hiring Manager,\n\nI'm applying for the role at ${company}. My expertise in ${skills} directly matches your requirements.\n\nKey strengths: strong technical background, proven delivery track record, team collaboration.\n\nAvailable for interview at your earliest convenience.\n\nBest regards,\n[Your Name]`
      };

      await new Promise(r => setTimeout(r, 800)); // Simulate generation delay
      output.textContent = tones[tone] || tones.professional;
      actions.style.display = 'flex';
      showToast('Cover letter generated!', 'success');
    }

    function copyCoverLetter() {
      const text = document.getElementById('coverLetterOutput').textContent;
      navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard!', 'success'));
    }

    function downloadCoverLetter() {
      const text = document.getElementById('coverLetterOutput').textContent;
      const company = document.getElementById('companyName').value || 'company';
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cover-letter-${company.replace(/\s+/g,'-').toLowerCase()}.txt`;
      a.click();
      showToast('Cover letter downloaded!', 'success');
    }

    // ========================
    // BEFORE vs AFTER DIFF VIEW
    // ========================
    function sanitizeDiffText(str) {
      // Strip control characters and known mojibake ranges, keep all normal text
      return str.replace(/[\u0000-\u001F\u007F-\u009F]/g, '').replace(/≡ƒ[^ -~]/g, '');
    }

    function toggleDiffView() {
      const container = document.getElementById('diffContainer');
      const btn = document.getElementById('diffToggleBtn');
      const isActive = container.classList.toggle('active');
      btn.innerHTML = isActive ? '&#x274C; Hide Diff View' : '&#x1F504; Show Diff View';

      if (isActive) {
        const original = sanitizeDiffText(baseResumeText || document.getElementById('baseResumePaste').value || 'No original resume uploaded yet.');
        const generated = currentGeneration?.resumeHtml 
          ? sanitizeDiffText(new DOMParser().parseFromString(currentGeneration.resumeHtml, 'text/html').body.innerText)
          : 'Generate a resume first to see the comparison.';
        document.getElementById('diffOriginal').textContent = original;
        document.getElementById('diffGenerated').textContent = generated;
      }
    }

    // ========================
    // JOB TRACKER
    // ========================
    let jobApplications = [];

    function toggleTrackerForm() {
      const form = document.getElementById('trackerForm');
      form.classList.toggle('active');
    }

    function addTrackerEntry() {
      const company = document.getElementById('trackerCompany').value.trim();
      const role = document.getElementById('trackerRole').value.trim();
      const status = document.getElementById('trackerStatus').value;

      if (!company || !role) { showToast('Fill in company and role', 'error'); return; }

      jobApplications.unshift({ id: Date.now(), company, role, status, date: new Date().toLocaleDateString() });
      localStorage.setItem(getStorageKey('job_tracker'), JSON.stringify(jobApplications));

      document.getElementById('trackerCompany').value = '';
      document.getElementById('trackerRole').value = '';
      document.getElementById('trackerStatus').value = 'applied';
      toggleTrackerForm();
      renderTracker();
      showToast('Application tracked!', 'success');
    }

    function updateTrackerStatus(id, status) {
      const app = jobApplications.find(a => a.id === id);
      if (app) {
        app.status = status;
        localStorage.setItem(getStorageKey('job_tracker'), JSON.stringify(jobApplications));
        renderTracker();
      }
    }

    function deleteTrackerEntry(id) {
      if (!confirm('Remove this application?')) return;
      jobApplications = jobApplications.filter(a => a.id !== id);
      localStorage.setItem(getStorageKey('job_tracker'), JSON.stringify(jobApplications));
      renderTracker();
    }

    function renderTracker() {
      const container = document.getElementById('trackerList');
      if (jobApplications.length === 0) {
        container.innerHTML = '<div class="jdm-tracker-empty">No applications tracked yet.</div>';
        return;
      }
      container.innerHTML = jobApplications.map(app => `
        <div class="jdm-tracker-item">
          <div>
            <div class="jdm-tracker-company">${app.company}</div>
            <div class="jdm-tracker-role">${app.role} &bull; ${app.date}</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <select class="jdm-status-badge ${app.status}" onchange="updateTrackerStatus(${app.id}, this.value)" style="border:none;background:transparent;cursor:pointer;font-size:10px;font-weight:700;color:inherit;">
              <option value="applied" ${app.status==='applied'?'selected':''}>APPLIED</option>
              <option value="interview" ${app.status==='interview'?'selected':''}>INTERVIEW</option>
              <option value="offer" ${app.status==='offer'?'selected':''}>OFFER</option>
              <option value="rejected" ${app.status==='rejected'?'selected':''}>REJECTED</option>
            </select>
            <button onclick="deleteTrackerEntry(${app.id})" style="background:none;border:none;color:var(--muted2);cursor:pointer;font-size:14px;" title="Delete">&times;</button>
          </div>
        </div>
      `).join('');
    }

    // ========================
    // AUTO-SAVE
    // ========================
    let autoSaveTimer = null;

    function autoSave() {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        const data = {
          companyName: document.getElementById('companyName')?.value || '',
          jobDescription: document.getElementById('jobDescription')?.value || '',
          skillsInput: document.getElementById('skillsInput')?.value || '',
          blacklist: blacklistWords,
          tone: selectedTone,
          timestamp: Date.now()
        };
        localStorage.setItem(getStorageKey('autosave'), JSON.stringify(data));
        const indicator = document.getElementById('autosaveIndicator');
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
      }, 1500);
    }

    function restoreAutoSave() {
      const saved = localStorage.getItem(getStorageKey('autosave'));
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        const ageMinutes = (Date.now() - data.timestamp) / 60000;
        if (ageMinutes > 60) return; // Only restore if saved within 1 hour
        if (data.companyName) document.getElementById('companyName').value = data.companyName;
        if (data.jobDescription) document.getElementById('jobDescription').value = data.jobDescription;
        if (data.skillsInput) document.getElementById('skillsInput').value = data.skillsInput;
        if (data.blacklist) { blacklistWords = data.blacklist; renderBlacklist(); }
        if (data.tone) setTone(data.tone);
        if (data.companyName || data.jobDescription) {
          showToast('Draft restored from auto-save', 'info');
          analyzeKeywordGap();
        }
      } catch(e) {}
    }

    // ========================
    // KEYBOARD SHORTCUTS
    // ========================
    function openShortcuts() {
      document.getElementById('shortcutsModal').classList.add('active');
    }

    function closeShortcuts() {
      document.getElementById('shortcutsModal').classList.remove('active');
    }

    function openHowItWorks() {
      document.getElementById('howItWorksModal').classList.add('active');
    }

    function closeHowItWorks() {
      document.getElementById('howItWorksModal').classList.remove('active');
    }

    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Don't fire in inputs/textareas unless it's Ctrl+something
        const inInput = ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName);
        
        if (e.key === '?' && !inInput) { openShortcuts(); return; }
        if (e.key === 'Escape') { closeShortcuts(); closeHowItWorks(); return; }
        if (!e.ctrlKey) return;

        switch(e.key.toLowerCase()) {
          case 'g':
            e.preventDefault();
            handleGenerate();
            break;
          case 's':
            e.preventDefault();
            saveDraft();
            showToast('Draft saved!', 'success');
            break;
          case 't':
            e.preventDefault();
            openTemplateDrawer();
            break;
          case 'p':
            e.preventDefault();
            if (currentGeneration) previewResume();
            break;
        }
        if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'x') {
          e.preventDefault();
          clearAllData();
        }
      });
    }

    // ========================
    // AUTO-ANALYZE ON JD CHANGE
    // ========================
    function initJDAutoAnalyze() {
      const jdInput = document.getElementById('jobDescription');
      if (!jdInput) return;
      let jdTimer = null;
      jdInput.addEventListener('input', () => {
        autoSave();
        clearTimeout(jdTimer);
        jdTimer = setTimeout(analyzeKeywordGap, 800);
      });
      document.getElementById('companyName')?.addEventListener('input', autoSave);
      document.getElementById('skillsInput')?.addEventListener('input', autoSave);
    }

    // ========================
    // INIT
    // ========================
    document.addEventListener('DOMContentLoaded', () => {
      currentCandidateId = getCandidateId();
      baseResumeText = localStorage.getItem(getStorageKey('base_resume')) || '';
      const _storedTplRaw = localStorage.getItem(getStorageKey('selected_template'));
      let _migratedTpl = _storedTplRaw;
      // Migration: old IDs (template_01..template_12) → new IDs (t01..t12)
      if (_storedTplRaw && _storedTplRaw.startsWith('template_')) {
        const _num = _storedTplRaw.replace('template_', '');
        _migratedTpl = 't' + _num.padStart(2, '0');
        localStorage.setItem(getStorageKey('selected_template'), _migratedTpl);
      }
      selectedTemplate = (_migratedTpl && TEMPLATES.find(t => t.id === _migratedTpl)) ? _migratedTpl : (TEMPLATES[0]?.id || 't02');
      highlightedTemplate = selectedTemplate;
      jobApplications = JSON.parse(localStorage.getItem(getStorageKey('job_tracker')) || '[]');

      // Initialize new features
      initDragDrop();
      renderSkills();
      renderTemplatesGrid();
      updateWizardUI();
      renderBlacklist();
      renderTracker();
      initKeyboardShortcuts();
      initJDAutoAnalyze();
      restoreAutoSave();

      // Update template preview
      const template = TEMPLATES.find(t => t.id === selectedTemplate) || TEMPLATES[0];
      if (template) {
        selectedTemplate = template.id;
        highlightedTemplate = template.id;
        document.getElementById('selectedTemplateName').textContent = template.name;
        renderSelectedTemplatePreview(selectedTemplate);
        debugTemplateState();
      }

      // Restore base resume if saved
      if (baseResumeText) {
        document.getElementById('baseResumePaste').value = baseResumeText;
        markStepCompleted(1);
      }

      // Legacy sidebar update (if elements exist)
      if (document.getElementById('sidebarTemplate')) {
        updateSidebar();
      }

      // Close preview modal on backdrop click
      const previewModal = document.getElementById('previewModal');
      if (previewModal) {
        previewModal.addEventListener('click', (e) => {
          if (e.target.id === 'previewModal') {
            e.target.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>
</html>