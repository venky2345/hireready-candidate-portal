<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Assistant - HireReady Services</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg0: #07060A;
      --bg1: #0B0A12;
      --panel: rgba(20, 18, 28, 0.55);
      --panel2: rgba(16, 14, 22, 0.6);
      --border: rgba(255, 255, 255, 0.08);
      --border2: rgba(155, 130, 255, 0.22);
      --text: #F3F1FF;
      --muted: rgba(243, 241, 255, 0.72);
      --muted2: rgba(243, 241, 255, 0.54);
      --accentA: #B69CFF;
      --accentB: #6DA9FF;
      --success: #B69CFF;
      --warn: #FFCF5A;
      --danger: #B69CFF;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.55);
      --lime: #F6E05E;
      --lime-2: #FFE578;
      --lime-soft: rgba(246, 224, 94, 0.14);
      --lime-soft2: rgba(246, 224, 94, 0.22);
      --lime-border: rgba(246, 224, 94, 0.35);
      --lime-glow: 0 0 0 1px rgba(246, 224, 94, 0.18), 0 18px 46px rgba(246, 224, 94, 0.10);
      --radius: 18px;
      --sidebar-width: 280px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 50%, #1a1420 100%);
      color: var(--text);
      line-height: 1.6;
      position: relative;
      overflow-x: hidden;
    }

    .topbar {
      position: sticky;
      top: 0;
      height: 68px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      z-index: 40;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(14px);
    }

    .topbar-left { flex: 0 0 auto; display: flex; align-items: center; gap: 16px; }
    .topbar-center { flex: 1; display: flex; align-items: center; justify-content: center; gap: 16px; }
    .topbar-right { flex: 0 0 auto; display: flex; align-items: center; gap: 16px; }

    .topbar a {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .topbar a:hover { color: var(--accentA); }

    .ico-tile {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: rgba(182, 156, 255, 0.10);
      border: 1px solid rgba(182, 156, 255, 0.22);
      color: rgba(182, 156, 255, 0.92);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      flex: 0 0 42px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .ico-tile svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 1.9; stroke-linecap: round; stroke-linejoin: round; }
    .ico-tile.sm { width: 36px; height: 36px; border-radius: 12px; flex-basis: 36px; }
    .ico-tile.sm svg { width: 18px; height: 18px; }

    .layout {
      position: relative;
      z-index: 1;
      display: flex;
      min-height: calc(100vh - 68px);
    }

    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .card {
      background: linear-gradient(135deg, rgba(31, 27, 46, 0.5) 0%, rgba(20, 18, 28, 0.6) 100%);
      border: 1px solid rgba(182, 156, 255, 0.12);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }

    .card-title {
      font-size: 16px;
      font-weight: 650;
      color: var(--text);
      margin-bottom: 18px;
    }

    .form-group { margin-bottom: 18px; }
    .form-label { font-size: 14px; font-weight: 650; color: rgba(243,241,255,0.88); margin-bottom: 8px; display: block; }
    .form-input, .form-textarea { width: 100%; padding: 12px 14px; background: rgba(0,0,0,0.25); border: 1px solid rgba(182,156,255,0.14); border-radius: 10px; color: var(--text); font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: rgba(182,156,255,0.4); }
    .form-hint { font-size: 12px; color: rgba(243,241,255,0.54); margin-top: 6px; display: block; }

    .btn {
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: var(--accentA); color: var(--bg0); }
    .btn-primary:hover { background: rgba(182,156,255,0.92); }
    .btn-secondary { background: rgba(182,156,255,0.1); color: var(--text); border: 1px solid rgba(182,156,255,0.22); }
    .btn-secondary:hover { background: rgba(182,156,255,0.18); }
    .btn-success { background: var(--success); color: var(--bg0); }

    .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }

    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 100; display: flex; flex-direction: column; gap: 12px; }
    .toast { padding: 14px 18px; border-radius: 10px; background: rgba(0,0,0,0.8); color: var(--text); font-size: 14px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease;}

    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .page-header { margin-bottom: 24px; }
    .page-title { font-size: 28px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .page-subtitle { font-size: 16px; color: rgba(243,241,255,0.72); }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="topbar">
    <div class="topbar-left">
      <a href="#" onclick="goBack(event)">
        <span class="ico-tile sm" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/><path d="M9 12h12"/></svg></span>Back
      </a>
    </div>
    <div class="topbar-center">
      <div style="font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
        <span class="ico-tile sm"><svg viewBox="0 0 24 24"><path d="M12 2l1.2 4.1L17 7.3l-3.8 1.2L12 12l-1.2-3.5L7 7.3l3.8-1.2z"/><path d="M19 11l.8 2.7L22 14.5l-2.2.8L19 18l-.8-2.7-2.2-.8 2.2-.8z"/><path d="M6 13l.7 2.3L9 16l-2.3.7L6 19l-.7-2.3L3 16l2.3-.7z"/></svg></span>
        Live Assistant
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-primary" onclick="saveService()" style="display: flex; align-items: center; gap: 8px;">
        <span class="ico-tile sm" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg></span>Save
      </button>
    </div>
  </div>

  <!-- Access Denied UI -->
  <div id="accessDeniedUI" style="display: none; min-height: calc(100vh - 68px); align-items: center; justify-content: center; padding: 24px; background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);">
    <div style="text-align: center; max-width: 480px;">
      <div style="display: flex; justify-content: center; margin-bottom: 24px;">
        <span class="ico-tile" aria-hidden="true"><svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V8a5 5 0 0 1 10 0v3"/></svg></span>
      </div>
      <h2 style="font-size: 28px; font-weight: 700; color: var(--text); margin-bottom: 12px;">Access Denied</h2>
      <p style="font-size: 16px; color: rgba(243, 241, 255, 0.72); margin-bottom: 32px;">This service is currently disabled for this candidate. Please contact your administrator to enable it.</p>
      <button class="btn btn-primary" onclick="goBack(event)" style="display: inline-flex; align-items: center; gap: 8px;">
        <span class="ico-tile sm" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/><path d="M9 12h12"/></svg></span>
        Back to Services
      </button>
    </div>
  </div>

  <!-- Subscription Expired Overlay -->
  <div id="subscriptionExpiredOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 1000; overflow: hidden; animation: fadeIn 0.3s ease-out;">
    <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 24px;">
      <div style="background: rgba(31, 27, 46, 0.9); border: 1px solid rgba(182, 156, 255, 0.15); border-radius: 18px; padding: 40px 32px; max-width: 400px; text-align: center; backdrop-filter: blur(20px);">
        <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.7;">⏱</div>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 12px; color: rgb(243, 241, 255);">Subscription Expired</h3>
        <p style="font-size: 14px; color: rgba(243, 241, 255, 0.72); margin-bottom: 24px;">Your subscription has expired. Services are temporarily unavailable. Please contact your administrator to renew.</p>
        <button onclick="goBackToServices()" style="padding: 11px 22px; background: rgba(182, 156, 255, 0.2); border: 1px solid rgba(182, 156, 255, 0.3); color: rgba(210, 190, 255, 0.95); border-radius: 12px; font-size: 14px; cursor: pointer; font-weight: 600; transition: all 0.2s;">Back to Services</button>
      </div>
    </div>
  </div>

  <style>
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>

  <div class="layout">
    <main class="main-content" id="mainContent">
      <div class="page-header">
        <div class="page-title">Live Interview Assistant</div>
        <div class="page-subtitle">Real-time guidance and support during interviews</div>
      </div>
      <div id="adminOverrideNote" style="display: none; margin-bottom: 16px; padding: 12px 14px; border-radius: 12px; background: rgba(246, 224, 94, 0.12); border: 1px solid rgba(246, 224, 94, 0.35); color: rgba(255, 233, 160, 0.95); font-size: 13px;">
        Admin override: candidate service flag is disabled.
      </div>

      <div class="card">
        <div class="card-title">Support Tools & Resources</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px;">
          <div class="form-group">
            <label class="form-label" for="live-channel">Communication Channel</label>
            <input type="text" class="form-input" id="live-channel" placeholder="e.g., Slack, Teams, Phone">
          </div>
          <div class="form-group">
            <label class="form-label" for="live-availability">Availability</label>
            <input type="text" class="form-input" id="live-availability" placeholder="e.g., Monday-Friday 9-5">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="live-contact">Contact Information <span style="color: var(--danger);">*</span></label>
          <textarea class="form-textarea" id="live-contact" placeholder="How to reach your live assistant..."></textarea>
          <span class="form-hint">Email, phone, or instant message ways to contact</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Real-Time Support Strategy</div>
        <div class="form-group">
          <label class="form-label" for="live-strategy">Support Strategy</label>
          <textarea class="form-textarea" id="live-strategy" placeholder="How your assistant will support you during the interview..."></textarea>
          <span class="form-hint">Types of support available: feedback, tips, questions to ask</span>
        </div>

        <div class="form-group">
          <label class="form-label" for="live-fallback">Fallback Plans</label>
          <textarea class="form-textarea" id="live-fallback" placeholder="What to do if you miss a question or get stuck..."></textarea>
          <span class="form-hint">Strategies for handling difficult situations</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Session Notes</div>
        <div class="form-group">
          <label class="form-label" for="live-notes">Interview Session Notes</label>
          <textarea class="form-textarea" id="live-notes" placeholder="Notes from your live interview sessions..." style="min-height: 300px;"></textarea>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="saveService()">Save Assistant Notes</button>
          <button class="btn btn-secondary" onclick="copyToClipboard('live-notes')">Copy Notes</button>
        </div>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB-YSiB7JxxgjRIaMJLa7dHn4tk7Z_lSOk",
      authDomain: "hirereadyservices-741cd.firebaseapp.com",
      projectId: "hirereadyservices-741cd",
      storageBucket: "hirereadyservices-741cd.firebasestorage.app",
      messagingSenderId: "851576522740",
      appId: "1:851576522740:web:b55ccd3c0af676123fdba1"
    };

    const ADMIN_EMAILS = ['ducktales048@gmail.com'].map(e => (e || '').toLowerCase());
    let currentCandidateId = null;
    let currentUser = null;
    let db = null;
    let isAdminUser = false;
    let isAdmin = false;

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    db = firebase.firestore();

    // ===== SUBSCRIPTION HELPER FUNCTIONS =====
    function toDate(value, fallback) {
      if (!value) return fallback;
      if (typeof value === 'object' && value.toDate) return value.toDate();
      if (typeof value === 'string') {
        const parsed = new Date(value);
        return Number.isNaN(parsed.getTime()) ? fallback : parsed;
      }
      return fallback;
    }

    function computeSubscriptionStatus(subscriptionEnd) {
      if (!subscriptionEnd) return 'active';
      const endDate = toDate(subscriptionEnd, null);
      if (!endDate) return 'active';
      const endOfDay = new Date(endDate);
      endOfDay.setHours(23, 59, 59, 999);
      const now = new Date();
      return now > endOfDay ? 'expired' : 'active';
    }

    async function loadCandidateSubscription(cid) {
      try {
        const candidateDoc = await db.collection('candidates').doc(cid).get();
        if (candidateDoc.exists) {
          const data = candidateDoc.data();
          return {
            subscriptionEnd: data?.subscriptionEnd,
            subscriptionStatus: data?.subscriptionStatus
          };
        }
      } catch (error) {
        console.warn('Firestore read failed, falling back to localStorage:', error);
      }

      const localCandidate = safeJsonParse(localStorage.getItem('candidate_' + cid), null);
      return {
        subscriptionEnd: localCandidate?.subscriptionEnd,
        subscriptionStatus: localCandidate?.subscriptionStatus
      };
    }

    function showExpiredOverlay() {
      const expiredOverlay = document.getElementById('subscriptionExpiredOverlay');
      if (expiredOverlay) {
        expiredOverlay.style.display = 'flex';
      }
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('accessDeniedUI').style.display = 'none';
    }

    // ===== END SUBSCRIPTION HELPERS =====

    function hrIsAdminContext() {
      const params = new URLSearchParams(window.location.search);
      const cidFromUrl = params.get('cid');
      const modeFromUrl = params.get('mode');
      const role = localStorage.getItem('role') || 'user';
      const adminAuthFlag = localStorage.getItem('adminAuth') === 'true';
      const hrMode = sessionStorage.getItem('hr_mode');
      const isAdminContext = (modeFromUrl === 'admin') || (role === 'admin') || (hrMode === 'admin') || adminAuthFlag;
      if (cidFromUrl) {
        sessionStorage.setItem('hr_active_cid', cidFromUrl);
      }
      if (isAdminContext) {
        sessionStorage.setItem('hr_mode', 'admin');
      }
      return isAdminContext;
    }

    function hrGetCid() {
      const params = new URLSearchParams(window.location.search);
      const cidFromUrl = params.get('cid');
      if (cidFromUrl) {
        sessionStorage.setItem('hr_active_cid', cidFromUrl);
      }
      return cidFromUrl || sessionStorage.getItem('hr_active_cid') || localStorage.getItem('candidateId') || '';
    }

    function hrIsCandidateLoggedIn(cid) {
      if (!cid) return false;
      const candAuth = safeJsonParse(localStorage.getItem(`candidateAuth_${cid}`), null);
      return !!(candAuth && (candAuth.candidateId === cid || candAuth.cid === cid));
    }

    function buildServicesUrl(cid) {
      const params = new URLSearchParams();
      if (cid) params.set('cid', cid);
      if (hrIsAdminContext()) params.set('mode', 'admin');
      const qs = params.toString();
      return qs ? 'services.html?' + qs : 'services.html';
    }

    function goBackToServices() {
      window.location.href = buildServicesUrl(currentCandidateId);
    }

    function goBack(e) {
      e.preventDefault();
      goBackToServices();
    }

    function showFileProtocolMessage() {
      const accessUi = document.getElementById('accessDeniedUI');
      const titleEl = accessUi ? accessUi.querySelector('h2') : null;
      const messageEl = accessUi ? accessUi.querySelector('p') : null;
      if (titleEl) titleEl.textContent = 'Local File Mode Blocked';
      if (messageEl) messageEl.textContent = 'Open via http://localhost or the Netlify URL for login/session to work.';
      document.getElementById('mainContent').style.display = 'none';
      if (accessUi) accessUi.style.display = 'flex';
    }

    function showMissingCandidate() {
      const accessUi = document.getElementById('accessDeniedUI');
      const titleEl = accessUi ? accessUi.querySelector('h2') : null;
      const messageEl = accessUi ? accessUi.querySelector('p') : null;
      if (titleEl) titleEl.textContent = 'Missing Candidate ID';
      if (messageEl) messageEl.textContent = 'Missing candidate id. Please return to Services and select a candidate.';
      document.getElementById('mainContent').style.display = 'none';
      if (accessUi) accessUi.style.display = 'flex';
    }

    function safeJsonParse(value, fallback = null) {
      if (!value) return fallback;
      try {
        return JSON.parse(value);
      } catch (e) {
        return fallback;
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function ensureAnonAuth() {
      if (!auth) {
        throw new Error('Firebase not initialized');
      }
      
      try {
        // If already signed in, refresh the token to ensure it's valid
        if (auth.currentUser) {
          await auth.currentUser.getIdToken(true);
          return true;
        }
        
        // Sign in anonymously
        await auth.signInAnonymously();
        
        // Wait for auth state to be fully established before returning
        await new Promise((resolve, reject) => {
          let unsub = null;
          const timeout = setTimeout(() => {
            if (unsub) unsub();
            reject(new Error('Auth initialization timeout'));
          }, 3000);
          
          unsub = auth.onAuthStateChanged(user => {
            if (user) {
              clearTimeout(timeout);
              if (unsub) unsub();
              resolve(user);
            }
          });
        });
        
        // Get fresh ID token to ensure Firestore can authenticate
        await auth.currentUser.getIdToken(true);
        return true;
      } catch (error) {
        console.error('MODULE_ANON_AUTH_FAIL', error.code, error.message);
        
        // Check for operation-not-allowed or admin-restricted-operation (Anonymous auth disabled/restricted)
        if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/admin-restricted-operation') {
          const msg = 'Login is temporarily unavailable because Firebase Anonymous Authentication is disabled or restricted. Enable Anonymous sign-in in Firebase Console → Authentication → Sign-in method. If it is already enabled, check Identity Platform / tenant restrictions and allow Anonymous sign-in for this project.';
          throw new Error(msg);
        }
        
        // Retry once for transient failures
        if (error.code && (error.code === 'auth/network-request-failed' || error.code === 'auth/user-cancelled')) {
          console.log('MODULE_ANON_AUTH_RETRY', 'Transient error detected, retrying...');
          await new Promise(resolve => setTimeout(resolve, 400));
          try {
            await auth.signInAnonymously();
            return true;
          } catch (retryError) {
            console.error('MODULE_ANON_AUTH_RETRY_FAIL', retryError.code);
            throw error;
          }
        }
        
        throw error;
      }
    }

    function copyToClipboard(id) {
      const element = document.getElementById(id);
      if (!element) return;
      navigator.clipboard.writeText(element.value).then(() => {
        showToast('Copied to clipboard', 'success');
      }).catch(() => {
        showToast('Copy failed', 'error');
      });
    }

    async function saveService() {
      try {
        const data = {
          liveAssistant: {
            channel: document.getElementById('live-channel').value,
            availability: document.getElementById('live-availability').value,
            contact: document.getElementById('live-contact').value,
            strategy: document.getElementById('live-strategy').value,
            fallback: document.getElementById('live-fallback').value,
            notes: document.getElementById('live-notes').value
          },
          meta: {
            updatedAt: new Date(),
            updatedByUid: currentUser?.uid || null
          }
        };

        await db.collection('candidate_services').doc(currentCandidateId).set(data, { merge: true });
        showToast('Assistant notes saved successfully', 'success');
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error saving: ' + error.message, 'error');
      }
    }

    async function loadService() {
      try {
        if (!hrIsAdminContext()) {
          const subData = await loadCandidateSubscription(currentCandidateId);
          const isExpired = computeSubscriptionStatus(subData.subscriptionEnd) === 'expired';
          if (isExpired) {
            showExpiredOverlay();
            return;
          }
        }

        const accessDoc = await db.collection('candidates').doc(currentCandidateId).get();
        const remoteAccess = accessDoc.data()?.servicesAccess || null;
        const localAccess = safeJsonParse(localStorage.getItem('servicesAccess_' + currentCandidateId), null);
        const servicesAccess = remoteAccess || localAccess || {};

        const isServiceEnabled = isAdmin ? true : (servicesAccess.liveAssistant !== false);
        const overrideNote = document.getElementById('adminOverrideNote');
        if (overrideNote) {
          overrideNote.style.display = (isAdmin && servicesAccess.liveAssistant === false) ? 'block' : 'none';
        }
        if (!isServiceEnabled) {
          document.getElementById('mainContent').style.display = 'none';
          document.getElementById('accessDeniedUI').style.display = 'flex';
          return;
        }

        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('accessDeniedUI').style.display = 'none';

        const doc = await db.collection('candidate_services').doc(currentCandidateId).get();
        if (doc.exists && doc.data().liveAssistant) {
          const data = doc.data().liveAssistant;
          document.getElementById('live-channel').value = data.channel || '';
          document.getElementById('live-availability').value = data.availability || '';
          document.getElementById('live-contact').value = data.contact || '';
          document.getElementById('live-strategy').value = data.strategy || '';
          document.getElementById('live-fallback').value = data.fallback || '';
          document.getElementById('live-notes').value = data.notes || '';
        }
      } catch (error) {
        console.error('Load error:', error);
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('accessDeniedUI').style.display = 'none';
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      if (window.location.protocol === 'file:') {
        showFileProtocolMessage();
        return;
      }

      // START TIMEOUT WATCHDOG: If access check takes >8 seconds, show error
      let accessCheckTimeoutId = null;
      const clearAccessCheckTimeout = () => {
        if (accessCheckTimeoutId !== null) {
          clearTimeout(accessCheckTimeoutId);
          accessCheckTimeoutId = null;
        }
      };
      
      accessCheckTimeoutId = setTimeout(() => {
        console.error('MODULE_ACCESS_CHECK_TIMEOUT', 'Timeout exceeded 8000ms');
        clearAccessCheckTimeout();
        const accessUi = document.getElementById('accessDeniedUI');
        const titleEl = accessUi ? accessUi.querySelector('h2') : null;
        const messageEl = accessUi ? accessUi.querySelector('p') : null;
        if (titleEl) titleEl.textContent = 'Access Check Timeout';
        if (messageEl) messageEl.innerHTML = 'The access check took too long. This usually means:<br>1) Firebase is unreachable<br>2) Anonymous Auth is not enabled<br>3) Network is slow<br><br><a href="javascript:location.reload()" style="color:#3b82f6;text-decoration:underline;">Try Again</a>';
        document.getElementById('mainContent').style.display = 'none';
        if (accessUi) accessUi.style.display = 'flex';
      }, 8000);

      const isAdminContext = hrIsAdminContext();
      currentCandidateId = hrGetCid();
      if (!currentCandidateId) {
        clearAccessCheckTimeout();
        if (isAdminContext) {
          showMissingCandidate();
        } else {
          window.location.href = 'user.html';
        }
        return;
      }

      if (!isAdminContext && !hrIsCandidateLoggedIn(currentCandidateId)) {
        clearAccessCheckTimeout();
        window.location.href = 'user.html?cid=' + encodeURIComponent(currentCandidateId);
        return;
      }

      auth.onAuthStateChanged(async (user) => {
        try {
          currentUser = user;
          const emailLower = (user?.email || '').trim().toLowerCase();
          const isAdminContext = hrIsAdminContext();
          isAdminUser = ADMIN_EMAILS.map(e => (e || '').toLowerCase()).includes(emailLower);
          isAdmin = isAdminUser && isAdminContext;

          if (isAdminContext) {
            if (!user || !isAdminUser) {
              clearAccessCheckTimeout();
              window.location.href = 'admin.html';
              return;
            }
          } else {
            if (!hrIsCandidateLoggedIn(currentCandidateId)) {
              clearAccessCheckTimeout();
              window.location.href = 'user.html?cid=' + encodeURIComponent(currentCandidateId);
              return;
            }
            if (!user) {
              try {
                await ensureAnonAuth();
              } catch (authError) {
                clearAccessCheckTimeout();
                console.error('MODULE_CANDIDATE_AUTH_FAIL', authError.message);
                const accessUi = document.getElementById('accessDeniedUI');
                const titleEl = accessUi ? accessUi.querySelector('h2') : null;
                const messageEl = accessUi ? accessUi.querySelector('p') : null;
                if (titleEl) titleEl.textContent = 'Authentication Error';
                if (messageEl) messageEl.textContent = authError.message;
                document.getElementById('mainContent').style.display = 'none';
                if (accessUi) accessUi.style.display = 'flex';
                return;
              }
            }
            isAdminUser = false;
            isAdmin = false;
          }

          clearAccessCheckTimeout();
          await loadService();
        } catch (error) {
          clearAccessCheckTimeout();
          console.error('MODULE_AUTH_STATE_ERROR', error);
          const accessUi = document.getElementById('accessDeniedUI');
          const titleEl = accessUi ? accessUi.querySelector('h2') : null;
          const messageEl = accessUi ? accessUi.querySelector('p') : null;
          if (titleEl) titleEl.textContent = 'Error';
          if (messageEl) messageEl.textContent = error.message || 'An unexpected error occurred.';
          document.getElementById('mainContent').style.display = 'none';
          if (accessUi) accessUi.style.display = 'flex';
        }
      });
    });
  </script>
</body>
</html>
