
<!DOCTYPE html>
<html lang="en">
<head>
<!-- TEST CHECKLIST: 1) Hard refresh admin.html 2) Login ducktales048@gmail.com 3) Console shows FIREBASE_PROJECT_OK hirereadyservices-9a8de and AUTH_STATE email 4) Sync candidates without permission errors -->
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Console - Candidate Details</title>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f2f4f8;margin:0}
.header{background:#ffffff;padding:18px 15px;border-bottom:1px solid #d7deea;}
.header h2{margin:0;text-align:center;color:#1f3d6b}
.container{max-width:1100px;margin:18px auto;padding:0 15px;box-sizing:border-box;}
.card{background:#fff;border:1px solid #d7deea;padding:14px;}
.title{
  background:#1f3d6b;
  color:#fff;
  padding:7px 10px;
  font-weight:600;

  /* IMPORTANT: no negative margins, so it will NOT touch card edges */
  margin:0 0 12px 0;

  /* optional: small rounding to match modern UI */
  border-radius:4px;
}

.section{margin-top:16px}
.section-title{background:#1f3d6b;color:#fff;padding:7px 10px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.section-title .right{display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.readonly{background:#f3f6fb;cursor:not-allowed;color:#666}
.dateInvalid{ border:2px solid #b00000 !important; background:#fff5f5; }
input,textarea,select{border:1px solid #999;padding:10px;font-size:13px;width:100%;box-sizing:border-box;}
textarea{height:80px;resize:none}

.boxline{border:1px solid #bbb;padding:10px;margin-top:10px;background:#fbfdff}

.btnbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.btn{padding:10px 14px;font-size:14px;border:none;cursor:pointer;color:#fff;}
.btn.primary{background:#1f3d6b}
.btn.success{background:#2d7d46}
.btn.gray{background:#888}
.btn.danger{background:#b00000}

.status{margin-top:10px;padding:10px;border:1px solid #cfd7e6;background:#f7f9ff;color:#1f3d6b;font-size:13px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;color:#fff;margin-left:8px}
.badge.ok{background:#2d7d46}
.badge.err{background:#b00000}

.cred-input{width:160px;padding:8px;border:1px solid #999;font-size:12px;}
.cred-actions{display:flex;gap:6px;flex-wrap:wrap;}
.cred-btn{padding:6px 8px;font-size:11px;border:none;cursor:pointer;color:#fff;border-radius:3px;}
.cred-btn.primary{background:#1f3d6b}
.cred-btn.gray{background:#64748b}
.cred-btn.success{background:#2d7d46}
.cred-btn.warn{background:#b45309}
.cred-msg{margin-top:6px;font-size:11px;color:#2d7d46;min-height:14px;}

.current-pw-cell{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.pw-value{flex:1;min-width:0;}
.pw-actions{display:flex;gap:4px;align-items:center;}
.pw-icon-btn{padding:6px 8px;cursor:pointer;border:1px solid #d7deea;background:#fff;border-radius:4px;font-size:14px;line-height:1;transition:background 0.2s;}
.pw-icon-btn:hover{background:#f3f6fb;}

.modalBackdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;box-sizing:border-box;z-index:50;}
.modalBox{width:520px;max-width:95vw;background:#fff;border:1px solid #d7deea;border-radius:6px;overflow:hidden;}
.modalHead{background:#1f3d6b;color:#fff;padding:10px 12px;font-weight:700;}
.modalBody{padding:12px;color:#0f172a;font-size:13px;line-height:1.5}
.modalActions{padding:12px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #d7deea}
.modalBtn{border:none;cursor:pointer;padding:9px 12px;color:#fff;background:#1f3d6b}
.modalBtn.gray{background:#888}

.loginWrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box;}
.loginCard{width:520px;max-width:95vw;background:#fff;border:1px solid #d7deea;padding:14px;}
.loginTitle{
  background:#1f3d6b;
  color:#fff;
  padding:10px 12px;
  font-weight:700;

  /* IMPORTANT: no negative margins, so it aligns with inputs */
  margin:0 0 12px 0;

  border-radius:4px;
}
.loginGrid{display:grid;grid-template-columns:1fr;gap:10px}
.topActions{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}

.sameAddrRow{display:flex;align-items:flex-start;gap:8px;margin:6px 0;cursor:pointer;font-size:13px;color:#0f172a;}
input[type="checkbox"]{width:auto;margin:0}

/* Company block header: keep title left, push actions fully to the right edge */
.section-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.section-title .right{
  display:flex;
  align-items:center;
  gap:10px;
  margin-left:auto; /* forces the right container to the far edge */
}

/* Professional field label styling for Admin Console */
.field-label {
  display: block;
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
  font-size: 12.5px;
  font-weight: 700;
  letter-spacing: 0.2px;
  color: #0f172a;
  line-height: 1.2;
  margin: 2px 0 6px 0;
}

.field-label small {
  font-weight: 600;
  color: #64748b;
}

/* Improve vertical rhythm in cards */
.card .grid {
  row-gap: 14px;
}

.card textarea {
  margin-top: 0;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

</head>

<body>

<div id="loginSection" class="loginWrap">
  <div class="loginCard">
    <div class="loginTitle">Admin Console - Candidate Details</div>
    <form onsubmit="handleLogin(event)" style="width:100%;">
      <div class="loginGrid">
        <input id="loginEmail" type="email" placeholder="Email" />
        <input id="loginPassword" type="password" placeholder="Password" />
        <button type="submit" class="btn primary">Login</button>
      </div>
    </form>
    <p style="margin-top:10px;margin-bottom:0;font-size:12px;color:#334155;line-height:1.5;">Use your admin email/password. Access is restricted.</p>
  </div>
</div>

<div id="appSection" style="display:none;">
  <div class="header">
    <h2>Admin Console - Candidate Details</h2>
    <div class="topActions">
      <span style="color:#334155" id="userEmail"></span>
      <button class="btn primary" onclick="openHireReadyServices()">HireReady Services</button>
      <button class="btn gray" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <!-- LIST VIEW -->
  <div id="listView" style="display:none;">
    <div class="container">
      <div class="card">
        <div class="title">Candidate Details Form</div>
        <div style="margin-top:10px;">
          <input type="text" id="searchInput" placeholder="Search by Candidate ID, name, preferred name, email" style="width:100%;padding:10px;border:1px solid #999;box-sizing:border-box;margin-bottom:10px;" onkeyup="filterCandidates()" />
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <button class="btn primary" onclick="refreshList()">Refresh</button>
            <button class="btn gray" onclick="clearSearch()">Clear Search</button>
            <button class="btn primary" onclick="syncFromCloud()">Sync from Cloud</button>
            <button class="btn success" onclick="newCandidate()">+ New Candidate</button>
            <button class="btn primary" onclick="exportListPdf()">Export List PDF</button>
            <button class="btn success" onclick="openRegistrationLink()">Registration Form</button>
            <button class="btn danger" onclick="deleteAllCloud()">Delete All (Cloud)</button>
            <span style="color:#334155;margin-top:10px;" id="recordCount"></span>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table id="candidatesTable" style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="background:#f3f6fb;border-bottom:2px solid #1f3d6b;">
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Candidate ID</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Full Name</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Preferred Name</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Email</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">WhatsApp</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Last Updated</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Actions</th>
              </tr>
            </thead>
            <tbody id="candidatesTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="title">Credentials Management</div>
        <div style="margin-top:10px;">
          <input type="text" id="credSearchInput" placeholder="Search by Candidate ID or name" style="width:100%;padding:10px;border:1px solid #999;box-sizing:border-box;margin-bottom:10px;" onkeyup="filterCredentials()" />
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
            <button class="btn primary" onclick="refreshCredentialsList()">Refresh Credentials</button>
            <button class="btn gray" onclick="clearCredentialsSearch()">Clear Search</button>
            <span style="color:#334155;margin-left:auto;" id="credRecordCount"></span>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table id="credentialsTable" style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="background:#f3f6fb;border-bottom:2px solid #1f3d6b;">
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Candidate ID</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Candidate Name</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Current Password</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">New Password</th>
                <th style="border:1px solid #d7deea;padding:10px 12px;text-align:left;color:#1f3d6b;font-weight:700;">Actions</th>
              </tr>
            </thead>
            <tbody id="credentialsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- FORM VIEW -->
  <div id="formView" style="display:none;">
    <div class="container" style="margin-top:0;">
      <div style="background:#fff;border:1px solid #d7deea;margin-bottom:10px;padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <div>
          <h3 style="margin:0;color:#1f3d6b;font-size:18px;" id="formTitle">New Candidate</h3>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn gray" onclick="backToList()">Close</button>
          <button class="btn primary" onclick="saveData()">Save Changes</button>
          <button class="btn success" onclick="openHireReadyServices()">HireReady Services</button>
          <button class="btn danger" onclick="openJDMatchAdmin()" title="Open JD Match in admin mode for this candidate">JD Match (Admin)</button>
          <button class="btn primary" onclick="saveData(); openRegistrationFormModal()">Registration Form</button>
          <button class="btn primary" onclick="exportPdf()">Export PDF</button>
          <button class="btn danger" onclick="deleteCandidate()">Delete Record</button>
        </div>
      </div>

      <div class="card">
        <div class="title">PDF Export Options (Hide Sections)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;padding:14px;background:#f9fafb;">
          <div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visRecord" checked onchange="toggleSection()"> <span>Record Info</span></label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visCompany" checked onchange="toggleSection()"> <span>Company Experience</span></label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visG" checked onchange="toggleSection()"> <span>Graduation</span></label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visT" checked onchange="toggleSection()"> <span>10th Standard</span></label>
          </div>
          <div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visPersonal" checked onchange="toggleSection()"> <span>Personal Information</span></label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visHg" checked onchange="toggleSection()"> <span>Highest Graduation</span></label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visI" checked onchange="toggleSection()"> <span>Intermediate / Diploma</span></label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:8px 0;"><input type="checkbox" id="visFamily" checked onchange="toggleSection()"> <span>Family Details</span></label>
          </div>
        </div>
        <div style="padding:8px 14px;font-size:12px;color:#666;">Uncheck any section to exclude it from the PDF. This does not remove data from the record.</div>
      </div>

      <div class="card" data-section="Record Info">
        <div class="title">Record Info</div>
        <div class="grid">
          <div>
            <label class="field-label" for="candidateId">Candidate ID</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="candidateId" placeholder="Candidate ID" style="flex:1;" />
              <button type="button" class="btn success" id="btnCreateCandidateId" onclick="createCandidateIdFromPreferredName()" style="padding:8px 12px;font-size:12px;">Create</button>
              <button type="button" class="btn primary" id="btnLoadCandidateId" onclick="loadCandidateIdPrompt()" style="padding:8px 12px;font-size:12px;">Load</button>
            </div>
          </div>
          <div>
            <label class="field-label" for="status">Status</label>
            <select id="status"><option value="">Status</option><option value="Active">Active</option><option value="Inactive">Inactive</option><option value="Pending">Pending</option></select>
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="lastUpdatedText">Last Updated (Text)</label>
            <input id="lastUpdatedText" placeholder="Last Updated (Text)" readonly class="readonly" />
          </div>
          <div>
            <label class="field-label" for="lastUpdatedISO">Last Updated (ISO)</label>
            <input id="lastUpdatedISO" placeholder="Last Updated (ISO)" readonly class="readonly" />
          </div>
        </div>
      </div>

      <div class="card" data-section="Subscription">
        <div class="title">Subscription</div>
        <div class="grid">
          <div>
            <label class="field-label" for="subscriptionPlanType">Plan Type</label>
            <select id="subscriptionPlanType">
              <option value="demo3days">Demo (3 Days)</option>
              <option value="demo7days">Demo (7 Days)</option>
              <option value="1month">1 Month</option>
              <option value="2months">2 Months</option>
              <option value="3months">3 Months</option>
              <option value="6months">6 Months</option>
              <option value="12months">12 Months</option>
            </select>
          </div>
          <div>
            <label class="field-label" for="subscriptionStartDate">Start Date</label>
            <input id="subscriptionStartDate" type="date" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="subscriptionEndDate">End Date</label>
            <input id="subscriptionEndDate" type="date" readonly class="readonly" />
          </div>
          <div>
            <label class="field-label" for="subscriptionStatus">Status</label>
            <select id="subscriptionStatus">
              <option value="ACTIVE">ACTIVE</option>
              <option value="INACTIVE">INACTIVE</option>
              <option value="ON HOLD">ON HOLD</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button type="button" class="btn primary" onclick="applySubscriptionPlan()">Apply Plan</button>
          <button type="button" class="btn gray" onclick="refreshSubscriptionStatus()">Refresh Status</button>
        </div>
      </div>

      <div class="card" data-section="Service Access">
        <div class="title">Service Access</div>
        <div id="serviceAccessList" class="grid"></div>
      </div>

      <div class="card" data-section="Personal Information">
        <div class="title">Personal Information</div>
        <div class="grid">
          <div>
            <label class="field-label" for="fullName">Full Name (as per Aadhaar)</label>
            <input id="fullName" placeholder="Full Name as per Aadhaar" />
          </div>
          <div>
            <label class="field-label" for="preferredName">Preferred Name</label>
            <input id="preferredName" placeholder="Preferred Name" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="gender">Gender</label>
            <select id="gender"><option value="">Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select>
          </div>
          <div>
            <label class="field-label" for="whatsapp">WhatsApp Number</label>
            <input id="whatsapp" placeholder="WhatsApp Number" onkeypress="onlyDigits(event)" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="dob">Date of Birth (DD/MM/YYYY)</label>
            <input id="dob" placeholder="Date of Birth (DD/MM/YYYY)" onchange="computeAge()" />
          </div>
          <div>
            <label class="field-label" for="dobText">Date of Birth (Formatted)</label>
            <input id="dobText" placeholder="Date of Birth (MMM DD, YYYY)" readonly class="readonly" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="ageYmd">Age (Years, Months, Days)</label>
            <input id="ageYmd" placeholder="Age (Years, Months, Days)" readonly class="readonly" />
          </div>
          <div>
            <label class="field-label" for="marital">Marital Status</label>
            <select id="marital"><option value="">Marital Status</option><option value="Single">Single</option><option value="Married">Married</option><option value="Divorced">Divorced</option></select>
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="blood">Blood Group</label>
            <select id="blood"><option value="">Blood Group</option><option value="O+">O+</option><option value="O-">O-</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select>
          </div>
          <div>
            <label class="field-label" for="sim">SIM Number</label>
            <input id="sim" placeholder="SIM Number" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="email">Professional Email ID</label>
            <input id="email" placeholder="Professional Email ID" />
          </div>
          <div>
            <label class="field-label" for="aadhaar">Aadhaar Number</label>
            <input id="aadhaar" placeholder="Aadhaar Number" onkeypress="onlyDigits(event)" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="pan">PAN Number</label>
            <input id="pan" placeholder="PAN Number" />
          </div>
          <div>
            <label class="field-label" for="passport">Passport Number</label>
            <input id="passport" placeholder="Passport Number" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="bank">Bank Account Number</label>
            <input id="bank" placeholder="Bank Account Number" />
          </div>
          <div>
            <label class="field-label" for="uanNumber">UAN (Universal Account Number)</label>
            <input id="uanNumber" placeholder="UAN (Universal Account Number)" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="ifscCode">IFSC (Bank IFSC Code)</label>
            <input id="ifscCode" placeholder="IFSC (Bank IFSC code)" />
          </div>
          <div>
            <label class="field-label" for="bankName">Bank Name</label>
            <input id="bankName" placeholder="NAME OF THE BANK" />
          </div>
        </div>
        <label class="field-label" for="permanentAddress">Permanent Address</label>
        <textarea id="permanentAddress" placeholder="Permanent Address (House No, Street, Area, City, State, PIN Code)"></textarea>
        <label class="sameAddrRow"><input type="checkbox" id="sameAddress" onchange="syncSameAddr()" /><span>Current Address is same as Permanent Address</span></label>
        <label class="field-label" for="currentAddress">Current Address</label>
        <textarea id="currentAddress" placeholder="Current Address (House No, Street, Area, City, State, PIN Code)"></textarea>
      </div>

      <div class="card" data-section="Company Experience">
        <div class="title">Employment History</div>
        <div class="grid">
          <div>
            <label class="field-label" for="totalExperience">Total Experience</label>
            <input id="totalExperience" placeholder="Total Experience" readonly class="readonly" />
          </div>
          <div>
            <label class="field-label" for="relevantExperience">Relevant Experience</label>
            <input id="relevantExperience" placeholder="Relevant Experience" />
          </div>
        </div>
        <div id="companiesContainer"></div>
        <button class="btn success" onclick="addCompany()">Add Company</button>
      </div>

      <div class="card" data-section="Highest Graduation">
        <div class="title">Highest Graduation</div>
        <div class="grid">
          <div>
            <label class="field-label" for="hgDegree">Degree Name</label>
            <input id="hgDegree" placeholder="Degree Name" />
          </div>
          <div>
            <label class="field-label" for="hgBranch">Branch Name</label>
            <input id="hgBranch" placeholder="Branch Name" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="hgCollege">College</label>
            <input id="hgCollege" placeholder="College" />
          </div>
          <div>
            <label class="field-label" for="hgCollegeAddress">College Address</label>
            <input id="hgCollegeAddress" placeholder="College Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="hgUniversity">University</label>
            <input id="hgUniversity" placeholder="University" />
          </div>
          <div>
            <label class="field-label" for="hgUniversityAddress">University Address</label>
            <input id="hgUniversityAddress" placeholder="University Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="hgPercentage">Percentage / CGPA</label>
            <input id="hgPercentage" placeholder="Percentage / CGPA" />
          </div>
          <div>
            <label class="field-label" for="hgDuration">Duration</label>
            <input id="hgDuration" placeholder="Duration" />
          </div>
        </div>
        <label class="field-label" for="hgDelay">Completion Delay</label>
        <textarea id="hgDelay" placeholder="Completion Delay"></textarea>
      </div>

      <div class="card" data-section="Graduation">
        <div class="title">Graduation</div>
        <div class="grid">
          <div>
            <label class="field-label" for="gDegree">Degree Name</label>
            <input id="gDegree" placeholder="Degree Name" />
          </div>
          <div>
            <label class="field-label" for="gBranch">Branch Name</label>
            <input id="gBranch" placeholder="Branch Name" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="gCollege">College</label>
            <input id="gCollege" placeholder="College" />
          </div>
          <div>
            <label class="field-label" for="gCollegeAddress">College Address</label>
            <input id="gCollegeAddress" placeholder="College Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="gUniversityAddress">University Address</label>
            <input id="gUniversityAddress" placeholder="University Address" />
          </div>
          <div>
            <label class="field-label" for="gPercentage">Percentage / CGPA</label>
            <input id="gPercentage" placeholder="Percentage / CGPA" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="gDuration">Duration</label>
            <input id="gDuration" placeholder="Duration" />
          </div>
          <div>
            <label class="field-label" for="gDelay">Completion Delay</label>
            <input id="gDelay" placeholder="Completion Delay" />
          </div>
        </div>
      </div>

      <div class="card" data-section="Intermediate / Diploma">
        <div class="title">Intermediate / Diploma</div>
        <div class="grid">
          <div>
            <label class="field-label" for="iType">Type</label>
            <select id="iType"><option value="">Type</option><option value="Intermediate">Intermediate</option><option value="Diploma">Diploma</option></select>
          </div>
          <div>
            <label class="field-label" for="iBranch">Branch Name</label>
            <input id="iBranch" placeholder="Branch Name" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="iCollege">College</label>
            <input id="iCollege" placeholder="College" />
          </div>
          <div>
            <label class="field-label" for="iCollegeAddress">College Address</label>
            <input id="iCollegeAddress" placeholder="College Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="iBoard">Board / University</label>
            <input id="iBoard" placeholder="Board / University" />
          </div>
          <div>
            <label class="field-label" for="iBoardAddress">Board Address</label>
            <input id="iBoardAddress" placeholder="Board Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="iPercentage">Percentage / CGPA</label>
            <input id="iPercentage" placeholder="Percentage / CGPA" />
          </div>
          <div>
            <label class="field-label" for="iDuration">Duration</label>
            <input id="iDuration" placeholder="Duration" />
          </div>
        </div>
        <label class="field-label" for="iDelay">Completion Delay</label>
        <textarea id="iDelay" placeholder="Completion Delay"></textarea>
      </div>

      <div class="card" data-section="10th Standard">
        <div class="title">10th Standard</div>
        <div class="grid">
          <div>
            <label class="field-label" for="tSchool">School Name</label>
            <input id="tSchool" placeholder="School Name" />
          </div>
          <div>
            <label class="field-label" for="tSchoolAddress">School Address</label>
            <input id="tSchoolAddress" placeholder="School Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="tBoard">Board</label>
            <input id="tBoard" placeholder="Board" />
          </div>
          <div>
            <label class="field-label" for="tBoardAddress">Board Address</label>
            <input id="tBoardAddress" placeholder="Board Address" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label class="field-label" for="tPercentage">Percentage / CGPA</label>
            <input id="tPercentage" placeholder="Percentage / CGPA" />
          </div>
          <div>
            <label class="field-label" for="tDuration">Duration</label>
            <input id="tDuration" placeholder="Duration" />
          </div>
        </div>
        <label class="field-label" for="tDelay">Completion Delay</label>
        <textarea id="tDelay" placeholder="Completion Delay"></textarea>
      </div>

      <div class="card" data-section="Family Details">
        <div class="title">Family Details</div>
        <div class="section">
          <div class="section-title">Father</div>
          <div class="grid4">
            <div>
              <label class="field-label" for="father">Father Name</label>
              <input id="father" placeholder="Father Name" />
            </div>
            <div>
              <label class="field-label" for="fatherDob">DOB (DD/MM/YYYY)</label>
              <input id="fatherDob" placeholder="DOB (DD/MM/YYYY)" class="dob-auto-format" inputmode="numeric" maxlength="10" onchange="computeFatherAge()" />
            </div>
            <div>
              <label class="field-label" for="fatherDobText">DOB (Formatted)</label>
              <input id="fatherDobText" placeholder="DOB (MMM DD, YYYY)" readonly class="readonly" />
            </div>
            <div>
              <label class="field-label" for="fatherAge">Age</label>
              <input id="fatherAge" placeholder="Age (Years, Months, Days)" readonly class="readonly" />
            </div>
          </div>
        </div>
        <div class="section">
          <div class="section-title">Mother</div>
          <div class="grid4">
            <div>
              <label class="field-label" for="mother">Mother Name</label>
              <input id="mother" placeholder="Mother Name" />
            </div>
            <div>
              <label class="field-label" for="motherDob">DOB (DD/MM/YYYY)</label>
              <input id="motherDob" placeholder="DOB (DD/MM/YYYY)" class="dob-auto-format" inputmode="numeric" maxlength="10" onchange="computeMotherAge()" />
            </div>
            <div>
              <label class="field-label" for="motherDobText">DOB (Formatted)</label>
              <input id="motherDobText" placeholder="DOB (MMM DD, YYYY)" readonly class="readonly" />
            </div>
            <div>
              <label class="field-label" for="motherAge">Age</label>
              <input id="motherAge" placeholder="Age (Years, Months, Days)" readonly class="readonly" />
            </div>
          </div>
        </div>
        <div id="siblingsContainer"></div>
        <button class="btn success" onclick="addSibling()">Add Sibling</button>
      </div>

      <div class="card">
        <div class="title">Custom Fields</div>
        <div style="margin-bottom:10px;">
          <button class="btn success" onclick="openCustomFieldModal()">+ Add Custom Field</button>
        </div>
        <div id="customFieldsContainer" style="max-height:300px;overflow-y:auto;"></div>
      </div>

      <div class="status" id="statusMsg" style="margin:10px auto;max-width:1100px;"></div>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="modalBackdrop">
  <div class="modalBox">
    <div class="modalHead" id="modalHead">Message</div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalActions">
      <button class="modalBtn gray" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="customFieldModal" style="display:none;">
  <div class="modalBox">
    <div class="modalHead">Add Custom Field</div>
    <div class="modalBody" style="display:grid;gap:12px;">
      <div>
        <label style="font-size:12px;font-weight:700;color:#334155;display:block;margin-bottom:6px;">Field Label (Required)</label>
        <input id="cfLabel" type="text" placeholder="e.g., Certification, Skills, etc." style="border:1px solid #999;padding:10px;font-size:13px;width:100%;box-sizing:border-box;" />
      </div>
      <div>
        <label style="font-size:12px;font-weight:700;color:#334155;display:block;margin-bottom:6px;">Field Value (Optional)</label>
        <input id="cfValue" type="text" placeholder="e.g., AWS, Python, etc. - Leave empty if this field is not mandatory" style="border:1px solid #999;padding:10px;font-size:13px;width:100%;box-sizing:border-box;" />
        <div style="font-size:11px;color:#666;margin-top:4px;">Validation depends on field configuration. Mandatory fields will be enforced by the system.</div>
      </div>
      <div>
        <label style="font-size:12px;font-weight:700;color:#334155;display:block;margin-bottom:6px;">Section</label>
        <select id="cfSection" style="border:1px solid #999;padding:10px;font-size:13px;width:100%;box-sizing:border-box;">
          <option value="">-- Select Section --</option>
          <option value="Record Info">Record Info</option>
          <option value="Personal Information">Personal Information</option>
          <option value="Company Experience">Company Experience</option>
          <option value="Highest Graduation">Highest Graduation</option>
          <option value="Graduation">Graduation</option>
          <option value="Intermediate / Diploma">Intermediate / Diploma</option>
          <option value="10th Standard">10th Standard</option>
          <option value="Family Details">Family Details</option>
        </select>
      </div>
    </div>
    <div class="modalActions">
      <button class="modalBtn gray" onclick="closeCustomFieldModal()">Cancel</button>
      <button class="modalBtn" onclick="saveCustomField()">Add Field</button>
    </div>
  </div>
</div>

<!-- Registration Form Modal -->
<div class="modalBackdrop" id="registrationFormModal" style="display:none;">
  <div class="modalBox" style="max-height:90vh;overflow-y:auto;width:90%;max-width:900px;">
    <div class="modalHead">Registration Form</div>
    <div class="modalBody" style="display:grid;gap:12px;padding:12px;">
      <div>
        <label style="font-size:12px;font-weight:700;color:#334155;display:block;margin-bottom:6px;">Select Employment</label>
        <select id="regFormEmploymentSelect" onchange="refreshRegistrationFormFields().catch(e => console.error('Auto-fill error:', e))" style="border:1px solid #999;padding:10px;font-size:13px;width:100%;box-sizing:border-box;">
          <option value="">-- Select an employment --</option>
        </select>
      </div>
      
      <div id="regFormFieldsContainer" style="display:none;border-top:1px solid #ddd;padding-top:12px;">
        <!-- PERSONAL INFORMATION Section -->
        <div style="margin-bottom:16px;">
          <h3 style="margin:0 0 10px 0;font-size:14px;font-weight:700;color:#1f3d6b;">PERSONAL INFORMATION</h3>
          <div style="display:grid;gap:8px;">
            <div>
              <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">FULL NAME</label>
              <input id="regForm_fullName" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">GENDER</label>
                <input id="regForm_gender" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">PAN NO</label>
                <input id="regForm_pan" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">FATHER NAME</label>
                <input id="regForm_father" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">QUALIFICATION</label>
                <input id="regForm_qualification" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">PERMANENT ADDRESS</label>
              <textarea id="regForm_address" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;height:60px;" ></textarea>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">DOB</label>
                <input id="regForm_dob" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">REQUIRED COMPANY NAME</label>
                <input id="regForm_company" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
          </div>
        </div>
        
        <!-- EXPERIENCE INFORMATION Section -->
        <div>
          <h3 style="margin:0 0 10px 0;font-size:14px;font-weight:700;color:#1f3d6b;">EXPERIENCE INFORMATION</h3>
          <div style="display:grid;gap:8px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Offer Date</label>
                <input id="regForm_offerDate" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Joining Date</label>
                <input id="regForm_joiningDate" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Offer Designation</label>
                <input id="regForm_offerDesig" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Present Designation</label>
                <input id="regForm_presentDesig" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Offer CTC</label>
                <input id="regForm_offerCtc" type="number" step="1" onblur="this.value=fmtInt(this.value)" onchange="this.value=fmtInt(this.value)" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Current CTC</label>
                <input id="regForm_currentCtc" type="number" step="1" onblur="this.value=fmtInt(this.value)" onchange="this.value=fmtInt(this.value)" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Hike Date</label>
                <input id="regForm_hikeDate" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Technology</label>
                <input id="regForm_technology" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Bank Account No</label>
                <input id="regForm_bankAcct" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">IFSC</label>
                <input id="regForm_ifsc" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">UAN</label>
                <input id="regForm_uan" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Resignation Date</label>
                <input id="regForm_resignationDate" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Relieving Date</label>
                <input id="regForm_relievingDate" type="text" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;" />
              </div>
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#334155;display:block;margin-bottom:3px;">Note</label>
              <textarea id="regForm_note" style="border:1px solid #999;padding:8px;font-size:12px;width:100%;box-sizing:border-box;height:40px;" >Need the new PF account to be created in this UAN</textarea>
            </div>
          </div>
        </div>
      </div>
      
      <!-- CTC Explanation Panel -->
      <div id="ctcExplainPanel" style="display:none;margin-top:20px;border:1px solid #d9dee8;border-radius:10px;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,0.12);overflow:hidden;">
        <div style="background:#1f3d6b;color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-weight:700;font-size:15px;">CTC Calculation Explanation</span>
          <div>
            <button type="button" onclick="copyCtcExplain()" style="background:#2d7d46;color:#fff;border:none;padding:7px 14px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:8px;font-weight:600;">Copy</button>
            <button type="button" onclick="hideCtcExplanation()" style="background:#64748b;color:#fff;border:none;padding:7px 14px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">Close</button>
          </div>
        </div>
        <div id="ctcExplainContent" style="padding:18px;max-height:420px;overflow-y:auto;font-size:14px;line-height:1.65;color:#1e293b;"></div>
        <div id="ctcCopyToast" style="display:none;position:absolute;top:10px;right:10px;background:#2d7d46;color:#fff;padding:8px 16px;border-radius:4px;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-weight:600;">Copied successfully</div>
      </div>
    </div>
    <div class="modalActions">
      <div id="regWordStatus" style="font-size:12px;color:#334155;margin-right:auto;"></div>
      <button type="button" class="modalBtn" onclick="toggleCtcExplanation()" style="background:#2d7d46;margin-right:10px;">Explain CTC Calculation</button>
      <button class="modalBtn gray" type="button" onclick="closeRegistrationFormModal()">Close</button>
      <button type="button" id="regFormExportWordBtn" class="modalBtn" onclick="exportRegistrationFormWord()">Export Word</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCMf4oteHAswn-IGvVbbkYnCciNueKGyjY",
  authDomain: "hirereadyservices-9a8de.firebaseapp.com",
  projectId: "hirereadyservices-9a8de",
  storageBucket: "hirereadyservices-9a8de.firebasestorage.app",
  messagingSenderId: "677972277573",
  appId: "1:677972277573:web:fab51d25a84ef03d0ea62c"
};

const ADMIN_EMAILS = [
  "ducktales048@gmail.com"
].map(e => (e || "").toLowerCase());

let customFieldsCache = [];
let auth, db;
let firebaseReady = false;
let useLocalStorage = false; // Demo mode
let servicesCatalog = [];
let credentialsList = [];
let passwordCache = {};
let currentUser = null;

console.log("FIREBASE_LIB_CHECK", { firebase: typeof window.firebase });

if (typeof window.firebase === "undefined") {
  firebaseReady = false;
} else {
  try {
    if (!firebase.apps?.length) {
      firebase.initializeApp(firebaseConfig);
    } else {
      firebase.app();
    }
    auth = firebase.auth();
    db = firebase.firestore ? firebase.firestore() : null;
    console.log("FIREBASE_PROJECT_OK", firebase.app().options.projectId);
    
    // Set global handles for Firebase
    window.firebaseApp = firebase.app();
    window.auth = auth;
    window.db = db;
    
    firebaseReady = true;
    console.log("FIREBASE_INIT_OK");
    
    // Check for file:// protocol warning
    if (location.protocol === "file:") {
      console.warn("FILE_PROTOCOL_WARNING: Running from file:// breaks cross-device shared localStorage. Use Netlify URL instead.");
    }
  } catch (err) {
    console.error("FIREBASE_INIT_FAIL", err);
    firebaseReady = false;
  }
}

// PATCH 2: Helper functions
function setView(state) {
  // state: "login" | "list" | "form"
  const login = document.getElementById("loginSection");
  const app = document.getElementById("appSection");
  const list = document.getElementById("listView");
  const form = document.getElementById("formView");

  if (!login || !app || !list || !form) {
    console.error("setView() missing required DOM nodes");
    return;
  }

  if (state === "login") {
    login.style.display = "flex";
    app.style.display = "none";
    list.style.display = "none";
    form.style.display = "none";
    return;
  }

  // app visible
  login.style.display = "none";
  app.style.display = "block";

  if (state === "list") {
    list.style.display = "block";
    form.style.display = "none";
    return;
  }

  if (state === "form") {
    list.style.display = "none";
    form.style.display = "block";
    return;
  }

  // fallback
  list.style.display = "block";
  form.style.display = "none";
}

function safeJsonParse(value, key) {
  try {
    return JSON.parse(value);
  } catch (e) {
    console.warn("safeJsonParse failed for key:", key, e);
    return null;
  }
}

async function sha256(text) {
  const data = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

function computeEndDate(planType, startDate) {
  const base = new Date(startDate);
  const end = new Date(base);
  
  const planDurationMap = {
    'demo3days': 3,
    'demo7days': 7,
    '1month': 30,
    '2months': 60,
    '3months': 90,
    '6months': 180,
    '12months': 365
  };
  
  const durationDays = planDurationMap[planType] || 7;
  end.setDate(end.getDate() + durationDays);
  return end;
}

function isSubscriptionExpired(subscription) {
  if (!subscription) return false;
  const endRaw = subscription.endDate || subscription.subscriptionEnd || subscription.end;
  if (!endRaw) return false;
  const endDate = new Date(endRaw);
  if (isNaN(endDate.getTime())) return false;
  const endOfDay = new Date(endDate);
  endOfDay.setHours(23, 59, 59, 999);
  return new Date() > endOfDay;
}

function generateStrongPassword() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";
  let out = "";
  for (let i = 0; i < 12; i++) {
    out += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return out;
}

async function loadServicesCatalog() {
  if (!db) return;
  try {
    const catalogDoc = await db.collection("services_catalog").doc("global").get();
    if (catalogDoc.exists) {
      const data = catalogDoc.data() || {};
      servicesCatalog = data.services || [];
    } else {
      servicesCatalog = getDefaultServices();
    }
  } catch (err) {
    console.error("loadServicesCatalog failed", err);
    servicesCatalog = getDefaultServices();
  }
}

function getDefaultServices() {
  return [
    { key: "jdMatchResume", name: "JD Match Resume" },
    { key: "callScript", name: "Call Script" },
    { key: "mockInterview", name: "Mock Interview" },
    { key: "liveAssistant", name: "Live Assistant" },
    { key: "smartApply", name: "SmartApply" }
  ];
}

function renderServiceAccessToggles(serviceAccess) {
  const container = document.getElementById("serviceAccessList");
  if (!container) return;
  const services = servicesCatalog.length > 0 ? servicesCatalog : getDefaultServices();
  container.innerHTML = "";
  services.forEach(svc => {
    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "center";
    wrapper.style.gap = "8px";
    wrapper.innerHTML = `
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" class="svc-access-toggle" data-service-key="${svc.key}" ${serviceAccess?.[svc.key] !== false ? "checked" : ""} />
        <span>${svc.name}</span>
      </label>
    `;
    container.appendChild(wrapper);
  });
}

function getDurationDays(planType) {
  const planDurationMap = {
    'demo3days': 3,
    'demo7days': 7,
    '1month': 30,
    '2months': 60,
    '3months': 90,
    '6months': 180,
    '12months': 365
  };
  return planDurationMap[planType] || 7;
}

function getAdminCandidateId() {
  const cidEl = document.getElementById("candidateId");
  if (!cidEl) return "";
  const cid = (cidEl.value || "").trim();
  return cid;
}

function isCurrentUserAdmin() {
  if (!currentUser) return false;
  const email = (currentUser.email || "").toLowerCase();
  return ADMIN_EMAILS.includes(email);
}

function updateAdminEndDate() {
  const planEl = document.getElementById('subscriptionPlanType');
  const startEl = document.getElementById('subscriptionStartDate');
  const endEl = document.getElementById('subscriptionEndDate');
  
  if (!planEl || !startEl || !endEl) return;
  
  const plan = (planEl.value || "").trim();
  const startDateStr = (startEl.value || "").trim();
  
  if (plan && startDateStr) {
    const startDate = new Date(startDateStr);
    if (!isNaN(startDate.getTime())) {
      const endDate = computeEndDate(plan, startDate);
      endEl.value = endDate.toISOString().split('T')[0];
    }
  }
}

function setupSubscriptionFieldListeners() {
  const planEl = document.getElementById('subscriptionPlanType');
  const startEl = document.getElementById('subscriptionStartDate');
  
  if (planEl) {
    planEl.addEventListener('change', updateAdminEndDate);
  }
  if (startEl) {
    startEl.addEventListener('change', updateAdminEndDate);
  }
}

async function applySubscriptionPlan() {
  if (!currentUser) {
    popupError("Admin not authenticated. Please log in.");
    return;
  }
  
  if (!db) {
    popupError("Firebase not initialized");
    return;
  }
  
  const cid = getAdminCandidateId();
  if (!cid) {
    popupError("Please enter or load a Candidate ID");
    return;
  }
  
  const planEl = document.getElementById("subscriptionPlanType");
  const startEl = document.getElementById("subscriptionStartDate");
  const endEl = document.getElementById("subscriptionEndDate");
  const statusEl = document.getElementById("subscriptionStatus");
  
  const plan = (planEl.value || "").trim();
  const startDateStr = (startEl.value || "").trim();
  const status = (statusEl.value || "ACTIVE").trim();
  
  if (!plan) {
    popupError("Please select a Plan Type");
    return;
  }
  if (!startDateStr) {
    popupError("Please select a Start Date");
    return;
  }
  
  const startDate = new Date(startDateStr);
  if (isNaN(startDate.getTime())) {
    popupError("Invalid start date");
    return;
  }
  
  const endDate = computeEndDate(plan, startDate);
  const endDateStr = endDate.toISOString().split('T')[0];
  const durationDays = getDurationDays(plan);
  
  const applyBtn = document.querySelector('button[onclick="applySubscriptionPlan()"]');
  if (applyBtn) applyBtn.disabled = true;
  
  try {
    // Write to candidate/{cid}/subscription/current path
    const subscriptionRef = db.collection('candidate').doc(cid).collection('subscription').doc('current');
    
    await subscriptionRef.set(
      {
        planType: plan,
        startDate: startDateStr,
        endDate: endDateStr,
        status: status,
        durationDays: durationDays,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },
      { merge: true }
    );
    
    // Immediately re-read to confirm
    const docSnap = await subscriptionRef.get();
    if (docSnap.exists) {
      const data = docSnap.data();
      endEl.value = data.endDate || endDateStr;
      statusEl.value = data.status || status;
      
      const msg = document.getElementById("statusMsg");
      if (msg) {
        msg.innerHTML = 'Subscription applied successfully <span class="badge ok"></span>';
        setTimeout(() => { msg.innerHTML = ""; }, 3000);
      }
    }
  } catch (error) {
    popupError("Error applying subscription: " + (error.message || error));
  } finally {
    if (applyBtn) applyBtn.disabled = false;
  }
}

async function refreshSubscriptionStatus() {
  if (!currentUser) {
    popupError("Admin not authenticated. Please log in.");
    return;
  }
  
  if (!db) {
    popupError("Firebase not initialized");
    return;
  }
  
  const cid = getAdminCandidateId();
  if (!cid) {
    popupError("Please enter or load a Candidate ID");
    return;
  }
  
  const planEl = document.getElementById("subscriptionPlanType");
  const startEl = document.getElementById("subscriptionStartDate");
  const endEl = document.getElementById("subscriptionEndDate");
  const statusEl = document.getElementById("subscriptionStatus");
  
  const refreshBtn = document.querySelector('button[onclick="refreshSubscriptionStatus()"]');
  if (refreshBtn) refreshBtn.disabled = true;
  
  try {
    // Read from candidate/{cid}/subscription/current path
    const subscriptionRef = db.collection('candidate').doc(cid).collection('subscription').doc('current');
    const docSnap = await subscriptionRef.get();
    
    if (!docSnap.exists) {
      const msg = document.getElementById("statusMsg");
      if (msg) {
        msg.innerHTML = 'No subscription saved yet';
        setTimeout(() => { msg.innerHTML = ""; }, 2000);
      }
      return;
    }
    
    const data = docSnap.data();
    
    planEl.value = data.planType || 'demo7days';
    startEl.value = data.startDate || '';
    endEl.value = data.endDate || '';
    statusEl.value = data.status || 'ACTIVE';
    
    const msg = document.getElementById("statusMsg");
    if (msg) {
      msg.innerHTML = 'Status refreshed <span class="badge ok"></span>';
      setTimeout(() => { msg.innerHTML = ""; }, 2000);
    }
  } catch (error) {
    popupError("Error refreshing subscription: " + (error.message || error));
  } finally {
    if (refreshBtn) refreshBtn.disabled = false;
  }
}

async function refreshCredentialsList() {
  if (!db) return;
  try {
    const snap = await db.collection("candidates").orderBy("updatedAt", "desc").limit(200).get();
    credentialsList = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() || {}) }));
    renderCredentialsTable(credentialsList);
  } catch (err) {
    console.error("refreshCredentialsList failed", err);
    popupError("Failed to load credentials: " + (err.message || err));
  }
}

function getCandidateDisplayName(data) {
  return data.fullName || data.payload?.fullName || data.name || data.candidateName || "";
}

// Track visibility state for current passwords (cid -> boolean)
const currentPasswordVisible = new Map();

function renderCredentialsTable(items) {
  const tbody = document.getElementById("credentialsTableBody");
  const count = document.getElementById("credRecordCount");
  if (!tbody) return;
  tbody.innerHTML = "";

  items.forEach(item => {
    const cid = item.candidateId || item.id || "";
    const name = getCandidateDisplayName(item);
    const hasHash = !!item.passwordHash;
    const masked = hasHash ? "" : "Not set";
    const isSecure = hasHash; // Passwords stored as SHA-256 hashes

    const tr = document.createElement("tr");
    tr.style.borderBottom = "1px solid #d7deea";
    tr.innerHTML = `
      <td style="border:1px solid #d7deea;padding:10px 12px;">${escHtml(cid)}</td>
      <td style="border:1px solid #d7deea;padding:10px 12px;">${escHtml(name)}</td>
      <td style="border:1px solid #d7deea;padding:10px 12px;">
        <div class="current-pw-cell">
          <span class="pw-value" id="pwValue_${escHtml(cid)}">${masked}</span>
          ${hasHash ? `
          <div class="pw-actions">
            <button class="pw-icon-btn" type="button" data-action="toggle-current-pw" data-cid="${escHtml(cid)}" title="Show/Hide password"></button>
            <button class="pw-icon-btn" type="button" data-action="copy-current-pw" data-cid="${escHtml(cid)}" title="Copy current password"></button>
          </div>
          ` : ''}
        </div>
      </td>
      <td style="border:1px solid #d7deea;padding:10px 12px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <input class="cred-input new-password-input" type="password" data-cred-input="${escHtml(cid)}" placeholder="New password" style="flex:1;" />
          <button class="cred-btn-icon" type="button" data-action="toggle-pw-visibility" data-cid="${escHtml(cid)}" title="Show/Hide password" style="padding:8px;cursor:pointer;border:1px solid #d7deea;background:#fff;border-radius:4px;font-size:16px;"></button>
        </div>
      </td>
      <td style="border:1px solid #d7deea;padding:10px 12px;">
        <div class="cred-actions">
          <button class="cred-btn warn" type="button" onclick="resetCandidatePassword('${escHtml(cid)}')">Reset</button>
          <button class="cred-btn primary" type="button" data-action="generate" data-cid="${escHtml(cid)}">Generate</button>
          <button class="cred-btn success" type="button" onclick="copyCandidatePassword('${escHtml(cid)}')">Copy</button>
          <button class="cred-btn primary" type="button" onclick="saveCandidatePassword('${escHtml(cid)}')">Save</button>
          <button class="cred-btn danger" type="button" onclick="confirmDeleteCandidate('${escHtml(cid)}')">Delete</button>
        </div>
        <div class="cred-msg" data-cred-msg="${escHtml(cid)}"></div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  if (count) count.textContent = "Total credentials: " + items.length;
}

function filterCredentials() {
  const val = (document.getElementById("credSearchInput").value || "").toLowerCase();
  const filtered = credentialsList.filter(item => {
    const cid = String(item.candidateId || item.id || "").toLowerCase();
    const name = String(getCandidateDisplayName(item) || "").toLowerCase();
    return cid.includes(val) || name.includes(val);
  });
  renderCredentialsTable(filtered);
}

function clearCredentialsSearch() {
  document.getElementById("credSearchInput").value = "";
  renderCredentialsTable(credentialsList);
}

function resetCandidatePassword(cid) {
  const input = document.querySelector(`[data-cred-input="${cid}"]`);
  if (!input) return;
  const pw = generateStrongPassword();
  input.value = pw;
  passwordCache[cid] = pw;
  alert("New password for " + cid + ": " + pw + "\n\nCopy it now. It will not be shown again.");
}

function generateMemorablePassword() {
  const words = [
    "Mango","River","Tiger","Cloud","Sunny","Forest","Amber","Pebble","Rocket","Silver",
    "Cedar","Ocean","Falcon","Meadow","Velvet","Harbor","Quartz","Comet","Maple","Breeze",
    "Lemon","Shadow","Cobalt","Waffle","Sparrow","Glacier","Marble","Cactus","Orchid","Nimbus",
    "Willow","Lagoon","Copper","Velvet","Prairie","Summit","Canyon","Rocket","Jungle","Crimson",
    "Bamboo","Pluto","Olive","Quartz","Tundra","Coral","Raven","Aspen","Saffron","Cypress",
    "Petal","Garnet","Lotus","Aurora","Mariner","Clover","Pine","Sierra","Puma","Nova",
    "Ember","Fjord","Sable","Vista","Topaz","Poppy","Citrus","Drift","Monarch","Zephyr"
  ];
  const digits = ["2","3","4","5","6","7","8","9"];
  const specials = ["@", "#", "$", "!", "%", "&"];

  for (let i = 0; i < 50; i++) {
    const w1 = words[Math.floor(Math.random() * words.length)];
    let w2 = words[Math.floor(Math.random() * words.length)];
    if (w2 === w1) w2 = words[(words.indexOf(w1) + 3) % words.length];
    const d1 = digits[Math.floor(Math.random() * digits.length)];
    const d2 = digits[Math.floor(Math.random() * digits.length)];
    const sp = specials[Math.floor(Math.random() * specials.length)];
    const pw = `${w1}${w2}${d1}${d2}${sp}`;
    if (pw.length >= 10 && pw.length <= 12) {
      return pw;
    }
  }

  const fallback = `MangoRiver${digits[Math.floor(Math.random() * digits.length)]}${digits[Math.floor(Math.random() * digits.length)]}${specials[Math.floor(Math.random() * specials.length)]}`;
  return fallback.length > 12 ? fallback.slice(0, 12) : fallback;
}

function wireCredentialsEventsOnce() {
  const tbody = document.getElementById("credentialsTableBody");
  if (!tbody) return;
  if (tbody.getAttribute("data-wired") === "1") return;
  tbody.setAttribute("data-wired", "1");

  tbody.addEventListener("click", function (ev) {
    // Handle Generate button
    const generateBtn = ev.target.closest("button[data-action='generate']");
    if (generateBtn) {
      const cid = generateBtn.getAttribute("data-cid");
      if (!cid) return;
      const input = document.querySelector(`[data-cred-input="${cid}"]`);
      if (!input) return;
      const pw = generateMemorablePassword();
      input.value = pw;
      passwordCache[cid] = pw;

      const msg = document.querySelector(`[data-cred-msg="${cid}"]`);
      if (msg) {
        msg.textContent = "Generated + copied";
        setTimeout(() => { msg.textContent = ""; }, 2000);
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(pw).catch(() => {});
      }
      return;
    }

    // Handle password visibility toggle (new password)
    const toggleBtn = ev.target.closest("button[data-action='toggle-pw-visibility']");
    if (toggleBtn) {
      const cid = toggleBtn.getAttribute("data-cid");
      if (!cid) return;
      const input = document.querySelector(`[data-cred-input="${cid}"]`);
      if (!input) return;
      if (input.type === "password") {
        input.type = "text";
        toggleBtn.textContent = "";
      } else {
        input.type = "password";
        toggleBtn.textContent = "";
      }
      return;
    }

    // Handle current password visibility toggle
    const toggleCurrentBtn = ev.target.closest("button[data-action='toggle-current-pw']");
    if (toggleCurrentBtn) {
      const cid = toggleCurrentBtn.getAttribute("data-cid");
      if (!cid) return;
      toggleCurrentPassword(cid);
      return;
    }

    // Handle copy current password
    const copyCurrentBtn = ev.target.closest("button[data-action='copy-current-pw']");
    if (copyCurrentBtn) {
      const cid = copyCurrentBtn.getAttribute("data-cid");
      if (!cid) return;
      copyCurrentPassword(cid);
      return;
    }
  });
}

function toggleCurrentPassword(cid) {
  const pwValueEl = document.getElementById(`pwValue_${cid}`);
  if (!pwValueEl) return;

  const candidate = credentialsList.find(c => (c.candidateId || c.id) === cid);
  if (!candidate || !candidate.passwordHash) return;

  const isVisible = currentPasswordVisible.get(cid) || false;
  
  if (isVisible) {
    // Hide password
    pwValueEl.textContent = "";
    currentPasswordVisible.set(cid, false);
  } else {
    // Show password - fetch from stored plain text if available, otherwise show hash
    // Note: In reality, you can't reverse SHA-256, so this would only work if you store plain passwords
    // For demo purposes, we'll show a note that passwords are hashed
    if (candidate.plainPassword) {
      pwValueEl.textContent = candidate.plainPassword;
    } else {
      // Can't show hashed password as plain text
      pwValueEl.textContent = "[Hashed - cannot display]";
    }
    currentPasswordVisible.set(cid, true);
  }
}

function copyCurrentPassword(cid) {
  const isVisible = currentPasswordVisible.get(cid) || false;
  
  if (!isVisible) {
    // Show alert - password must be revealed first
    const msg = document.querySelector(`[data-cred-msg="${cid}"]`);
    if (msg) {
      msg.textContent = "Unhide password to copy";
      msg.style.color = "#b45309";
      setTimeout(() => { 
        msg.textContent = ""; 
        msg.style.color = "#2d7d46";
      }, 2000);
    }
    return;
  }

  const candidate = credentialsList.find(c => (c.candidateId || c.id) === cid);
  if (!candidate) return;

  const password = candidate.plainPassword || "";
  
  if (!password) {
    popupError("Password is hashed and cannot be copied");
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(password).then(() => {
      const msg = document.querySelector(`[data-cred-msg="${cid}"]`);
      if (msg) {
        msg.textContent = "Password copied";
        setTimeout(() => { msg.textContent = ""; }, 2000);
      }
    }).catch(() => {
      popupError("Copy failed");
    });
  }
}

async function saveCandidatePassword(cid) {
  const input = document.querySelector(`[data-cred-input="${cid}"]`);
  if (!input || !input.value.trim()) {
    popupError("Enter a password before saving.");
    return;
  }
  const plainPw = input.value.trim();
  const hash = await sha256(plainPw);
  try {
    // Save both hash (for authentication) and plain password (for admin visibility)
    await db.collection("candidates").doc(cid).set({ 
      passwordHash: hash,
      plainPassword: plainPw
    }, { merge: true });
    setStatus("Password saved for " + cid, true);
    input.value = "";
    refreshCredentialsList();
  } catch (err) {
    console.error("saveCandidatePassword failed", err);
    popupError("Failed to save password: " + (err.message || err));
  }
}

function copyCandidatePassword(cid) {
  const input = document.querySelector(`[data-cred-input="${cid}"]`);
  const val = input ? input.value.trim() : "";
  const pw = val || passwordCache[cid] || "";
  if (!pw) {
    popupError("No password to copy. Generate or enter a password first.");
    return;
  }
  navigator.clipboard.writeText(pw).then(() => {
    setStatus("Password copied to clipboard", true);
    const msg = document.querySelector(`[data-cred-msg="${cid}"]`);
    if (msg) {
      msg.textContent = "Copied!";
      setTimeout(() => { msg.textContent = ""; }, 1500);
    }
  }).catch(() => {
    popupError("Copy failed. Please copy manually.");
  });
}

function confirmDeleteCandidate(cid) {
  const candidate = candidatesList.find(c => (c.candidateId || c.id) === cid);
  const name = candidate ? getCandidateDisplayName(candidate) : cid;
  
  const modal = document.createElement('div');
  modal.id = 'deleteConfirmModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
  
  modal.innerHTML = `
    <div style="background:#fff;border-radius:12px;padding:32px;max-width:480px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 16px;color:#dc2626;font-size:22px;font-weight:700;">Delete Candidate</h3>
      <p style="margin:0 0 20px;color:#334155;font-size:15px;line-height:1.6;">
        You are about to permanently delete:<br>
        <strong>${escHtml(name)}</strong> (ID: ${escHtml(cid)})<br><br>
        This action cannot be undone. All data including credentials, subscription info, and service access will be deleted.
      </p>
      <p style="margin:0 0 16px;color:#64748b;font-size:14px;">
        To confirm, type <strong>DELETE</strong> (uppercase) in the box below:
      </p>
      <input type="text" id="deleteConfirmInput" placeholder="Type DELETE" style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:6px;font-size:14px;margin-bottom:20px;box-sizing:border-box;" />
      <div style="display:flex;gap:12px;justify-content:flex-end;">
        <button onclick="closeDeleteModal()" style="padding:10px 20px;border:1px solid #cbd5e1;background:#f8fafc;color:#334155;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;">Cancel</button>
        <button onclick="executeDeleteCandidate('${escHtml(cid)}')" style="padding:10px 20px;border:none;background:#dc2626;color:#fff;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;">Delete Permanently</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.getElementById('deleteConfirmInput').focus();
}

function closeDeleteModal() {
  const modal = document.getElementById('deleteConfirmModal');
  if (modal) modal.remove();
}

async function executeDeleteCandidate(cid) {
  const input = document.getElementById('deleteConfirmInput');
  if (!input || input.value !== 'DELETE') {
    popupError('Please type DELETE (uppercase) to confirm');
    return;
  }
  
  try {
    // Delete from Firestore
    await db.collection('candidates').doc(cid).delete();
    
    // Remove from local list
    candidatesList = candidatesList.filter(c => (c.candidateId || c.id) !== cid);
    credentialsList = credentialsList.filter(c => (c.candidateId || c.id) !== cid);
    
    // Clear localStorage
    localStorage.removeItem('candidate_' + cid);
    localStorage.removeItem('servicesAccess_' + cid);
    localStorage.removeItem('candidateAuth_' + cid);
    
    // Refresh UI
    renderCandidateList(candidatesList);
    renderCredentialsTable(credentialsList);
    
    closeDeleteModal();
    setStatus('Candidate deleted successfully', true);
  } catch (err) {
    console.error('Delete candidate failed:', err);
    popupError('Failed to delete candidate: ' + (err.message || err));
  }
}

function openRegistrationLink() {
  const origin = window.location.origin;
  const regUrl = origin + '/registration.html';
  window.open(regUrl, '_blank');
}

function copyRegistrationLink(cid) {
  const origin = window.location.origin;
  const regUrl = cid ? `${origin}/registration.html?cid=${encodeURIComponent(cid)}` : `${origin}/registration.html`;
  
  navigator.clipboard.writeText(regUrl).then(() => {
    setStatus('Registration link copied to clipboard', true);
  }).catch(() => {
    popupError('Copy failed. Link: ' + regUrl);
  });
}

function wireListEventsOnce() {
  const tbody = document.getElementById("candidatesTableBody");
  if (!tbody) return;

  if (tbody.getAttribute("data-wired") === "1") return;
  tbody.setAttribute("data-wired", "1");

  tbody.addEventListener("click", function (ev) {
    const btn = ev.target.closest("button[data-action='edit']");
    if (!btn) return;
    const cid = btn.getAttribute("data-cid");
    if (!cid) return;
    editCandidate(cid);
  });
}

// ============================================================
// FIRESTORE SYNC FUNCTION
// ============================================================
async function syncFromCloud() {
  console.log("syncFromCloud_START");

  const u = firebase.auth().currentUser;
  if (!u) {
    console.warn("SKIP_FIRESTORE_NOT_LOGGED_IN");
    return;
  }
  const email = (u.email || "").toLowerCase();
  if (!ADMIN_EMAILS.includes(email)) {
    console.warn("SKIP_FIRESTORE_NOT_ADMIN", email);
    return;
  }
  
  if (!window.db) {
    console.error("syncFromCloud_FAIL: Firestore not initialized");
    popupError("Firestore is not initialized. Check console for errors.");
    return;
  }
  
  try {
    const snapshot = await window.db
      .collection("candidates")
      .orderBy("updatedAt", "desc")
      .limit(50)
      .get();
    
    console.log("syncFromCloud_QUERY_OK", { docCount: snapshot.docs.length });
    
    let syncedCount = 0;
    snapshot.docs.forEach((doc) => {
      try {
        const cloudData = doc.data();
        if (cloudData && cloudData.candidateId && cloudData.payload) {
          const candidateId = cloudData.candidateId;
          const merged = {
            ...cloudData.payload,
            servicesAccess: cloudData.servicesAccess || {},
            subscription: cloudData.subscription || {
              planType: cloudData.subscriptionPlan || "demo",
              startDate: cloudData.subscriptionStart || "",
              endDate: cloudData.subscriptionEnd || "",
              status: cloudData.subscriptionStatus || ""
            }
          };
          localStorage.setItem(
            "candidate_" + candidateId,
            JSON.stringify(merged)
          );
          syncedCount++;
        }
      } catch (docErr) {
        console.warn("syncFromCloud_DOC_ERROR", docErr);
      }
    });
    
    console.log("syncFromCloud_CACHE_OK", { syncedCount, totalDocs: snapshot.docs.length });
    
    // Refresh the list to show synced candidates
    refreshList();
    setStatus("Synced " + syncedCount + " candidate(s) from cloud.", true);
    console.log("syncFromCloud_COMPLETE");
    
  } catch (err) {
    console.error("syncFromCloud_ERROR", err);
    const errCode = err?.code || "";
    const errMsg = err?.message || "Unknown error";
    
    // Check for permission denied
    if (errCode === "permission-denied" || errMsg.includes("permission")) {
      popupError(
        "Permission denied: Firestore rules may block this operation. \n\n" +
        "Allow authenticated users to read 'candidates' collection, or check your security rules.\n\n" +
        "Error: " + errMsg
      );
    } else {
      popupError("Cloud sync failed: " + errMsg);
    }
    setStatus("Cloud sync failed.", false);
  }
}

function handleLogin(event) {
  if (event) event.preventDefault();

  const e = (document.getElementById("loginEmail").value || "").trim();
  const p = (document.getElementById("loginPassword").value || "").trim();

  console.log("LOGIN_HANDLER_FIRED", { email: e, hasPassword: !!p });

  if (!e || !p) {
    popupError("Enter email and password");
    return;
  }

  if (!firebaseReady || !auth) {
    popupError("Firebase libraries failed to load. Check network/CSP.");
    return;
  }

  auth.signInWithEmailAndPassword(e, p)
    .then((cred) => {
      console.log("LOGIN_OK", cred && cred.user ? cred.user.email : "");
      localStorage.setItem("role", "admin");
    })
    .catch((err) => {
      console.error("LOGIN_FAILED", err);
      const code = err && err.code ? err.code : "";
      let msg = "Login failed";
      if (code === "auth/wrong-password" || code === "auth/invalid-credential") {
        msg = "Invalid email or password";
      } else if (code === "auth/user-not-found") {
        msg = "No account found for this email";
      } else {
        msg = "Login failed: " + ((err && (err.message || err.code)) || "Unknown error");
      }
      popupError(msg);
    });
}

function handleLogout() {
  if (!firebaseReady || !auth) {
    setView("login");
    return;
  }

  auth.signOut()
    .then(() => {
      console.log("LOGOUT_OK");
    })
    .catch((err) => {
      console.error("LOGOUT_FAILED", err);
    });

  // Optional: clear login inputs for clean UX
  const emailEl = document.getElementById("loginEmail");
  const passEl = document.getElementById("loginPassword");
  if (emailEl) emailEl.value = "";
  if (passEl) passEl.value = "";

  localStorage.removeItem("role");

  clearForm();
  setView("login");
  console.log("LOGOUT_COMPLETE");
}

function setStatus(m, g) {
  const el = document.getElementById("statusMsg");
  el.innerHTML = m + (g ? '<span class="badge ok"></span>' : '<span class="badge err"></span>');
}

function popupError(m) {
  document.getElementById("modalHead").textContent = "Error";
  document.getElementById("modalBody").textContent = m;
  document.getElementById("modalBackdrop").style.display = "flex";
}

function closeModal() {
  document.getElementById("modalBackdrop").style.display = "none";
}

function onlyDigits(e) {
  if (!/[0-9]/.test(e.key)) e.preventDefault();
}

function isLeapYear(y){
  return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
}

function daysInMonthStrict(y, m1to12){
  const m = m1to12;
  if (m === 2) return isLeapYear(y) ? 29 : 28;
  if ([4,6,9,11].includes(m)) return 30;
  return 31;
}

function parseDMY(s){
  if (!s) return null;
  const raw = String(s).trim();
  const parts = raw.split("/");
  if (parts.length !== 3) return null;

  const dd = parts[0].trim();
  const mm = parts[1].trim();
  const yyyy = parts[2].trim();

  if (!/^\d{1,2}$/.test(dd)) return null;
  if (!/^\d{1,2}$/.test(mm)) return null;
  if (!/^\d{4}$/.test(yyyy)) return null;

  const d = Number(dd);
  const m = Number(mm);
  const y = Number(yyyy);

  if (y < 1900 || y > 2100) return null;
  if (m < 1 || m > 12) return null;

  const dim = daysInMonthStrict(y, m);
  if (d < 1 || d > dim) return null;

  const date = new Date(y, m - 1, d);
  // Extra safety: ensure no overflow occurred
  if (date.getFullYear() !== y || (date.getMonth() + 1) !== m || date.getDate() !== d) return null;

  return date;
}

function pad2(n) { return String(n).padStart(2, "0"); }

function formatDMY(d) {
  if (!d || isNaN(d.getTime())) return "";
  return pad2(d.getDate()) + "/" + pad2(d.getMonth() + 1) + "/" + d.getFullYear();
}

function addDays(date, days) {
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  d.setDate(d.getDate() + days);
  return d;
}

function formatDMYLive(value){
  const v = String(value || "");
  // Always extract digits and rebuild from scratch - handles both typed digits and manual slashes
  const digits = v.replace(/\D/g,"").slice(0,8);
  const d = digits.slice(0,2);
  const m = digits.slice(2,4);
  const y = digits.slice(4,8);
  let out = d;
  if (digits.length > 2) out += "/" + m;
  if (digits.length > 4) out += "/" + y;
  return out;
}

function normalizeDMYOnBlur(value){
  const raw = String(value || "").trim();
  if (!raw) return "";
  const parts = raw.split("/");
  if (parts.length !== 3) return null;

  let d = parts[0].trim().replace(/\D/g,"");
  let m = parts[1].trim().replace(/\D/g,"");
  let y = parts[2].trim().replace(/\D/g,"");

  if (d.length === 1) d = "0" + d;
  if (m.length === 1) m = "0" + m;

  if (d.length !== 2 || m.length !== 2 || y.length !== 4) return null;

  const candidate = d + "/" + m + "/" + y;
  return parseDMY(candidate) ? candidate : null;
}

function wireStrictDMYInput(el){
  if (!el) return;
  if (el.dataset.dmyWired === "1") return;
  el.dataset.dmyWired = "1";

  // store last valid value
  if (!el.dataset.lastValid) el.dataset.lastValid = "";

  el.addEventListener("input", function(){
    const before = el.value;
    const caret = el.selectionStart || 0;
    const next = formatDMYLive(before);
    el.value = next;

    // keep caret stable
    const delta = next.length - before.length;
    const pos = Math.max(0, Math.min(next.length, caret + delta));
    try { el.setSelectionRange(pos, pos); } catch(e) {}
  });

  el.addEventListener("blur", function(){
    const normalized = normalizeDMYOnBlur(el.value);

    if (normalized === "") {
      el.value = "";
      el.dataset.lastValid = "";
      el.classList.remove("dateInvalid");
      // trigger downstream recompute when cleared
      if (typeof onCompanyDatesChanged === "function") onCompanyDatesChanged();
      return;
    }

    if (normalized === null) {
      popupWarn("Invalid date. Please enter a valid date in DD/MM/YYYY format. Example: 02/11/2026.");
      el.classList.add("dateInvalid");
      // revert
      el.value = el.dataset.lastValid || "";
      if (typeof onCompanyDatesChanged === "function") onCompanyDatesChanged();
      return;
    }

    el.value = normalized;
    el.dataset.lastValid = normalized;
    el.classList.remove("dateInvalid");

    if (typeof onCompanyDatesChanged === "function") onCompanyDatesChanged();
  });
}

function attachDateInputBehavior(){
  const dateInputs = Array.from(document.querySelectorAll("input")).filter(el => {
    const ph = (el.getAttribute("placeholder") || "").toUpperCase();
    return ph.includes("DD/MM/YYYY");
  });
  dateInputs.forEach(wireStrictDMYInput);
}

function ymText(fromDate, toDate, includeDays) {
  if (!fromDate || !toDate) return "";
  if (isNaN(fromDate.getTime()) || isNaN(toDate.getTime())) return "";

  // Invalid chronological order
  if (toDate < fromDate) return "__INVALID__";

  let y = toDate.getFullYear() - fromDate.getFullYear();
  let m = toDate.getMonth() - fromDate.getMonth();
  let d = toDate.getDate() - fromDate.getDate();

  if (d < 0) { m--; d += 30; }
  if (m < 0) { y--; m += 12; }

  if (includeDays) {
    return y + " Years " + m + " Months " + d + " Days";
  }
  return y + " Years " + m + " Months";
}

function getCompanySections() {
  return Array.from(document.querySelectorAll("#companiesContainer .section"));
}

function setAutoLastWorkInput(lastWorkEl, dmy) {
  if (!lastWorkEl) return;
  lastWorkEl.value = dmy;
  lastWorkEl.setAttribute("data-autofill", "1");
}

function wireEmploymentEvents() {
  const sections = getCompanySections();
  sections.forEach(sec => {
    const joining = sec.querySelector("[data-co-joining]");
    const lastwork = sec.querySelector("[data-co-lastwork]");
    const exp = sec.querySelector("[data-co-expcomp]");

    if (joining && joining.getAttribute("data-emp-wired") !== "1") {
      joining.setAttribute("data-emp-wired", "1");
      joining.addEventListener("blur", function () {
        applyEmploymentChainingAndValidate(false);
      });
      joining.addEventListener("input", function () {
        // Live update without popups
        applyEmploymentChainingAndValidate(false);
      });
    }

    if (lastwork && lastwork.getAttribute("data-emp-wired") !== "1") {
      lastwork.setAttribute("data-emp-wired", "1");
      lastwork.addEventListener("input", function () {
        // If user edits last working, it is no longer auto-filled
        lastwork.removeAttribute("data-autofill");
        applyEmploymentChainingAndValidate(false);
      });
      lastwork.addEventListener("blur", function () {
        applyEmploymentChainingAndValidate(false);
      });
    }

    if (exp && exp.getAttribute("data-emp-wired") !== "1") {
      exp.setAttribute("data-emp-wired", "1");
      // Experience field remains editable by user requirement
    }
  });
}

function applyEmploymentChainingAndValidate(showPopup) {
  const sections = getCompanySections();
  if (!sections.length) return true;

  // Build arrays of inputs
  const rows = sections.map((sec, idx) => {
    return {
      idx,
      sec,
      joiningEl: sec.querySelector("[data-co-joining]"),
      lastEl: sec.querySelector("[data-co-lastwork]"),
      expEl: sec.querySelector("[data-co-expcomp]")
    };
  });

  // CHAINING for previous companies: set last working date = (next company joining - 1 day)
  for (let i = 1; i < rows.length; i++) {
    const nextJoinEl = rows[i - 1].joiningEl; // more recent company
    const thisLastEl = rows[i].lastEl;

    const nextJoin = nextJoinEl ? parseDMY(nextJoinEl.value) : null;
    if (!nextJoin || isNaN(nextJoin.getTime())) {
      // Cannot compute chain yet
      continue;
    }
    const computedLast = addDays(nextJoin, -1);
    const computedDMY = formatDMY(computedLast);

    // Only set if empty OR still auto-filled previously
    if (thisLastEl) {
      const isAuto = thisLastEl.getAttribute("data-autofill") === "1";
      const isEmpty = !(thisLastEl.value || "").trim();
      if (isEmpty || isAuto) {
        setAutoLastWorkInput(thisLastEl, computedDMY);
      }
    }
  }

  // VALIDATION + Experience calculation
  let canValidateFully = true;
  let errors = [];

  for (let i = 0; i < rows.length; i++) {
    const isCurrent = (i === 0);

    const joinText = rows[i].joiningEl ? (rows[i].joiningEl.value || "").trim() : "";
    const lastText = rows[i].lastEl ? (rows[i].lastEl.value || "").trim() : "";

    const join = joinText ? parseDMY(joinText) : null;
    let last = lastText ? parseDMY(lastText) : null;

    if (!join || isNaN(join.getTime())) {
      // Missing join date blocks full validation
      canValidateFully = false;
      if (rows[i].expEl) rows[i].expEl.value = "";
      continue;
    }

    // Rules:
    // - Current company: last date can be empty => Present (today)
    // - Previous companies: last date must never be treated as Present
    if (isCurrent) {
      if (!lastText) {
        last = new Date(); // Present for calculation only
      } else if (!last || isNaN(last.getTime())) {
        errors.push("Current/Recent Company: Last Working Date is invalid.");
        if (rows[i].expEl) rows[i].expEl.value = "";
        continue;
      }
    } else {
      if (!lastText) {
        // Should not happen because chaining tries to fill it, but still validate
        canValidateFully = false;
        if (rows[i].expEl) rows[i].expEl.value = "";
        continue;
      }
      if (!last || isNaN(last.getTime())) {
        errors.push("Previous Company " + i + ": Last Working Date is invalid.");
        if (rows[i].expEl) rows[i].expEl.value = "";
        continue;
      }
    }

    // Invalid range => negative duration not allowed
    if (last < join) {
      errors.push((isCurrent ? "Current/Recent Company" : "Previous Company " + i) + ": Joining Date is after Last Working Date (negative duration not allowed).");
      if (rows[i].expEl) rows[i].expEl.value = "";
      continue;
    }

    // Experience field: show WITHOUT days (example: "10 Years 11 Months") but keep editable
    const expText = ymText(join, last, false);
    if (expText === "__INVALID__") {
      errors.push((isCurrent ? "Current/Recent Company" : "Previous Company " + i) + ": Invalid date range.");
      if (rows[i].expEl) rows[i].expEl.value = "";
      continue;
    }
    if (rows[i].expEl && (rows[i].expEl.value || "").trim() === "") {
      // Only auto-fill when empty; user can override later
      rows[i].expEl.value = expText;
    }

    // Chronology checks (decreasing order)
    if (i >= 1) {
      const newerJoinText = rows[i - 1].joiningEl ? (rows[i - 1].joiningEl.value || "").trim() : "";
      const newerJoin = newerJoinText ? parseDMY(newerJoinText) : null;

      if (!newerJoin || isNaN(newerJoin.getTime())) {
        canValidateFully = false;
      } else {
        // Previous company joining must be strictly before newer company joining
        if (join >= newerJoin) {
          errors.push("Overlap detected: Previous Company " + i + " joining date must be before the next (more recent) company joining date.");
        }

        // Enforce chain: previous last should be exactly newerJoin - 1 day (if auto-filled or if user left it as computed)
        const expectedLast = addDays(newerJoin, -1);
        // If user edited last date, allow it, but still disallow overlaps:
        if (last >= newerJoin) {
          errors.push("Overlap detected: Previous Company " + i + " last working date must be before the next company joining date.");
        }
      }
    }
  }

  // If required dates missing for full validation
  if (!errors.length && !canValidateFully && showPopup) {
    popupError("Chaining cannot be validated yet. Please enter the joining dates for all companies (Current/Recent first, then Previous companies).");
    return false;
  }

  if (errors.length) {
    if (showPopup) {
      popupError(errors.join("\n"));
    }
    return false;
  }

  // If no errors, recompute Total Experience as sum of all companies (without days) and set in totalExperience
  // (Total Experience = sum of months across companies)
  try {
    let totalMonths = 0;
    for (let i = 0; i < rows.length; i++) {
      const joinText = rows[i].joiningEl ? (rows[i].joiningEl.value || "").trim() : "";
      const lastText = rows[i].lastEl ? (rows[i].lastEl.value || "").trim() : "";

      const join = joinText ? parseDMY(joinText) : null;
      if (!join || isNaN(join.getTime())) continue;

      let last = null;
      if (i === 0 && !lastText) {
        last = new Date();
      } else {
        last = lastText ? parseDMY(lastText) : null;
      }
      if (!last || isNaN(last.getTime()) || last < join) continue;

      const months = (last.getFullYear() - join.getFullYear()) * 12 + (last.getMonth() - join.getMonth());
      // Approx month boundary adjustment if last day earlier than join day
      const adjust = (last.getDate() < join.getDate()) ? -1 : 0;
      totalMonths += Math.max(0, months + adjust);
    }

    const years = Math.floor(totalMonths / 12);
    const monthsRem = totalMonths % 12;
    const totalText = years + " Years " + monthsRem + " Months";

    const totalEl = document.getElementById("totalExperience");
    if (totalEl) totalEl.value = totalText;

    // NOTE: Relevant Experience must remain editable manually per your message.
    // So DO NOT auto-overwrite it. Only fill if empty (optional convenience).
    const relEl = document.getElementById("relevantExperience");
    if (relEl && (relEl.value || "").trim() === "") {
      relEl.value = totalText;
    }
  } catch (e) {
    // No popup here; do not break UX
    console.warn("Total experience calc failed:", e);
  }

  return true;
}

function formatMMMDD(d) {
  if (!d) return "";
  const m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return m[d.getMonth()] + " " + String(d.getDate()).padStart(2,"0") + ", " + d.getFullYear();
}

function diffYMD(fromDate, toDate) {
  if (!fromDate || !toDate) return "";

  let y = toDate.getFullYear() - fromDate.getFullYear();
  let m = toDate.getMonth() - fromDate.getMonth();
  let d = toDate.getDate() - fromDate.getDate();

  if (d < 0) { m--; d += 30; }
  if (m < 0) { y--; m += 12; }

  // NEW: words format everywhere
  return y + " Years " + m + " Months " + d + " Days";
}

function daysBetween(a, b) {
  const ms = 24 * 60 * 60 * 1000;
  const start = new Date(a.getFullYear(), a.getMonth(), a.getDate());
  const end = new Date(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.max(0, Math.round((end - start) / ms));
}

// Total/Relevant need ONLY Years + Months (no days)
function daysToYMWords(totalDays) {
  const years = Math.floor(totalDays / 365);
  const rem = totalDays % 365;
  const months = Math.floor(rem / 30);
  return years + " Years " + months + " Months";
}

function autoSlashDMY(input) {
  if (!input) return;
  let v = (input.value || "").replace(/[^\d]/g, "");
  if (v.length > 8) v = v.slice(0, 8);

  if (v.length >= 5) input.value = v.slice(0, 2) + "/" + v.slice(2, 4) + "/" + v.slice(4);
  else if (v.length >= 3) input.value = v.slice(0, 2) + "/" + v.slice(2);
  else input.value = v;
}

function normalizeDMY(input) {
  if (!input) return;
  const d = parseDMY((input.value || "").trim());
  if (!d) return;
  input.value = formatDMY(d);
}

function popupWarn(m) {
  document.getElementById("modalHead").textContent = "Warning";
  document.getElementById("modalBody").textContent = m;
  document.getElementById("modalBackdrop").style.display = "flex";
}

/* Company experience text format everywhere:
   - Full: "10 Years 11 Months 9 Days"
   - YM:   "10 Years 11 Months"
*/
function diffYMDWords(fromDate, toDate) {
  if (!fromDate || !toDate) return { full: "", ym: "", y: 0, m: 0, d: 0, invalid: false };
  
  if (isNaN(fromDate.getTime()) || isNaN(toDate.getTime())) {
    return { full: "", ym: "", y: 0, m: 0, d: 0, invalid: true };
  }

  if (toDate < fromDate) {
    return { full: "", ym: "", y: 0, m: 0, d: 0, invalid: true };
  }

  let y = toDate.getFullYear() - fromDate.getFullYear();
  let m = toDate.getMonth() - fromDate.getMonth();
  let d = toDate.getDate() - fromDate.getDate();

  if (d < 0) { m--; d += 30; }
  if (m < 0) { y--; m += 12; }

  const full = `${y} Years ${m} Months ${d} Days`;
  const ym = `${y} Years ${m} Months`;
  return { full, ym, y, m, d, invalid: false };
}

// Sums all companies and writes to both Total + Relevant (same value)
function computeEmploymentTotals() {
  const joiningEls = Array.from(document.querySelectorAll("[data-co-joining]"));
  const lastEls = Array.from(document.querySelectorAll("[data-co-lastwork]"));

  let totalDays = 0;

  for (let i = 0; i < joiningEls.length; i++) {
    const jStr = (joiningEls[i].value || "").trim();
    const lStr = (lastEls[i] ? (lastEls[i].value || "").trim() : "");

    const j = parseDMY(jStr);
    if (!j) continue;

    const l = parseDMY(lStr) || new Date(); // empty = Present
    if (l < j) continue;

    totalDays += daysBetween(j, l);
  }

  const out = daysToYMWords(totalDays);

  const totalEl = document.getElementById("totalExperience");
  if (totalEl) totalEl.value = out;
}

function refreshCompanyLabels() {
  const sections = Array.from(document.querySelectorAll("#companiesContainer .section"));
  for (let i = 0; i < sections.length; i++) {
    const sec = sections[i];

    const titleEl = sec.querySelector(".section-title");
    if (titleEl) {
      const labelSpan = titleEl.querySelector("[data-company-label]");
      if (labelSpan) {
        labelSpan.textContent = (i === 0) ? "Current Company" : ("Previous Company " + i);
      }
    }

    const expInput = sec.querySelector("[data-co-expcomp]");
    if (expInput) {
      expInput.placeholder = (i === 0)
        ? "Experience of Current Company"
        : ("Experience in Previous " + i + " Company");
    }
  }
}

function computeCompanyExperienceForSection(sec) {
  if (!sec) return;

  const joinEl = sec.querySelector("[data-co-joining]");
  const lastEl = sec.querySelector("[data-co-lastwork]");
  const expEl  = sec.querySelector("[data-co-expcomp]");

  if (!joinEl || !expEl) return;

  const j = parseDMY((joinEl.value || "").trim());
  if (!j) return;

  const l = (lastEl && (lastEl.value || "").trim()) ? parseDMY(lastEl.value.trim()) : new Date();
  if (!l || l < j) return;

  const days = daysBetween(j, l);
  const out = daysToYMWords(days); // "10 Years 11 Months"

  // Write calculated value, but still editable by user afterwards
  expEl.value = out;
}

function computeAge() {
  const dobStr = document.getElementById("dob").value;
  const dob = parseDMY(dobStr);
  if (!dob) {
    document.getElementById("dobText").value = "";
    document.getElementById("ageYmd").value = "";
    return;
  }
  if (dob > new Date()) {
    popupWarn("Date of Birth cannot be in the future.");
    document.getElementById("dob").value = document.getElementById("dob").dataset.lastValid || "";
    document.getElementById("dobText").value = "";
    document.getElementById("ageYmd").value = "";
    return;
  }
  document.getElementById("dobText").value = formatMMMDD(dob);
  document.getElementById("ageYmd").value = diffYMD(dob, new Date());
}

function computeFatherAge() {
  const dobStr = document.getElementById("fatherDob").value;
  const dob = parseDMY(dobStr);
  if (!dob) {
    document.getElementById("fatherDobText").value = "";
    document.getElementById("fatherAge").value = "";
    return;
  }
  if (dob > new Date()) {
    popupWarn("Father's Date of Birth cannot be in the future.");
    document.getElementById("fatherDob").value = document.getElementById("fatherDob").dataset.lastValid || "";
    document.getElementById("fatherDobText").value = "";
    document.getElementById("fatherAge").value = "";
    return;
  }
  document.getElementById("fatherDobText").value = formatMMMDD(dob);
  document.getElementById("fatherAge").value = diffYMD(dob, new Date());
}

function computeMotherAge() {
  const dobStr = document.getElementById("motherDob").value;
  const dob = parseDMY(dobStr);
  if (!dob) {
    document.getElementById("motherDobText").value = "";
    document.getElementById("motherAge").value = "";
    return;
  }
  if (dob > new Date()) {
    popupWarn("Mother's Date of Birth cannot be in the future.");
    document.getElementById("motherDob").value = document.getElementById("motherDob").dataset.lastValid || "";
    document.getElementById("motherDobText").value = "";
    document.getElementById("motherAge").value = "";
    return;
  }
  document.getElementById("motherDobText").value = formatMMMDD(dob);
  document.getElementById("motherAge").value = diffYMD(dob, new Date());
}

function computeSiblingAge(el) {
  const dobStr = el.value;
  const dob = parseDMY(dobStr);
  if (!dob) {
    const sibId = el.getAttribute("data-sib-id");
    const textEl = el.parentNode.querySelector(`[data-sib-id="${sibId}"][data-sib-dobtext]`);
    const ageEl = el.parentNode.querySelector(`[data-sib-id="${sibId}"][data-sib-age]`);
    if (textEl) textEl.value = "";
    if (ageEl) ageEl.value = "";
    return;
  }
  if (dob > new Date()) {
    popupWarn("Sibling's Date of Birth cannot be in the future.");
    el.value = el.dataset.lastValid || "";
    const sibId = el.getAttribute("data-sib-id");
    const textEl = el.parentNode.querySelector(`[data-sib-id="${sibId}"][data-sib-dobtext]`);
    const ageEl = el.parentNode.querySelector(`[data-sib-id="${sibId}"][data-sib-age]`);
    if (textEl) textEl.value = "";
    if (ageEl) ageEl.value = "";
    return;
  }
  const sibId = el.getAttribute("data-sib-id");
  const textEl = el.parentNode.querySelector(`[data-sib-id="${sibId}"][data-sib-dobtext]`);
  const ageEl = el.parentNode.querySelector(`[data-sib-id="${sibId}"][data-sib-age]`);
  if (textEl && ageEl) {
    textEl.value = formatMMMDD(dob);
    ageEl.value = diffYMD(dob, new Date());
  }
}

function syncSameAddr() {
  if (document.getElementById("sameAddress").checked) {
    document.getElementById("currentAddress").value = document.getElementById("permanentAddress").value;
  }
}

// =========================
// TOTAL EXPERIENCE = SUM OF ALL COMPANIES (Years, Months, Days)
// Uses: Joining Date -> Last Working Date
// Rules:
// - Current Company (index 0): if Last Working is empty, treat as Today
// - Previous Companies: if Last Working is empty, skip that company from total
// - Writes output to #totalExperience in "X Y, Y M, Z D" format
// =========================
function daysInMonth(year, monthIndex0) {
  return new Date(year, monthIndex0 + 1, 0).getDate();
}

function addYMD(acc, add) {
  // acc/add: {y,m,d}
  let y = acc.y + add.y;
  let m = acc.m + add.m;
  let d = acc.d + add.d;

  // normalize days -> months (approx by 30 is wrong; we normalize using 30 as a carry base only for display consistency)
  // Better approach: carry by 30 to keep stable format, because diffYMD() already approximates days with 30.
  // Keep same convention as your diffYMD() (which uses 30-day adjustment).
  while (d >= 30) { d -= 30; m += 1; }
  while (m >= 12) { m -= 12; y += 1; }

  return { y, m, d };
}

function diffYMDParts(fromDate, toDate) {
  if (!fromDate || !toDate) return null;

  let y = toDate.getFullYear() - fromDate.getFullYear();
  let m = toDate.getMonth() - fromDate.getMonth();
  let d = toDate.getDate() - fromDate.getDate();

  // keep same logic as your diffYMD(): if d < 0 then m-- and d += 30
  if (d < 0) { m--; d += 30; }
  if (m < 0) { y--; m += 12; }

  if (y < 0) return null;
  return { y, m, d };
}

function computeTotalExperienceFromCompanies() {
  const totalEl = document.getElementById("totalExperience");
  if (!totalEl) return;

  const sections = document.querySelectorAll("#companiesContainer .section");
  let sum = { y: 0, m: 0, d: 0 };

  sections.forEach((section, idx) => {
    const joiningEl = section.querySelector("[data-co-joining]");
    const lastEl = section.querySelector("[data-co-lastwork]");
    if (!joiningEl || !lastEl) return;

    const start = parseDMY(joiningEl.value);
    if (!start) return;

    const endRaw = parseDMY(lastEl.value);

    // Current company: end defaults to today if empty
    let end = endRaw;
    if (!end && idx === 0) end = new Date();

    // Previous companies: if end missing, skip from total
    if (!end) return;

    const parts = diffYMDParts(start, end);
    if (!parts) return;

    sum = addYMD(sum, parts);
  });

  totalEl.value = sum.y + " Y, " + sum.m + " M, " + sum.d + " D";
}

// ===== Date Input Masking & Company Duration System =====
function formatToDMY(raw) {
  let v = String(raw ?? "").replace(/\D/g, "");
  if (v.length > 8) v = v.slice(0, 8);
  const dd = v.slice(0, 2);
  const mm = v.slice(2, 4);
  const yy = v.slice(4, 8);

  let out = "";
  if (dd) out += dd;
  if (mm) out += "/" + mm;
  if (yy) out += "/" + yy;
  return out;
}

function attachDmyMask(inputEl) {
  inputEl.addEventListener("input", function() {
    this.value = formatToDMY(this.value);
  });
}

function wireAllDmyMasks() {
  document.querySelectorAll('input[data-date-dmy="1"]').forEach(el => {
    attachDmyMask(el);
  });
}

function computeCompanyDerivedAll() {
  // Old function - now handled by applyEmploymentChainingAndValidate and updateCompanyDateVisualsAndDurations
  attachDateInputBehavior();
  wireEmploymentEvents();
  applyEmploymentChainingAndValidate(false);
}

function initCompanyDateSystem() {
  // Old initialization - now handled automatically on page load
  attachDateInputBehavior();
  wireEmploymentEvents();
  applyEmploymentChainingAndValidate(false);
}
// ===== End Date System =====

function renumberCompanies() {
  const sections = document.querySelectorAll("#companiesContainer .section");
  sections.forEach((section, idx) => {
    const titleEl = section.querySelector(".section-title .coTitle");
    if (!titleEl) return;

    if (idx === 0) {
      titleEl.textContent = "Current Company";
    } else {
      titleEl.textContent = "Previous Company " + idx;
    }
  });
  computeCompanyDerivedAll();
}

// ===== NEW CORE EMPLOYMENT HISTORY LOGIC =====
function getCompanyBlocks() {
  return Array.from(document.querySelectorAll("#companiesContainer .section[data-company-block]"));
}

function reindexCompaniesAndApplyRules(showWarnings) {
  const blocks = getCompanyBlocks();

  // Titles and experience label per company
  blocks.forEach((block, idx) => {
    const titleEl = block.querySelector("[data-co-title]");
    if (titleEl) {
      titleEl.textContent = (idx === 0) ? "Current Company / Recent Company" : ("Previous Company " + idx);
    }

    // Update the experience placeholder per company
    const expEl = block.querySelector("[data-co-expcomp]");
    if (expEl) {
      expEl.placeholder = (idx === 0)
        ? "Experience of Current Company / Recent Company (Years Months)"
        : ("Experience of Previous Company " + idx + " (Years Months)");
    }
  });

  // Chaining rule for last working date of previous companies:
  // Company[i].lastWorkingDate = (Company[i-1].joiningDate - 1 day) for i >= 1
  for (let i = 1; i < blocks.length; i++) {
    const newer = blocks[i - 1];
    const older = blocks[i];

    const newerJoinEl = newer.querySelector("[data-co-joining]");
    const olderLastEl = older.querySelector("[data-co-lastwork]");

    const newerJoin = parseDMY((newerJoinEl?.value || "").trim());
    if (!olderLastEl) continue;

    // If we cannot compute yet, do nothing
    if (!newerJoin) continue;

    const computedLast = addDays(newerJoin, -1);
    const computedStr = formatDMY(computedLast);

    const olderLastVal = (olderLastEl.value || "").trim();
    const wasManual = olderLastEl.dataset.manual === "1";

    // Default/auto-set but keep editable:
    // Only auto-set when empty OR previously auto-set and not manually modified.
    const wasAuto = olderLastEl.dataset.auto === "1";
    if (!wasManual && (!olderLastVal || wasAuto)) {
      olderLastEl.value = computedStr;
      olderLastEl.dataset.auto = "1";
      olderLastEl.dataset.manual = "0";
    }
  }

  // Update MMM DD, YYYY visualization + duration fields
  updateCompanyDateVisualsAndDurations();

  // Validate overlaps and impossible ranges
  const v = validateEmploymentHistory(false); // no popup here unless asked
  if (showWarnings && !v.ok) popupWarn(v.message);
}

function updateCompanyDateVisualsAndDurations() {
  const blocks = getCompanyBlocks();
  const today = new Date();

  blocks.forEach((block, idx) => {
    const joinEl = block.querySelector("[data-co-joining]");
    const joinTextEl = block.querySelector("[data-co-joiningText]");
    const lastEl = block.querySelector("[data-co-lastwork]");
    const lastTextEl = block.querySelector("[data-co-lastworkText]");

    const durFullEl = block.querySelector("[data-co-duration]");
    const durYmEl = block.querySelector("[data-co-durationYm]");
    const expEl = block.querySelector("[data-co-expcomp]");

    const join = parseDMY((joinEl?.value || "").trim());
    const lastRaw = (lastEl?.value || "").trim();

    // Current company: empty last = present (today)
    // Previous companies: chaining already sets last, but user can edit it
    let last = parseDMY(lastRaw);
    if (idx === 0 && !last && join) last = today;

    if (joinTextEl) joinTextEl.value = join ? formatMMMDD(join) : "";
    if (lastTextEl) lastTextEl.value = last ? formatMMMDD(last) : "";

    if (join && last) {
      const diff = diffYMDWords(join, last);
      if (diff.invalid) {
        // Negative duration or invalid date range
        if (durFullEl) durFullEl.value = "";
        if (durYmEl) durYmEl.value = "";
        if (expEl) {
          const manual = expEl.dataset.manual === "1";
          if (!manual) {
            expEl.value = "";
          }
        }
      } else {
        if (durFullEl) durFullEl.value = diff.full;     // "X Years Y Months Z Days"
        if (durYmEl) durYmEl.value = diff.ym;           // "X Years Y Months"

        // Auto-calc the experience field, but keep it editable:
        // If user never typed in it, keep updating it
        if (expEl) {
          const manual = expEl.dataset.manual === "1";
          if (!manual) {
            expEl.value = diff.ym;
            expEl.dataset.auto = "1";
          }
        }
      }
    } else {
      if (durFullEl) durFullEl.value = "";
      if (durYmEl) durYmEl.value = "";
    }

    if (expEl) {
      expEl.addEventListener("input", function () {
        expEl.dataset.manual = "1";
        expEl.dataset.auto = "0";
      }, { once: true });
    }
  });

  // Totals (Total Experience and Relevant Experience)
  // Total Experience = sum of each company duration (computed)
  const totals = computeTotalExperienceYM();
  const totalEl = document.getElementById("totalExperience");
  const relEl = document.getElementById("relevantExperience");

  if (totalEl) {
    totalEl.value = totals.ymText;    // without days
    totalEl.readOnly = true;
    totalEl.classList.add("readonly");
  }

  // Relevant Experience must be editable (user asked)
  // But it should also show the same computed value by default
  if (relEl) {
    const relManual = relEl.dataset.manual === "1";
    if (!relManual) relEl.value = totals.ymText;      // defaulted value
    relEl.readOnly = false;
    relEl.classList.remove("readonly");

    // mark manual when user edits
    if (!relEl.dataset.wired) {
      relEl.dataset.wired = "1";
      relEl.addEventListener("input", function () {
        relEl.dataset.manual = "1";
      });
    }
  }
}

function computeTotalExperienceYM() {
  const blocks = getCompanyBlocks();
  const today = new Date();

  let totalMonths = 0;

  blocks.forEach((block, idx) => {
    const join = parseDMY((block.querySelector("[data-co-joining]")?.value || "").trim());
    let last = parseDMY((block.querySelector("[data-co-lastwork]")?.value || "").trim());

    if (idx === 0 && join && !last) last = today;
    if (!join || !last) return;

    const diff = diffYMDWords(join, last);
    totalMonths += (diff.y * 12 + diff.m);
  });

  const y = Math.floor(totalMonths / 12);
  const m = totalMonths % 12;

  return {
    y, m,
    ymText: `${y} Years ${m} Months`
  };
}

function validateEmploymentHistory(forSavePopup) {
  const blocks = getCompanyBlocks();
  const today = new Date();

  // Need joining dates to validate chaining
  for (let i = 0; i < blocks.length; i++) {
    const title = (i === 0) ? "Current Company / Recent Company" : ("Previous Company " + i);
    const joinEl = blocks[i].querySelector("[data-co-joining]");
    const join = parseDMY((joinEl?.value || "").trim());
    if (!join) {
      return { ok: false, message: `Employment History validation: Joining Date is missing in ${title}.` };
    }
  }

  // Validate each company range and overlaps
  for (let i = 0; i < blocks.length; i++) {
    const title = (i === 0) ? "Current Company / Recent Company" : ("Previous Company " + i);

    const join = parseDMY((blocks[i].querySelector("[data-co-joining]")?.value || "").trim());
    const lastRaw = (blocks[i].querySelector("[data-co-lastwork]")?.value || "").trim();
    let last = parseDMY(lastRaw);

    // Rule: only current can be present
    if (i === 0 && !last) last = today;

    // Previous companies must not be present; if still missing, chaining could not compute
    if (i > 0 && !last) {
      return { ok: false, message: `Employment History validation: Last Working Date could not be computed for ${title}. Enter it or ensure the next (more recent) company Joining Date is filled.` };
    }

    if (join && last && join > last) {
      return { ok: false, message: `Employment History validation: Joining Date is after Last Working Date in ${title}. Please correct the dates.` };
    }

    // Overlap check with the newer company (i-1)
    if (i > 0) {
      const newerTitle = (i - 1 === 0) ? "Current Company / Recent Company" : ("Previous Company " + (i - 1));
      const newerJoin = parseDMY((blocks[i - 1].querySelector("[data-co-joining]")?.value || "").trim());
      const expectedLast = addDays(newerJoin, -1);

      if (last && newerJoin && last >= newerJoin) {
        return { ok: false, message: `Employment History validation: Overlap detected. ${title} Last Working Date must be before ${newerTitle} Joining Date.` };
      }

      // If user edited the last working date away from expected chain, warn (not hard fail)
      const lastEl = blocks[i].querySelector("[data-co-lastwork]");
      const manual = lastEl?.dataset.manual === "1";
      if (manual && last && expectedLast && formatDMY(last) !== formatDMY(expectedLast)) {
        return { ok: false, message: `Employment History validation: Dates do not match the chain rule. ${title} Last Working Date should be ${formatDMY(expectedLast)} (day before ${newerTitle} Joining Date).` };
      }
    }
  }

  return { ok: true, message: "" };
}

function onCompanyDatesChanged() {
  reindexCompaniesAndApplyRules(false);

  // For live warnings (do not block typing), show only when clearly invalid
  const v = validateEmploymentHistory(false);
  if (!v.ok) {
    // show warning in status bar, no popup spam
    setStatus(v.message, false);
  } else {
    setStatus("Employment History dates look consistent.", true);
  }
}
// ===== END NEW CORE LOGIC =====

function addCompany(prefill = null) {
  const id = Date.now() + Math.floor(Math.random() * 1000);

  document.getElementById("companiesContainer").insertAdjacentHTML("beforeend", `
    <div class="section" data-company-block data-co-id="${id}">
      <div class="section-title">
        <span data-co-title>Company</span>

        <div class="right">
          <button class="btn danger" type="button"
            onclick="removeCompany(this)"
            style="padding:5px 8px;font-size:11px;">Remove</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="field-label">Company Name</label>
          <input placeholder="Company Name" data-co-id="${id}" data-co-name value="${prefill?.company ? escHtml(prefill.company) : ""}" />
        </div>
        <div>
          <label class="field-label">Payroll Company</label>
          <input placeholder="Payroll Company" data-co-id="${id}" data-co-payroll value="${prefill?.payroll ? escHtml(prefill.payroll) : ""}" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="field-label">Designation</label>
          <input placeholder="Designation" data-co-id="${id}" data-co-desig value="${prefill?.designation ? escHtml(prefill.designation) : ""}" />
        </div>
        <div>
          <label class="field-label">Experience (Years Months)</label>
          <input placeholder="Experience (Years Months)" data-co-id="${id}" data-co-expcomp
            value="${prefill?.experienceInCompany ? escHtml(prefill.experienceInCompany) : ""}" />
        </div>
      </div>

      <div class="grid4">
        <div>
          <label class="field-label">Joining Date (DD/MM/YYYY)</label>
          <input placeholder="Joining Date (DD/MM/YYYY)" data-co-id="${id}" data-co-joining
          value="${prefill?.joiningDate ? escHtml(prefill.joiningDate) : ""}"
          inputmode="numeric" maxlength="10"
          oninput="autoSlashDMY(this); onCompanyDatesChanged()"
          onblur="normalizeDMY(this); validateEmploymentDate(this); onCompanyDatesChanged()" />
        </div>
        <div>
          <label class="field-label">Joining Date (Formatted)</label>
          <input placeholder="Joining Date (MMM DD, YYYY)" data-co-id="${id}" data-co-joiningText readonly class="readonly"
            value="${prefill?.joiningDate ? escHtml(formatMMMDD(parseDMY(prefill.joiningDate)) || "") : ""}" />
        </div>
        <div>
          <label class="field-label">Last Working Date (DD/MM/YYYY)</label>
          <input placeholder="Last Working Date (DD/MM/YYYY)" data-co-id="${id}" data-co-lastwork
          value="${prefill?.lastWorkingDate ? escHtml(prefill.lastWorkingDate) : formatDMY(getThisWeekFriday())}"
          inputmode="numeric" maxlength="10"
          oninput="autoSlashDMY(this); markLastWorkManual(this); onCompanyDatesChanged()"
          onblur="normalizeDMY(this); markLastWorkManual(this); validateEmploymentDate(this); onCompanyDatesChanged()" />
        </div>
        <div>
          <label class="field-label">Last Working Date (Formatted)</label>
          <input placeholder="Last Working Date (MMM DD, YYYY)" data-co-id="${id}" data-co-lastworkText readonly class="readonly"
            value="${prefill?.lastWorkingDate ? escHtml(formatMMMDD(parseDMY(prefill.lastWorkingDate)) || "") : ""}" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="field-label">Duration (Years Months Days)</label>
          <input placeholder="Duration (Years Months Days)" data-co-id="${id}" data-co-duration readonly class="readonly"
            value="" />
        </div>
        <div>
          <label class="field-label">Duration (Years Months)</label>
          <input placeholder="Duration (Years Months)" data-co-id="${id}" data-co-durationYm readonly class="readonly"
            value="" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="field-label">CTC</label>
          <input placeholder="CTC" type="number" step="1" data-co-id="${id}" data-co-ctc value="${prefill?.ctc ? escHtml(fmtInt(prefill.ctc)) : ""}" oninput="autoCalcMonthlyGross(this)" onblur="this.value=fmtInt(this.value); autoCalcMonthlyGross(this)" onchange="this.value=fmtInt(this.value); autoCalcMonthlyGross(this)" />
        </div>
        <div>
          <label class="field-label">Monthly Gross</label>
          <input placeholder="Monthly Gross" data-co-id="${id}" data-co-gross value="${prefill?.monthlyGross ? escHtml(prefill.monthlyGross) : ""}" readonly class="readonly" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="field-label">In Hand Salary</label>
          <input placeholder="In Hand Salary" data-co-id="${id}" data-co-inhand value="${prefill?.inHandSalary ? escHtml(prefill.inHandSalary) : ""}" onblur="clampRoundInhandSalary(this)" />
        </div>
        <div>
          <label class="field-label">Remarks</label>
          <input placeholder="Remarks" data-co-id="${id}" data-co-remarks value="${prefill?.remarks ? escHtml(prefill.remarks) : "NA"}" />
        </div>
      </div>

    </div>
  `);

  // Restore regMeta if available
  if (prefill?.regMeta) {
    const sections = document.querySelectorAll("#companiesContainer .section");
    const lastSection = sections[sections.length - 1];
    if (lastSection) {
      // If regMeta is an object, stringify it; if string, use as-is
      if (typeof prefill.regMeta === "object") {
        lastSection.dataset.regMeta = JSON.stringify(prefill.regMeta);
      } else {
        lastSection.dataset.regMeta = prefill.regMeta;
      }
    }
  }

  reindexCompaniesAndApplyRules(false);
  onCompanyDatesChanged();
  
  attachDateInputBehavior();
  wireEmploymentEvents();
  applyEmploymentChainingAndValidate(false);
  
  // Enhance labels for newly added company
  enhanceAdminConsoleLabels();
}

function removeCompany(btn) {
  const section = btn.closest(".section");
  if (section) section.remove();
  reindexCompaniesAndApplyRules(false);
  onCompanyDatesChanged();
}

function markLastWorkManual(el) {
  if (!el) return;
  el.dataset.manual = "1"; // user touched it, do not overwrite later
  el.dataset.auto = "0";
}

// Auto-calculate Monthly Gross = CTC / 12
function autoCalcMonthlyGross(ctcInput) {
  if (!ctcInput) return;
  const section = ctcInput.closest(".section");
  if (!section) return;
  autoCalcMonthlyGrossForSection(section);
}

function autoCalcMonthlyGrossForSection(section) {
  const ctcInput = section.querySelector("[data-co-ctc]");
  const grossInput = section.querySelector("[data-co-gross]");
  if (!ctcInput || !grossInput) return;
  
  const ctcStr = ctcInput.value.trim();
  if (!ctcStr) {
    grossInput.value = "";
    return;
  }
  
  const ctcNum = parseFloat(ctcStr.replace(/[^0-9.]/g, ""));
  if (isNaN(ctcNum) || ctcNum <= 0) {
    grossInput.value = "";
    return;
  }
  
  const monthlyGross = Math.floor(ctcNum / 12);
  grossInput.value = monthlyGross.toString();
}

// Clamp and round Inhand Salary (on blur)
function clampRoundInhandSalary(inhandInput) {
  if (!inhandInput) return;
  const section = inhandInput.closest(".section");
  if (!section) return;
  clampRoundInhandForSection(section);
}

function clampRoundInhandForSection(section) {
  const inhandInput = section.querySelector("[data-co-inhand]");
  const grossInput = section.querySelector("[data-co-gross]");
  if (!inhandInput) return;
  
  let inhandValue = inhandInput.value.trim();
  
  // If blank, auto-fill from Monthly Gross (clamped to 2700-3500, rounded down to 100)
  if (!inhandValue) {
    let calculated = 3000; // default middle value
    if (grossInput && grossInput.value) {
      const gross = parseFloat(grossInput.value.replace(/[^0-9.]/g, ""));
      if (!isNaN(gross) && gross > 0) {
        calculated = gross * 0.7; // 70% of gross (heuristic)
      }
    }
    calculated = roundDownToHundred(calculated);
    calculated = Math.max(2700, Math.min(3500, calculated)); // clamp to [2700, 3500]
    inhandInput.value = calculated.toString();
    return;
  }
  
  // If provided, clamp and round down to nearest 100
  const inhandNum = parseFloat(inhandValue.replace(/[^0-9.]/g, ""));
  if (!isNaN(inhandNum)) {
    let clamped = roundDownToHundred(inhandNum);
    clamped = Math.max(2700, Math.min(3500, clamped)); // clamp [2700, 3500]
    inhandInput.value = clamped.toString();
  }
}

// Validate employment date is a working day
function validateEmploymentDate(dateInput) {
  if (!dateInput || !dateInput.value) return true; // empty is ok (not validated yet)
  
  const parsed = parseDateDMY(dateInput.value);
  if (!parsed) return true; // invalid format, other validation handles it
  
  const isWD = !isWeekend(parsed) && !isHoliday(parsed);
  if (!isWD) {
    const fieldLabel = dateInput.placeholder || "Date";
    showMismatchModal([fieldLabel + " must be a working day (not Sat/Sun/holiday)"]);
    return false;
  }
  return true;
}

// Validate all employment and registration dates
function validateAllEmploymentDates() {
  const issues = [];
  
  // Check all employment history dates
  document.querySelectorAll("#companiesContainer .section").forEach((section, idx) => {
    const joiningInput = section.querySelector("[data-co-joining]");
    const lastWorkInput = section.querySelector("[data-co-lastwork]");
    const companyName = section.querySelector("[data-co-title]")?.textContent || `Company ${idx + 1}`;
    
    if (joiningInput && joiningInput.value) {
      const joiningParsed = parseDateDMY(joiningInput.value);
      if (joiningParsed && (isWeekend(joiningParsed) || isHoliday(joiningParsed))) {
        issues.push(`${companyName} - Joining Date must be a working day`);
      }
    }
    
    if (lastWorkInput && lastWorkInput.value) {
      const lastWorkParsed = parseDateDMY(lastWorkInput.value);
      if (lastWorkParsed && (isWeekend(lastWorkParsed) || isHoliday(lastWorkParsed))) {
        issues.push(`${companyName} - Last Working Date must be a working day`);
      }
    }
  });
  
  // Check Registration Form selected company dates if modal is open
  const regFormModal = document.getElementById("registrationFormModal");
  if (regFormModal && regFormModal.style.display !== "none") {
    const datesFields = [
      { id: "regForm_joiningDate", label: "Joining Date" },
      { id: "regForm_relievingDate", label: "Relieving Date" },
      { id: "regForm_offerDate", label: "Offer Date" },
      { id: "regForm_resignationDate", label: "Resignation Date" },
      { id: "regForm_hikeDate", label: "Hike Date" }
    ];
    
    datesFields.forEach(field => {
      const inp = document.getElementById(field.id);
      if (inp && inp.value) {
        const parsed = parseDateMMM(inp.value); // Registration form uses MMM DD, YYYY format
        if (parsed && (isWeekend(parsed) || isHoliday(parsed))) {
          issues.push(`Registration Form - ${field.label} must be a working day`);
        }
      }
    });
  }
  
  if (issues.length > 0) {
    showMismatchModal(issues);
    return false;
  }
  return true;
}

// Show impressive mismatch/validation modal
function showMismatchModal(issueList) {
  let modal = document.getElementById("mismatchModal");
  if (!modal) {
    // Create modal once
    document.body.insertAdjacentHTML("beforeend", `
      <div class="modalBackdrop" id="mismatchModal" style="display:none;">
        <div class="modalBox" style="max-width:500px;">
          <div class="modalHead" style="background:#dc2626;color:#fff;">Please fix these issues</div>
          <div class="modalBody" id="mismatchIssuesList" style="padding:20px;max-height:300px;overflow-y:auto;">
          </div>
          <div class="modalActions">
            <button class="modalBtn" onclick="document.getElementById('mismatchModal').style.display='none';">OK</button>
          </div>
        </div>
      </div>
    `);
    modal = document.getElementById("mismatchModal");
  }
  
  // Update issue list
  const issuesList = document.getElementById("mismatchIssuesList");
  if (issuesList) {
    issuesList.innerHTML = "<ul style='margin:0;padding-left:20px;font-size:14px;line-height:1.8;color:#374151;'>"
      + issueList.map(issue => `<li>${escHtml(issue)}</li>`).join("")
      + "</ul>";
  }
  
  // Show modal
  if (modal) modal.style.display = "flex";
}

// Show save success toast
function showSaveSuccessToast() {
  let toast = document.getElementById("saveSuccessToast");
  if (!toast) {
    document.body.insertAdjacentHTML("beforeend", `
      <div id="saveSuccessToast" style="
        position:fixed;top:20px;right:20px;
        background:#27ae60;color:#fff;
        padding:16px 24px;
        border-radius:8px;
        font-size:16px;font-weight:700;
        box-shadow:0 8px 24px rgba(0,0,0,0.3);
        z-index:10000;
        display:flex;align-items:center;gap:12px;
        animation:slideIn 0.3s ease-out;
      ">
        <span style="font-size:20px;"></span>
        <span>Saved successfully!</span>
      </div>
      <style>
        @keyframes slideIn {
          from { transform: translateX(400px); opacity:0; }
          to { transform: translateX(0); opacity:1; }
        }
      </style>
    `);
    toast = document.getElementById("saveSuccessToast");
  }
  
  if (toast) {
    toast.style.display = "flex";
    setTimeout(() => {
      toast.style.display = "none";
    }, 2500);
  }
}


function addSibling() {
  const id = Date.now();
  document.getElementById("siblingsContainer").insertAdjacentHTML("beforeend", `
    <div class="section">
      <div class="section-title">
        <span>Sibling</span>
        <div class="right">
          <button type="button" class="btn danger"
            onclick="this.closest('.section').remove()"
            style="padding:5px 8px;font-size:11px;">Remove</button>
        </div>
      </div>

      <div class="grid4">
        <div>
          <label class="field-label">Sibling Name</label>
          <input placeholder="Sibling Name" data-sib-id="${id}" data-sib-name />
        </div>
        <div>
          <label class="field-label">DOB (DD/MM/YYYY)</label>
          <input placeholder="DOB (DD/MM/YYYY)" class="dob-auto-format" data-sib-id="${id}" data-sib-dob inputmode="numeric" maxlength="10" onchange="computeSiblingAge(this)" />
        </div>
        <div>
          <label class="field-label">DOB (Formatted)</label>
          <input placeholder="DOB (MMM DD, YYYY)" data-sib-id="${id}" data-sib-dobtext readonly class="readonly" />
        </div>
        <div>
          <label class="field-label">Age</label>
          <input placeholder="Age (Years, Months, Days)" data-sib-id="${id}" data-sib-age readonly class="readonly" />
        </div>
      </div>
    </div>
  `);

  // Ensure date input rules are applied to newly added DOB field too
  attachDateInputBehavior();
  
  // Enhance labels for newly added sibling
  enhanceAdminConsoleLabels();
}

function collectForm() {
  // Helper functions for null-safe element access
  const byId = (id) => {
    const el = document.getElementById(id);
    return el ? el.value : "";
  };
  const qVal = (root, selector) => {
    if (!root) return "";
    const el = root.querySelector(selector);
    return el ? el.value : "";
  };

  // Collect all companies using section-scoped selectors
  const companies = Array.from(document.querySelectorAll("#companiesContainer .section")).map(section => {
    let remarks = qVal(section, '[data-co-remarks]') || "N/A";
    let regMeta = null;
    
    // Migrate: if remarks looks like JSON, move it to regMeta
    if (remarks.trim().startsWith('{')) {
      try {
        regMeta = JSON.parse(remarks);
        remarks = "N/A";
      } catch(e) {}
    }
    
    // Parse regMeta from dataset if available
    if (!regMeta && section.dataset.regMeta) {
      try {
        const raw = section.dataset.regMeta;
        if (raw && raw.trim() !== "") {
          regMeta = JSON.parse(raw);
        }
      } catch(e) {
        console.warn("collectForm: failed to parse regMeta", e);
        regMeta = null;
      }
    }
    
    return {
      company: qVal(section, '[data-co-name]'),
      payroll: qVal(section, '[data-co-payroll]'),
      designation: qVal(section, '[data-co-desig]'),
      joiningDate: qVal(section, '[data-co-joining]'),
      joiningDateText: qVal(section, '[data-co-joiningText]'),
      lastWorkingDate: qVal(section, '[data-co-lastwork]'),
      lastWorkingDateText: qVal(section, '[data-co-lastworkText]'),
      durationYmd: qVal(section, '[data-co-duration]'),
      ctc: qVal(section, '[data-co-ctc]'),
      monthlyGross: qVal(section, '[data-co-gross]'),
      inHandSalary: qVal(section, '[data-co-inhand]'),
      experienceInCompany: qVal(section, '[data-co-expcomp]'),
      remarks: remarks,
      regMeta: regMeta
    };
  });

  // Collect all siblings using section-scoped selectors
  const siblings = Array.from(document.querySelectorAll("#siblingsContainer .section")).map(section => ({
    name: qVal(section, '[data-sib-name]'),
    dob: qVal(section, '[data-sib-dob]'),
    dobText: qVal(section, '[data-sib-dobtext]'),
    age: qVal(section, '[data-sib-age]')
  }));

  const servicesAccess = {};
  document.querySelectorAll('.svc-access-toggle').forEach(cb => {
    const key = cb.getAttribute('data-service-key');
    if (key) servicesAccess[key] = !!cb.checked;
  });

  return {
    candidateId: byId("candidateId"),
    status: byId("status"),
    lastUpdatedText: byId("lastUpdatedText"),
    lastUpdatedISO: byId("lastUpdatedISO"),
    fullName: byId("fullName"),
    preferredName: byId("preferredName"),
    gender: byId("gender"),
    whatsapp: byId("whatsapp"),
    dob: byId("dob"),
    dobText: byId("dobText"),
    ageYmd: byId("ageYmd"),
    marital: byId("marital"),
    blood: byId("blood"),
    sim: byId("sim"),
    email: byId("email"),
    aadhaar: byId("aadhaar"),
    pan: byId("pan"),
    passport: byId("passport"),
    bank: byId("bank"),
    uanNumber: byId("uanNumber"),
    ifscCode: byId("ifscCode"),
    bankName: byId("bankName"),
    permanentAddress: byId("permanentAddress"),
    currentAddress: byId("currentAddress"),
    totalExperience: byId("totalExperience"),
    relevantExperience: byId("relevantExperience"),
    companies: companies,
    father: byId("father"),
    fatherDob: byId("fatherDob"),
    fatherDobText: byId("fatherDobText"),
    fatherAge: byId("fatherAge"),
    mother: byId("mother"),
    motherDob: byId("motherDob"),
    motherDobText: byId("motherDobText"),
    motherAge: byId("motherAge"),
    siblings: siblings,
    hg: {
      degree: byId("hgDegree"),
      branch: byId("hgBranch"),
      college: byId("hgCollege"),
      collegeAddress: byId("hgCollegeAddress"),
      university: byId("hgUniversity"),
      universityAddress: byId("hgUniversityAddress"),
      percentage: byId("hgPercentage"),
      duration: byId("hgDuration"),
      delay: byId("hgDelay")
    },
    g: {
      degree: byId("gDegree"),
      branch: byId("gBranch"),
      college: byId("gCollege"),
      collegeAddress: byId("gCollegeAddress"),
      universityAddress: byId("gUniversityAddress"),
      percentage: byId("gPercentage"),
      duration: byId("gDuration"),
      delay: byId("gDelay")
    },
    i: {
      type: byId("iType"),
      branch: byId("iBranch"),
      college: byId("iCollege"),
      collegeAddress: byId("iCollegeAddress"),
      board: byId("iBoard"),
      boardAddress: byId("iBoardAddress"),
      percentage: byId("iPercentage"),
      duration: byId("iDuration"),
      delay: byId("iDelay")
    },
    t: {
      school: byId("tSchool"),
      schoolAddress: byId("tSchoolAddress"),
      board: byId("tBoard"),
      boardAddress: byId("tBoardAddress"),
      percentage: byId("tPercentage"),
      duration: byId("tDuration")
    },
    customFields: getCustomFields(),
    subscription: {
      planType: byId("subscriptionPlanType"),
      startDate: byId("subscriptionStartDate"),
      endDate: byId("subscriptionEndDate"),
      status: byId("subscriptionStatus")
    },
    servicesAccess: servicesAccess
  };
}

async function saveData() {
  let cid = document.getElementById("candidateId").value.trim();
  
  // Auto-generate candidateId if missing
  if (!cid) {
    const preferredName = document.getElementById("preferredName").value.trim();
    if (!preferredName) {
      popupError("Please enter Preferred Name before saving.");
      return;
    }
    const normalized = preferredName.toUpperCase().replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g, '');
    const random6 = Math.floor(100000 + Math.random() * 900000);
    cid = `CAND_${normalized}_${random6}`;
    document.getElementById("candidateId").value = cid;
  }
  
  if (!applyEmploymentChainingAndValidate(true)) {
    setStatus("Fix Employment History dates before saving.", false);
    return;
  }
  
  // Validate all employment and registration dates are working days
  if (!validateAllEmploymentDates()) {
    return; // Mismatch modal shown by validator
  }
  
  console.log("[SAVE] Starting save operation for candidate:", cid);
  
  if (!cid || cid.trim() === "") {
    console.log("[SAVE] FAILED: No Candidate ID provided");
    popupError("Please enter a Candidate ID");
    return;
  }
  
  // Apply rules and validate employment history before saving
  reindexCompaniesAndApplyRules(false);
  const ev = validateEmploymentHistory(false);
  if (!ev.ok) {
    console.log("[SAVE] FAILED: Employment history validation error:", ev.message);
    popupWarn(ev.message);
    return;
  }
  
  // Auto-calculate Monthly Gross and clamp Inhand for all companies before save
  Array.from(document.querySelectorAll("#companiesContainer .section")).forEach(section => {
    autoCalcMonthlyGrossForSection(section);
    clampRoundInhandForSection(section);
  });
  
  // Set last updated timestamps
  const now = new Date();
  document.getElementById("lastUpdatedText").value = now.toLocaleString();
  document.getElementById("lastUpdatedISO").value = now.toISOString();
  
  console.log("[SAVE] Setting timestamps:", now.toISOString());
  setStatus("Saving...", true);
  
  computeEmploymentTotals();
  Array.from(document.querySelectorAll("#companiesContainer .section"))
    .forEach(sec => computeCompanyExperienceForSection(sec));
  
  try {
    const data = collectForm();
    console.log("[SAVE] Form data collected successfully");
    console.log("[SAVE] Custom fields count:", (data.customFields || []).length);
    
    // Save to localStorage
    localStorage.setItem("candidate_" + cid, JSON.stringify(data));
    console.log("[SAVE] SUCCESS: Data saved to browser localStorage for candidate:", cid);

    if (db && auth && auth.currentUser) {
      try {
        await db.collection("candidates").doc(cid).set({
          candidateId: cid,
          payload: data,
          subscription: data.subscription || {},
          subscriptionStart: data.subscription?.startDate || null,
          subscriptionEnd: data.subscription?.endDate || null,
          subscriptionStatus: data.subscription?.status || null,
          servicesAccess: data.servicesAccess || {},
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        console.log("[SAVE] FIRESTORE_OK", { cid });
      } catch (fireErr) {
        console.error("[SAVE] FIRESTORE_FAIL", fireErr);
        setStatus("Saved locally. Firestore update failed.", false);
      }
    }
    
    // Show success toast
    showSaveSuccessToast();
    setStatus("Saved successfully!", true);
  } catch (err) {
    console.log("[SAVE] ERROR:", err.message);
    setStatus("Failed.", false);
    popupError("Error: " + err.message);
  }
}

function clearForm() {
  document.querySelectorAll("input,textarea,select").forEach(el => { if (el.type !== "checkbox") el.value = ""; });
  document.getElementById("companiesContainer").innerHTML = "";
  document.getElementById("siblingsContainer").innerHTML = "";
}

function refreshList() {
  console.log("REFRESHLIST_START");

  const u = firebase.auth().currentUser;
  if (!u) {
    console.warn("SKIP_FIRESTORE_NOT_LOGGED_IN");
    return;
  }
  const email = (u.email || "").toLowerCase();
  if (!ADMIN_EMAILS.includes(email)) {
    console.warn("SKIP_FIRESTORE_NOT_ADMIN", email);
    return;
  }

  setView("list");
  wireListEventsOnce();

  const tbody = document.getElementById("candidatesTableBody");
  const recordCount = document.getElementById("recordCount");

  if (!tbody) {
    console.error("REFRESHLIST_FATAL: candidatesTableBody not found");
    return;
  }

  tbody.innerHTML = "";

  const candidates = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);

    // Only candidate records
    if (!key || !key.startsWith("candidate_")) continue;

    const raw = localStorage.getItem(key);
    if (!raw) continue;

    const data = safeJsonParse(raw, key);
    if (!data || typeof data !== "object") continue;

    // Hard guard: candidateId must exist
    if (!data.candidateId) continue;

    candidates.push(data);
  }

  candidates.sort(function (a, b) {
    const aDate = new Date(a.lastUpdatedISO || 0);
    const bDate = new Date(b.lastUpdatedISO || 0);
    return bDate - aDate;
  });

  for (let idx = 0; idx < candidates.length; idx++) {
    const data = candidates[idx];
    const cid = String(data.candidateId || "");

    const tr = document.createElement("tr");
    tr.style.borderBottom = "1px solid #d7deea";

    tr.innerHTML =
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' + escHtml(data.candidateId) + "</td>" +
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' + escHtml(data.fullName) + "</td>" +
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' + escHtml(data.preferredName) + "</td>" +
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' + escHtml(data.email) + "</td>" +
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' + escHtml(data.whatsapp) + "</td>" +
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' + escHtml(data.lastUpdatedText) + "</td>" +
      '<td style="border:1px solid #d7deea;padding:10px 12px;">' +
        '<button type="button" class="btn primary" data-action="edit" data-cid="' + escHtml(cid) + '">View/Edit</button>' +
      "</td>";

    tbody.appendChild(tr);
  }

  if (recordCount) {
    recordCount.textContent = "Total records: " + candidates.length;
  }

  refreshCredentialsList();

  console.log("REFRESHLIST_COMPLETE", { total: candidates.length });
}

function filterCandidates() {
  const searchVal = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.getElementById("candidatesTableBody").getElementsByTagName("tr");
  let visibleCount = 0;
  
  Array.from(rows).forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchVal)) {
      row.style.display = "";
      visibleCount++;
    } else {
      row.style.display = "none";
    }
  });
  
  document.getElementById("recordCount").textContent = "Showing: " + visibleCount + " records";
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  filterCandidates();
  refreshList();
}

function newCandidate() {
  clearForm();
  document.getElementById("formTitle").textContent = "New Candidate";
  document.getElementById("listView").style.display = "none";
  document.getElementById("formView").style.display = "block";
  document.getElementById("candidateId").focus();
  loadCustomFields();
  renderServiceAccessToggles({});
  const startEl = document.getElementById("subscriptionStartDate");
  if (startEl && !startEl.value) {
    startEl.value = new Date().toISOString().split("T")[0];
  }
  applySubscriptionPlan();
  
  // Enhance labels for professional typography
  enhanceAdminConsoleLabels();
}

function createCandidateIdFromPreferredName() {
  const preferredName = document.getElementById("preferredName").value.trim();
  if (!preferredName) {
    popupError("Please enter Preferred Name first.");
    return;
  }
  const normalized = preferredName.toUpperCase().replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g, '');
  const random6 = Math.floor(100000 + Math.random() * 900000);
  const candidateId = `CAND_${normalized}_${random6}`;
  document.getElementById("candidateId").value = candidateId;
  setStatus("Candidate ID created (not saved yet).", true);
}

function loadCandidateIdPrompt() {
  const cid = prompt("Enter Candidate ID to load (e.g., CAND_NAME_123456):");
  if (!cid || !cid.trim()) return;
  editCandidate(cid.trim());
}

async function editCandidate(cid) {
  const data = safeJsonParse(localStorage.getItem("candidate_" + cid), null);
  if (!data) { popupError("Candidate not found or invalid data"); return; }
  
  document.getElementById("formTitle").textContent = "Edit Candidate  " + escHtml(cid);
  
  // Load data into form
  document.getElementById("candidateId").value = data.candidateId || "";
  document.getElementById("status").value = data.status || "";
  document.getElementById("lastUpdatedText").value = data.lastUpdatedText || "";
  document.getElementById("lastUpdatedISO").value = data.lastUpdatedISO || "";
  const sub = data.subscription || {};
  const planType = sub.planType || data.subscriptionPlan || "demo";
  const startRaw = sub.startDate || data.subscriptionStart || "";
  const endRaw = sub.endDate || data.subscriptionEnd || "";
  const startEl = document.getElementById("subscriptionStartDate");
  const endEl = document.getElementById("subscriptionEndDate");
  if (startEl && startRaw) startEl.value = new Date(startRaw).toISOString().split("T")[0];
  if (endEl && endRaw) endEl.value = new Date(endRaw).toISOString().split("T")[0];
  const planEl = document.getElementById("subscriptionPlanType");
  if (planEl) planEl.value = planType;
  refreshSubscriptionStatus();
  document.getElementById("fullName").value = data.fullName || "";
  document.getElementById("preferredName").value = data.preferredName || "";
  document.getElementById("gender").value = data.gender || "";
  document.getElementById("whatsapp").value = data.whatsapp || "";
  document.getElementById("dob").value = data.dob || "";
  document.getElementById("dobText").value = data.dobText || "";
  document.getElementById("ageYmd").value = data.ageYmd || "";
  document.getElementById("marital").value = data.marital || "";
  document.getElementById("blood").value = data.blood || "";
  document.getElementById("sim").value = data.sim || "";
  document.getElementById("email").value = data.email || "";
  document.getElementById("aadhaar").value = data.aadhaar || "";
  document.getElementById("pan").value = data.pan || "";
  document.getElementById("passport").value = data.passport || "";
  document.getElementById("bank").value = data.bank || "";
  document.getElementById("uanNumber").value = data.uanNumber || "";
  document.getElementById("ifscCode").value = data.ifscCode || "";
  document.getElementById("bankName").value = data.bankName || "";
  document.getElementById("permanentAddress").value = data.permanentAddress || "";
  document.getElementById("currentAddress").value = data.currentAddress || "";
  document.getElementById("totalExperience").value = data.totalExperience || "";
  document.getElementById("relevantExperience").value = data.relevantExperience || "";

  await loadServicesCatalog();
  renderServiceAccessToggles(data.servicesAccess || {});
  
  // Clear and reload companies
  document.getElementById("companiesContainer").innerHTML = "";
  if (data.companies && data.companies.length) {
    data.companies.forEach(c => addCompany(c));
  } else {
    // Ensure at least one current company block exists
    addCompany();
  }

  reindexCompaniesAndApplyRules(false);
  onCompanyDatesChanged();
  
  // Load education data
  if (data.hg) {
    document.getElementById("hgDegree").value = data.hg.degree || "";
    document.getElementById("hgBranch").value = data.hg.branch || "";
    document.getElementById("hgCollege").value = data.hg.college || "";
    document.getElementById("hgCollegeAddress").value = data.hg.collegeAddress || "";
    document.getElementById("hgUniversity").value = data.hg.university || "";
    document.getElementById("hgUniversityAddress").value = data.hg.universityAddress || "";
    document.getElementById("hgPercentage").value = data.hg.percentage || "";
    document.getElementById("hgDuration").value = data.hg.duration || "";
    document.getElementById("hgDelay").value = data.hg.delay || "";
  }
  
  if (data.g) {
    document.getElementById("gDegree").value = data.g.degree || "";
    document.getElementById("gBranch").value = data.g.branch || "";
    document.getElementById("gCollege").value = data.g.college || "";
    document.getElementById("gCollegeAddress").value = data.g.collegeAddress || "";
    document.getElementById("gUniversityAddress").value = data.g.universityAddress || "";
    document.getElementById("gPercentage").value = data.g.percentage || "";
    document.getElementById("gDuration").value = data.g.duration || "";
    document.getElementById("gDelay").value = data.g.delay || "";
  }
  
  if (data.i) {
    document.getElementById("iType").value = data.i.type || "";
    document.getElementById("iBranch").value = data.i.branch || "";
    document.getElementById("iCollege").value = data.i.college || "";
    document.getElementById("iCollegeAddress").value = data.i.collegeAddress || "";
    document.getElementById("iBoard").value = data.i.board || "";
    document.getElementById("iBoardAddress").value = data.i.boardAddress || "";
    document.getElementById("iPercentage").value = data.i.percentage || "";
    document.getElementById("iDuration").value = data.i.duration || "";
    document.getElementById("iDelay").value = data.i.delay || "";
  }
  
  if (data.t) {
    document.getElementById("tSchool").value = data.t.school || "";
    document.getElementById("tSchoolAddress").value = data.t.schoolAddress || "";
    document.getElementById("tBoard").value = data.t.board || "";
    document.getElementById("tBoardAddress").value = data.t.boardAddress || "";
    document.getElementById("tPercentage").value = data.t.percentage || "";
    document.getElementById("tDuration").value = data.t.duration || "";
  }
  
  // Load family data
  document.getElementById("father").value = data.father || "";
  document.getElementById("fatherDob").value = data.fatherDob || "";
  document.getElementById("fatherDobText").value = data.fatherDobText || "";
  document.getElementById("fatherAge").value = data.fatherAge || "";
  document.getElementById("mother").value = data.mother || "";
  document.getElementById("motherDob").value = data.motherDob || "";
  document.getElementById("motherDobText").value = data.motherDobText || "";
  document.getElementById("motherAge").value = data.motherAge || "";
  
  // Clear and reload siblings
  document.getElementById("siblingsContainer").innerHTML = "";
  if (data.siblings && data.siblings.length) {
    data.siblings.forEach(s => {
      const id = Date.now() + Math.random();
      document.getElementById("siblingsContainer").insertAdjacentHTML("beforeend", `
        <div class="section">
          <div class="section-title">Sibling <button class="btn danger" onclick="this.closest('.section').remove()" style="padding:5px 8px;font-size:11px;">Remove</button><div class="right"></div></div>
          <div class="grid4">
            <input placeholder="Sibling Name" data-sib-id="${id}" data-sib-name value="${escHtml(s.name)}" />
            <input placeholder="DOB (DD/MM/YYYY)" class="dob-auto-format" data-sib-id="${id}" data-sib-dob inputmode="numeric" maxlength="10" value="${escHtml(s.dob)}" onchange="computeSiblingAge(this)" />
            <input placeholder="DOB (MMM DD, YYYY)" data-sib-id="${id}" data-sib-dobtext readonly class="readonly" value="${escHtml(s.dobText)}" />
            <input placeholder="Age (Years, Months, Days)" data-sib-id="${id}" data-sib-age readonly class="readonly" value="${escHtml(s.age)}" />
          </div>
        </div>
      `);
    });
    attachDateInputBehavior();
  }
  
  // Load custom fields
  loadCustomFields(data.customFields || {});
  
  computeEmploymentTotals();
  
  // Enhance labels for professional typography
  enhanceAdminConsoleLabels();
  
  document.getElementById("listView").style.display = "none";
  document.getElementById("formView").style.display = "block";
}

function backToList() {
  refreshList();
}

function deleteCandidate() {
  const cid = document.getElementById("candidateId").value;
  if (!cid) { popupError("No candidate loaded"); return; }
  
  if (confirm("Delete this candidate permanently?")) {
    localStorage.removeItem("candidate_" + cid);
    setStatus("Candidate deleted.", true);
    setTimeout(() => refreshList(), 1000);
  }
}

// Open HireReady Services page for the current candidate
async function openHireReadyServices() {
  const cid = document.getElementById("candidateId").value.trim();
  if (!cid) {
    popupError("No candidate loaded. Please load a candidate first.");
    return;
  }

  if (!credentialsList || credentialsList.length === 0) {
    await refreshCredentialsList();
  }

  const credEntry = credentialsList.find(item => (item.candidateId || item.id || "") === cid);
  const isActivated = !!(credEntry && (credEntry.passwordHash || credEntry.plainPassword));
  if (!isActivated) {
    alert("Candidate credentials not activated yet.");
    return;
  }

  sessionStorage.setItem("hr_active_cid", cid);
  console.log('OPENING_CANDIDATE_PORTAL', { cid });

  window.open(`user.html?cid=${encodeURIComponent(cid)}`, "_blank");
}

// Open JD Match Resume in admin mode for current candidate
function openJDMatchAdmin() {
  const cid = document.getElementById("candidateId")?.value?.trim();
  if (!cid) {
    popupError("No candidate loaded. Please load a candidate first.");
    return;
  }
  window.open(`jdmatch.html?mode=admin&cid=${encodeURIComponent(cid)}`, "_blank");
}

async function deleteAllCloud() {
  if (!window.db || !window.auth || !window.auth.currentUser) {
    popupError("You must be logged in to delete cloud records.");
    return;
  }
  
  const typed = prompt('Type DELETE to confirm deleting ALL candidates from cloud. This cannot be undone:');
  if (typed !== "DELETE") {
    setStatus("Deletion cancelled.", false);
    return;
  }
  
  try {
    setStatus("Deleting all cloud records...", true);
    console.log("deleteAllCloud_START");
    
    let batchCount = 0;
    let docCount = 0;
    
    while (true) {
      const snap = await window.db.collection("candidates").limit(400).get();
      if (snap.empty) break;
      
      const batch = window.db.batch();
      snap.docs.forEach(doc => {
        batch.delete(doc.ref);
        docCount++;
      });
      await batch.commit();
      batchCount++;
      console.log("deleteAllCloud_BATCH", { batch: batchCount, docsDeleted: docCount });
    }
    
    // Clear local cache
    const localKeys = Object.keys(localStorage);
    localKeys.forEach(k => {
      if (k.startsWith("candidate_")) {
        localStorage.removeItem(k);
      }
    });
    
    console.log("deleteAllCloud_COMPLETE", { batches: batchCount, totalDeleted: docCount });
    refreshList();
    setStatus("Deleted " + docCount + " candidate(s) from cloud.", true);
    
  } catch (err) {
    console.error("deleteAllCloud_ERROR", err);
    const errMsg = err && err.message ? err.message : String(err);
    popupError("Cloud delete failed: " + errMsg);
    setStatus("Cloud delete failed.", false);
  }
}

// Auto-enhance Admin Console labels for professional typography and consistency
function enhanceAdminConsoleLabels() {
  // Only enhance Admin Console cards with data-section attribute
  const cards = document.querySelectorAll('.card[data-section]');
  
  cards.forEach(card => {
    // Skip if already enhanced
    if (card.dataset.labelsEnhanced === '1') return;
    
    // Process all grids within this card
    card.querySelectorAll('.grid').forEach(grid => {
      // Get direct children that are divs containing labels and inputs
      Array.from(grid.children).forEach(child => {
        // Find label within this child
        const label = child.querySelector('.field-label');
        if (label) {
          // Enhance label text: clean up redundant info in parentheses if needed
          // e.g., "IFSC (Bank IFSC code)" stays as is
          // This is just ensuring the label exists and is styled
          
          // Add aria-label to input for accessibility
          const input = child.querySelector('input, select, textarea');
          if (input && !input.getAttribute('aria-label')) {
            input.setAttribute('aria-label', label.textContent.trim());
          }
        }
      });
    });
    
    // Process textareas directly under card (non-grid)
    card.querySelectorAll('textarea').forEach(textarea => {
      const prevLabel = textarea.previousElementSibling;
      if (prevLabel && prevLabel.classList.contains('field-label')) {
        // Label already exists, just ensure aria-label
        if (!textarea.getAttribute('aria-label')) {
          textarea.setAttribute('aria-label', prevLabel.textContent.trim());
        }
      }
    });
    
    // Mark as enhanced
    card.dataset.labelsEnhanced = '1';
  });
  
  // Also enhance dynamically added company/sibling sections
  document.querySelectorAll('#companiesContainer .section, #siblingsContainer .section').forEach(section => {
    if (section.dataset.labelsEnhanced === '1') return;
    
    section.querySelectorAll('.grid, .grid4').forEach(grid => {
      Array.from(grid.children).forEach(child => {
        const label = child.querySelector('.field-label');
        if (label) {
          const input = child.querySelector('input, select, textarea');
          if (input && !input.getAttribute('aria-label')) {
            input.setAttribute('aria-label', label.textContent.trim());
          }
        }
      });
    });
    
    section.dataset.labelsEnhanced = '1';
  });
}

function exportListPdf() {
  try {
    const table = document.getElementById("candidatesTable");
    if (!table) { popupError("Candidates table not found"); return; }

    const rows = table.querySelectorAll("tbody tr");
    if (!rows || rows.length === 0) { popupError("No records to export"); return; }

    // Build a clean printable container
    const wrap = document.createElement("div");
    wrap.style.fontFamily = "Arial, Helvetica, sans-serif";
    wrap.style.padding = "16px";

    const title = document.createElement("div");
    title.textContent = "Candidate Details - List Export";
    title.style.fontSize = "18px";
    title.style.fontWeight = "700";
    title.style.color = "#1f3d6b";
    title.style.marginBottom = "6px";

    const meta = document.createElement("div");
    const now = new Date();
    meta.textContent = "Generated: " + now.toLocaleString() + " | Total records: " + rows.length;
    meta.style.fontSize = "12px";
    meta.style.color = "#475569";
    meta.style.marginBottom = "12px";

    // Clone the table and apply safe PDF styles
    const clone = table.cloneNode(true);

    clone.style.width = "100%";
    clone.style.borderCollapse = "collapse";
    clone.style.fontSize = "11px";

    clone.querySelectorAll("th, td").forEach(cell => {
      cell.style.border = "1px solid #d7deea";
      cell.style.padding = "8px";
      cell.style.verticalAlign = "top";
      cell.style.wordBreak = "break-word";
    });

    clone.querySelectorAll("thead th").forEach(th => {
      th.style.background = "#f3f6fb";
      th.style.color = "#1f3d6b";
      th.style.fontWeight = "700";
    });

    // Remove Actions column from export (optional but cleaner)
    const headRow = clone.querySelector("thead tr");
    if (headRow && headRow.lastElementChild) headRow.removeChild(headRow.lastElementChild);
    clone.querySelectorAll("tbody tr").forEach(tr => {
      if (tr.lastElementChild) tr.removeChild(tr.lastElementChild);
    });

    wrap.appendChild(title);
    wrap.appendChild(meta);
    wrap.appendChild(clone);

    const opt = {
      margin: 10,
      filename: "Candidate_List_" + now.toISOString().slice(0,10) + ".pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
      jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
    };

    html2pdf().set(opt).from(wrap).save();
  } catch (e) {
    popupError("Export list PDF failed: " + (e && e.message ? e.message : e));
  }
}

function openCustomFieldModal() {
  document.getElementById("cfLabel").value = "";
  document.getElementById("cfValue").value = "";
  document.getElementById("cfSection").value = "";
  document.getElementById("customFieldModal").style.display = "flex";
}

function closeCustomFieldModal() {
  document.getElementById("customFieldModal").style.display = "none";
}

// DYNAMIC FIELD CONFIGURATION METADATA
// This defines which fields are mandatory based on business rules
// Admin can modify this configuration to control validation behavior
const FIELD_CONFIG_METADATA = {
  // Global default: all fields are optional unless explicitly set as required
  default: { required: false, editable: true, description: "User-defined custom field" },
  
  // Standard fields that might be explicitly required
  "Certification": { required: false, editable: true, description: "Professional certification" },
  "Skills": { required: false, editable: true, description: "Technical or soft skills" },
  "Projects": { required: false, editable: true, description: "Notable projects" },
  "Languages": { required: false, editable: true, description: "Spoken languages" },
  "Hobbies": { required: false, editable: true, description: "Personal interests" },
  "References": { required: false, editable: true, description: "Professional references" }
  
  // Add more field definitions as needed by admin
  // Set required: true for fields that MUST have a value
};

function getFieldConfigMetadata(fieldLabel, section) {
  console.log("[CONFIG] Looking up metadata for field:", fieldLabel, "in section:", section);
  
  // Check if this field has explicit configuration
  const metadata = FIELD_CONFIG_METADATA[fieldLabel];
  
  if (metadata) {
    console.log("[CONFIG] Found explicit configuration:", metadata);
    return metadata;
  }
  
  // Use default configuration if field is not explicitly defined
  console.log("[CONFIG] Using default configuration (optional field)");
  return FIELD_CONFIG_METADATA.default;
}

function saveCustomField() {
  const label = document.getElementById("cfLabel").value.trim();
  const value = document.getElementById("cfValue").value.trim();
  const section = document.getElementById("cfSection").value;
  
  console.log("[VALIDATION] saveCustomField() called - Checking dynamic metadata");
  console.log("[VALIDATION] label:", label, "value:", value, "section:", section);
  
  // Dynamic validation: Only field label is mandatory
  // Field value is optional (admin allows empty values)
  if (!label) {
    console.log("[VALIDATION] FAILED: Field Label is missing (mandatory by design)");
    popupError("Please enter Field Label");
    return;
  }
  
  // Get field configuration metadata
  const fieldMetadata = getFieldConfigMetadata(label, section);
  console.log("[VALIDATION] Field metadata:", fieldMetadata);
  
  // Check if this field is marked as required in configuration
  const isFieldRequired = fieldMetadata && fieldMetadata.required === true;
  console.log("[VALIDATION] Is field marked required in config:", isFieldRequired);
  
  // Validate field value only if:
  // 1. Field is explicitly marked as required in configuration, OR
  // 2. Business rule demands it
  if (isFieldRequired && !value) {
    console.log("[VALIDATION] FAILED: Field Value is mandatory per configuration");
    popupError("Field '" + label + "' is marked as required. Please enter a value.");
    return;
  }
  
  // If admin creates field without required flag, empty value is allowed
  if (!isFieldRequired && !value) {
    console.log("[VALIDATION] SUCCESS: Field Value is optional (not marked required in config)");
  }
  
  // Validate section selection only if admin explicitly requires it
  if (!section) {
    console.log("[VALIDATION] WARNING: No section selected - using default");
  }
  
  const sectionContainer = getSectioncontainer(section || "Personal Information");
  
  if (!sectionContainer) {
    console.log("[VALIDATION] ERROR: Section container not found");
    popupError("Section container not found");
    return;
  }
  
  const fieldId = Date.now();
  const fieldHTML = `
    <div class="boxline" style="display:grid;grid-template-columns:1fr 85px 100px;gap:10px;margin-bottom:10px;padding:10px;">
      <div>
        <div style="font-size:11px;font-weight:700;color:#334155;margin-bottom:3px;">${escHtml(label)}</div>
        <div style="font-size:12px;color:#0f172a;">${escHtml(value || "(empty)")}</div>
      </div>
      <input type="hidden" data-cf-id="${fieldId}" data-cf-label value="${escHtml(label)}" class="customFieldLabel" />
      <input type="hidden" data-cf-id="${fieldId}" data-cf-value value="${escHtml(value)}" class="customFieldValue" />
      <input type="hidden" data-cf-id="${fieldId}" data-cf-section value="${escHtml(section || "Personal Information")}" />
      <input type="hidden" data-cf-id="${fieldId}" data-cf-required value="${isFieldRequired}" />
      <button class="btn danger" onclick="this.closest('.boxline').remove()" style="padding:8px;">Remove</button>
    </div>
  `;
  
  console.log("[VALIDATION] SUCCESS: Custom field saved with dynamic validation rules");
  sectionContainer.insertAdjacentHTML("beforeend", fieldHTML);
  closeCustomFieldModal();
}

function getSectioncontainer(sectionName) {
  const card = document.querySelector('[data-section="' + sectionName + '"]');
  if (!card) return null;
  
  const containerId = sectionName.replace(/\s+/g, "_").toLowerCase() + "_customFields";
  let container = document.getElementById(containerId);
  
  if (!container) {
    container = document.createElement("div");
    container.id = containerId;
    container.style.marginTop = "15px";
    container.style.borderTop = "1px solid #d7deea";
    container.style.paddingTop = "10px";
    card.appendChild(container);
  }
  
  return container;
}

function loadCustomFields(customFields = {}) {
  // Clear all section custom field containers
  const sectionNames = [
    "Record Info",
    "Personal Information",
    "Company Experience",
    "Highest Graduation",
    "Graduation",
    "Intermediate / Diploma",
    "10th Standard",
    "Family Details"
  ];
  
  sectionNames.forEach(sectionName => {
    const containerId = sectionName.replace(/\s+/g, "_").toLowerCase() + "_customFields";
    const container = document.getElementById(containerId);
    if (container) container.innerHTML = "";
  });
  
  console.log("[LOAD] Loading custom fields...", customFields);
  
  if (Array.isArray(customFields) && customFields.length) {
    customFields.forEach(field => {
      const fieldId = Date.now() + Math.random();
      const label = field.label || field;
      const value = field.value || "";
      const section = field.section || "";
      const isRequired = field.required || false;
      
      const sectionContainer = getSectioncontainer(section);
      if (sectionContainer) {
        sectionContainer.insertAdjacentHTML("beforeend", `
          <div class="boxline" style="display:grid;grid-template-columns:1fr 85px 100px;gap:10px;margin-bottom:10px;padding:10px;">
            <div>
              <div style="font-size:11px;font-weight:700;color:#334155;margin-bottom:3px;">${escHtml(label)}</div>
              <div style="font-size:12px;color:#0f172a;">${escHtml(value || "(empty)")}</div>
            </div>
            <input type="hidden" data-cf-id="${fieldId}" data-cf-label class="customFieldLabel" value="${escHtml(label)}" />
            <input type="hidden" data-cf-id="${fieldId}" data-cf-value class="customFieldValue" value="${escHtml(value)}" />
            <input type="hidden" data-cf-id="${fieldId}" data-cf-section value="${escHtml(section)}" />
            <input type="hidden" data-cf-id="${fieldId}" data-cf-required value="${isRequired}" />
            <button class="btn danger" onclick="this.closest('.boxline').remove()" style="padding:8px;">Remove</button>
          </div>
        `);
        console.log("[LOAD] Loaded field:", label, "Value:", value || "(empty)", "Required:", isRequired);
      }
    });
  } else if (typeof customFields === "object" && Object.keys(customFields).length) {
    Object.entries(customFields).forEach(([label, value]) => {
      const fieldId = Date.now() + Math.random();
      const sectionContainer = getSectioncontainer("Personal Information");
      if (sectionContainer) {
        sectionContainer.insertAdjacentHTML("beforeend", `
          <div class="boxline" style="display:grid;grid-template-columns:1fr 85px 100px;gap:10px;margin-bottom:10px;padding:10px;">
            <div>
              <div style="font-size:11px;font-weight:700;color:#334155;margin-bottom:3px;">${escHtml(label)}</div>
              <div style="font-size:12px;color:#0f172a;">${escHtml(value || "(empty)")}</div>
            </div>
            <input type="hidden" data-cf-id="${fieldId}" data-cf-label class="customFieldLabel" value="${escHtml(label)}" />
            <input type="hidden" data-cf-id="${fieldId}" data-cf-value class="customFieldValue" value="${escHtml(value)}" />
            <input type="hidden" data-cf-id="${fieldId}" data-cf-section value="" />
            <input type="hidden" data-cf-id="${fieldId}" data-cf-required value="false" />
            <button class="btn danger" onclick="this.closest('.boxline').remove()" style="padding:8px;">Remove</button>
          </div>
        `);
        console.log("[LOAD] Loaded legacy field:", label, "Value:", value || "(empty)");
      }
    });
  }
  
  console.log("[LOAD] Custom fields loading complete");
}

function getCustomFields() {
  const result = [];
  const sectionNames = [
    "Record Info",
    "Personal Information",
    "Company Experience",
    "Highest Graduation",
    "Graduation",
    "Intermediate / Diploma",
    "10th Standard",
    "Family Details"
  ];
  
  console.log("[COLLECT] Collecting custom fields...");
  
  sectionNames.forEach(sectionName => {
    const containerId = sectionName.replace(/\s+/g, "_").toLowerCase() + "_customFields";
    const sectionContainer = document.getElementById(containerId);
    if (sectionContainer) {
      sectionContainer.querySelectorAll("[data-cf-label]").forEach(el => {
        const label = el.value.trim();
        const cfId = el.getAttribute("data-cf-id");
        const valueEl = el.parentNode.querySelector('[data-cf-id="' + cfId + '"][data-cf-value]');
        const sectionEl = el.parentNode.querySelector('[data-cf-id="' + cfId + '"][data-cf-section]');
        const requiredEl = el.parentNode.querySelector('[data-cf-id="' + cfId + '"][data-cf-required]');
        
        const value = valueEl ? valueEl.value.trim() : "";
        const section = sectionEl ? sectionEl.value.trim() : "";
        const isRequired = requiredEl ? requiredEl.value === "true" : false;
        
        console.log("[COLLECT] Field:", label, "Value:", value || "(empty)", "Required:", isRequired, "Section:", section);
        
        // Only add to result if both label AND value are present
        // (empty values are stored but can be submitted if not marked required)
        if (label) {
          result.push({ label, value, section, required: isRequired });
        }
      });
    }
  });
  
  console.log("[COLLECT] Total fields collected:", result.length);
  return result;
}

function toggleSection() {}

function getVisibilityMap() {
  return {
    record: document.getElementById("visRecord").checked,
    personal: document.getElementById("visPersonal").checked,
    company: document.getElementById("visCompany").checked,
    hg: document.getElementById("visHg").checked,
    g: document.getElementById("visG").checked,
    i: document.getElementById("visI").checked,
    t: document.getElementById("visT").checked,
    family: document.getElementById("visFamily").checked
  };
}

function escHtml(s) {
  const x = (s === null || s === undefined) ? "" : String(s);
  return x.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function buildPrintHtml(data) {
  const vis = getVisibilityMap();
  const fullName = data.fullName || "";

  const pdfDate = (dmyValue, textValue) => {
    const text = (textValue || "").trim();
    if (text) return text;
    const dmy = (dmyValue || "").trim();
    if (!dmy) return "";
    const parsed = parseDMY(dmy);
    return parsed ? formatMMMDD(parsed) : "";
  };

  const stripBrackets = (label) => {
    if (!label) return "";
    return String(label).replace(/\s*\([^)]*\)\s*/g, " ").replace(/\s+/g, " ").trim();
  };

  const f2c = (l1, v1, l2, v2) => `
    <div class="pdf-two-col" style="max-width:100%;">
      <div class="pdf-field" style="min-width:0;">
        <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(l1)}</div>
        <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(v1||"")}</div>
      </div>
      <div class="pdf-field" style="min-width:0;">
        <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(l2)}</div>
        <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(v2||"")}</div>
      </div>
    </div>
  `;

  const f1c = (l, v) => `
    <div class="pdf-field" style="max-width:100%;">
      <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(l)}</div>
      <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(v||"")}</div>
    </div>
  `;

  const f3c = (l1, v1, l2, v2, l3, v3) => `
    <div class="pdf-three-col" style="max-width:100%;">
      <div class="pdf-field" style="min-width:0;">
        <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(l1)}</div>
        <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(v1||"")}</div>
      </div>
      <div class="pdf-field" style="min-width:0;">
        <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(l2)}</div>
        <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(v2||"")}</div>
      </div>
      <div class="pdf-field" style="min-width:0;">
        <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(l3)}</div>
        <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(v3||"")}</div>
      </div>
    </div>
  `;

  const sec = (title, body) => `
    <div class="pdf-section" style="margin-top:16px;border:1px solid #d7deea;max-width:100%;box-sizing:border-box;overflow:hidden;">
      <div class="pdf-section-bar" style="overflow-wrap:anywhere;word-break:break-word;text-align:left;">${escHtml(title)}</div>
      <div style="padding:12px;max-width:100%;box-sizing:border-box;">${body}</div>
    </div>
  `;

  let html = `
    <style>
      /* PDF_EXPORT_VERSION: 2026-02-12-A4FULL */
      html, body { margin: 0; padding: 0; background: #ffffff; }
      #pdfRoot, #pdfRoot * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; color: #0f172a; }
      #pdfRoot { width: 210mm; min-height: 297mm; padding: 8mm; background: #ffffff; margin: 0; }
      #pdfPage { width: 100%; min-height: 297mm; padding: 10mm; background: #ffffff; border: 1px solid #d7dee8; margin: 0; }
      .pdf-content { width: 100%; }
      .pdf-section-bar { background:#1f3f6a; color:#ffffff !important; padding:10px 14px; font-weight:700; font-size:14px; line-height:1.2; border-radius:3px; }
      .pdf-section-bar *{ color:#ffffff !important; -webkit-text-fill-color:#ffffff !important; }
      .pdf-two-col { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .pdf-three-col { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
      .pdf-four-col { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
      .pdf-field {
        border: 1px solid #d7deea;
        border-radius: 2px;
        overflow: hidden;
        padding: 0;
        background: #ffffff;
      }
      .pdf-label {
        background: #f3f6fb;
        color: #1f3d6b;
        font-weight: 700;
        font-size: 12px;
        padding: 8px 10px;
        margin: 0;
        border-bottom: 1px solid #d7deea;
      }
      .pdf-value { font-size:12px; padding: 10px; margin:0; min-height: 20px; }
      .pdf-version { font-size:10px; color:#94a3b8; margin:0 0 8px 0; }
      
      /* Page break controls */
      .pdf-section { break-inside: avoid; page-break-inside: avoid; }
      .pdf-section-bar { break-after: avoid; page-break-after: avoid; }
      .pdf-two-col { break-inside: avoid; page-break-inside: avoid; }
      .pdf-field { break-inside: avoid; page-break-inside: avoid; }
      .pdf-section table, .pdf-section tr, .pdf-section td { break-inside: avoid; page-break-inside: avoid; }
    </style>
    <div id="pdfRoot">
      <div id="pdfPage">
        <div class="pdf-content">
          <div style="border:1px solid #d7deea;padding:12px;margin-bottom:14px;background:#f9fafb;">
            <h1 style="margin:0 0 8px 0;font-size:20px;color:#1f3d6b;text-align:center;">Candidate Details</h1>
        <div style="text-align:center;color:#0f172a;">
          <div style="font-size:13px;font-weight:700;margin-bottom:2px;">${escHtml(fullName)}</div>
        </div>
      </div>
  `;

  if (vis.record) {
    let body = "";
    body += f3c("Candidate Name", data.fullName, "Candidate ID", data.candidateId, "Domain", "");
    html += sec("Record Info", body);
  }

  if (vis.personal) {
    let body = "";
    body += f2c("Full Name as per Aadhaar", data.fullName, "Preferred Name", data.preferredName);
    body += f2c("Gender", data.gender, "WhatsApp Number", data.whatsapp);
    body += f2c("Date of Birth", pdfDate(data.dob, data.dobText), "Date of Birth (Text)", pdfDate(data.dob, data.dobText));
    body += f2c("Age", data.ageYmd, "Marital Status", data.marital);
    body += f2c("Blood Group", data.blood, "SIM Number", data.sim);
    body += f2c("Professional Email ID", data.email, "Aadhaar Number", data.aadhaar);
    body += f2c("PAN Number", data.pan, "Passport Number", data.passport);
    body += f2c("Bank Account Number", data.bank, "UAN (Universal Account Number)", data.uanNumber);
    body += f2c("IFSC (Bank IFSC code)", data.ifscCode, "NAME OF THE BANK", data.bankName);
    body += f1c("Permanent Address", data.permanentAddress);
    body += f1c("Current Address", data.currentAddress);
    html += sec("Personal Information", body);
  }

  if (vis.company) {
    const companyBlocks = Array.from(document.querySelectorAll("#companiesContainer .section[data-company-block]"));
    const getCompanyPlaceholder = (block, selector, fallback) => {
      const el = block ? block.querySelector(selector) : null;
      const ph = el ? (el.getAttribute("placeholder") || "") : "";
      return ph || fallback;
    };

    let body = "";
    body += `
      <div class="pdf-two-col" style="max-width:100%;">
        <div class="pdf-field" style="min-width:0;">
          <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">Total Experience</div>
          <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(data.totalExperience || "")}</div>
        </div>
        <div class="pdf-field" style="min-width:0;">
          <div class="pdf-label" style="overflow-wrap:anywhere;word-break:break-word;">Relevant Experience</div>
          <div class="pdf-value" style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(data.relevantExperience || "")}</div>
        </div>
      </div>
    `;

    if (data.companies.length) {
      data.companies.forEach((c, idx) => {
        const block = companyBlocks[idx] || null;
        const companyLabel = idx === 0 ? "Current Company / Recent Company" : `Previous Company ${idx}`;
        const experienceDisplay = c.experienceInCompany || "";
        
        const labelCompany = getCompanyPlaceholder(block, "[data-co-name]", "Company Name");
        const labelPayroll = getCompanyPlaceholder(block, "[data-co-payroll]", "Payroll Company");
        const labelDesignation = getCompanyPlaceholder(block, "[data-co-desig]", "Designation");
        const expLabelFallback = idx === 0
          ? "Experience of Current Company / Recent Company (Years Months)"
          : `Experience of Previous Company ${idx} (Years Months)`;
        const labelExperience = getCompanyPlaceholder(block, "[data-co-expcomp]", expLabelFallback);
        const labelJoining = getCompanyPlaceholder(block, "[data-co-joining]", "Joining Date (MMM DD, YYYY)");
        const labelLastWorking = getCompanyPlaceholder(block, "[data-co-lastwork]", "Last Working Date (MMM DD, YYYY)");
        const labelCtc = getCompanyPlaceholder(block, "[data-co-ctc]", "CTC");
        const labelMonthlyGross = getCompanyPlaceholder(block, "[data-co-gross]", "Monthly Gross");
        const labelInHand = getCompanyPlaceholder(block, "[data-co-inhand]", "In Hand Salary");
        const labelRemarks = getCompanyPlaceholder(block, "[data-co-remarks]", "Remarks");

        body += `
          <div style="margin-top:14px;border:1px solid #d7deea;overflow:hidden;max-width:100%;box-sizing:border-box;">
            <div style="background:#e7f0ff;color:#1f3d6b;font-weight:700;padding:8px 12px;font-size:12px;display:flex;justify-content:space-between;align-items:center;max-width:100%;box-sizing:border-box;">
              <span style="overflow-wrap:anywhere;word-break:break-word;">${escHtml(companyLabel)}</span>
              <span style="background:#1f3d6b;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;margin-left:8px;flex-shrink:0;white-space:nowrap;">${escHtml(experienceDisplay)}</span>
            </div>
            <div style="padding:12px;max-width:100%;box-sizing:border-box;">
              <div class="pdf-two-col" style="column-gap:16px;row-gap:12px;max-width:100%;box-sizing:border-box;">
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelCompany))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(c.company)}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelPayroll))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(c.payroll)}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelDesignation))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(c.designation)}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelExperience))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(c.experienceInCompany)}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelJoining))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(pdfDate(c.joiningDate, c.joiningDateText))}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelLastWorking))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(pdfDate(c.lastWorkingDate, c.lastWorkingDateText))}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelCtc))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(fmtInt(c.ctc))}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelMonthlyGross))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(fmtInt(c.monthlyGross))}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelInHand))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(fmtInt(c.inHandSalary))}</div>
                </div>
                <div style="min-width:0;box-sizing:border-box;grid-column:1/-1;">
                  <div style="font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(stripBrackets(labelRemarks))}</div>
                  <div style="font-size:11px;color:#0f172a;border-bottom:1px dotted #cbd5e1;padding-bottom:3px;min-height:18px;overflow-wrap:anywhere;word-break:break-word;">${escHtml(c.remarks)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
    }

    html += sec("Employment History", body);
  }

  if (vis.hg) {
    const hg = data.hg || {};
    let body = f2c("Degree", hg.degree, "Branch", hg.branch) + f2c("College", hg.college, "College Address", hg.collegeAddress) + f2c("University", hg.university, "University Address", hg.universityAddress) + f2c("Percentage / CGPA", hg.percentage, "Duration", hg.duration) + f1c("Completion Delay", hg.delay);
    html += sec("Highest Graduation", body);
  }

  if (vis.g) {
    const g = data.g || {};
    let body = f2c("Degree", g.degree, "Branch", g.branch) + f2c("College", g.college, "College Address", g.collegeAddress) + f2c("University Address", g.universityAddress, "Percentage / CGPA", g.percentage) + f2c("Duration", g.duration, "Completion Delay", g.delay);
    html += sec("Graduation", body);
  }

  if (vis.i) {
    const i = data.i || {};
    let body = f2c("Type", i.type, "Branch", i.branch) + f2c("College", i.college, "College Address", i.collegeAddress) + f2c("Board / University", i.board, "Board Address", i.boardAddress) + f2c("Percentage / CGPA", i.percentage, "Duration", i.duration) + f1c("Completion Delay", i.delay);
    html += sec("Intermediate / Diploma", body);
  }

  if (vis.t) {
    const t = data.t || {};
    let body = f2c("School", t.school, "School Address", t.schoolAddress) + f2c("Board", t.board, "Board Address", t.boardAddress) + f2c("Percentage / CGPA", t.percentage, "Duration", t.duration) + f1c("Completion Delay", t.delay);
    html += sec("10th Standard", body);
  }

  if (vis.family) {
    let body = "";

    // Father
    body += `<div style="margin-top:10px;background:#e7f0ff;color:#1f3d6b;font-weight:700;padding:7px 10px;font-size:12px;">Father</div>`;
    body += `<table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:11px;"><thead><tr style="background:#f3f6fb;">
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">Name</th>
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">DOB</th>
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">DOB (MMM DD, YYYY)</th>
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">Age</th>
    </tr></thead><tbody>
      <tr>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(data.father || "")}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(data.fatherDob || "")}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(pdfDate(data.fatherDob, data.fatherDobText) || "")}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(data.fatherAge || "")}</td>
      </tr>
    </tbody></table>`;

    // Mother
    body += `<div style="margin-top:10px;background:#e7f0ff;color:#1f3d6b;font-weight:700;padding:7px 10px;font-size:12px;">Mother</div>`;
    body += `<table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:11px;"><thead><tr style="background:#f3f6fb;">
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">Name</th>
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">DOB</th>
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">DOB (MMM DD, YYYY)</th>
      <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">Age</th>
    </tr></thead><tbody>
      <tr>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(data.mother || "")}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(data.motherDob || "")}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(pdfDate(data.motherDob, data.motherDobText) || "")}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(data.motherAge || "")}</td>
      </tr>
    </tbody></table>`;

    // Siblings
    if (data.siblings && data.siblings.length) {
      body += `<div style="margin-top:10px;background:#e7f0ff;color:#1f3d6b;font-weight:700;padding:7px 10px;font-size:12px;">Siblings</div>`;
      body += `<table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:11px;"><thead><tr style="background:#f3f6fb;">
        <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">Name</th>
        <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">DOB</th>
        <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">DOB (MMM DD, YYYY)</th>
        <th style="border:1px solid #d7deea;padding:7px 8px;text-align:left;color:#1f3d6b;font-weight:700;">Age</th>
      </tr></thead><tbody>` + data.siblings.map(s => `<tr>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(s.name)}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(s.dob)}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(pdfDate(s.dob, s.dobText))}</td>
        <td style="border:1px solid #d7deea;padding:7px 8px;">${escHtml(s.age)}</td>
      </tr>`).join("") + `</tbody></table>`;
    }

    html += sec("Family Details", body);
  }

  // Add custom fields to PDF if they exist
  if (data.customFields && data.customFields.length) {
    let body = "";
    const customFieldsBySection = {};
    
    data.customFields.forEach(field => {
      const section = field.section || "General";
      if (!customFieldsBySection[section]) {
        customFieldsBySection[section] = [];
      }
      customFieldsBySection[section].push(field);
    });
    
    Object.entries(customFieldsBySection).forEach(([section, fields]) => {
      body += `<div style="margin-top:10px;background:#e7f0ff;color:#1f3d6b;font-weight:700;padding:7px 10px;font-size:12px;">Custom Fields - ${escHtml(section)}</div>`;
      fields.forEach(field => {
        body += f2c(escHtml(field.label), escHtml(field.value), "", "");
      });
    });
    
    html += sec("Custom Fields", body);
  }

  html += `
        </div>
      </div>
    </div>
  `;
  return html;
}

function exportPdf() {
  const candidateId = document.getElementById("candidateId").value.trim();
  if (!candidateId) {
    popupError("No candidate loaded");
    return;
  }

  computeEmploymentTotals();

  const data = collectForm();
  const html = buildPrintHtml(data);

  const host = document.createElement("div");
  host.id = "__pdfHost";
  host.style.position = "fixed";
  host.style.left = "0";
  host.style.top = "-100000px";
  host.style.zIndex = "-1";
  host.style.pointerEvents = "none";
  host.style.background = "#ffffff";
  host.style.margin = "0";
  host.style.padding = "0";
  host.innerHTML = html;
  document.body.appendChild(host);

  const pdfRoot = host.querySelector("#pdfRoot");
  if (!pdfRoot) {
    popupError("Export failed: #pdfRoot not found");
    host.remove();
    return;
  }

  console.log("PDF_EXPORT_RECT_ROOT", pdfRoot.getBoundingClientRect());
  console.log("PDF_EXPORT_RECT_PAGE", (host.querySelector("#pdfPage")||pdfRoot).getBoundingClientRect());

  // Sanitize filename from candidate full name
  const rawName = (data.fullName || '').trim();
  const safeName = (rawName || 'candidate')
    .replace(/[\\/:*?"<>|]+/g, '')   // remove invalid filename chars (Windows)
    .replace(/\s+/g, ' ')           // collapse whitespace
    .trim()
    .replace(/ /g, '_');            // spaces -> underscores
  const pdfFileName = `${safeName}_details.pdf`;

  const opt = {
    margin: 0,
    filename: pdfFileName,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, scrollX: 0, scrollY: 0 },
    jsPDF: {
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait'
    },
    pagebreak: {
      mode: ['css', 'legacy'],
      avoid: ['.pdf-section', '.pdf-section-bar', '.pdf-two-col', '.pdf-field']
    }
  };

  html2pdf()
    .set(opt)
    .from(pdfRoot)
    .save()
    .catch(err => {
      console.error("EXPORT_PDF_FAILED", err);
      popupError("Export PDF failed. Check console.");
    })
    .finally(() => {
      host.remove();
    });
}

// Auto-login on page load if currentUser exists
document.addEventListener("DOMContentLoaded", function () {
  console.log("INIT_DOMCONTENTLOADED");

  attachDateInputBehavior();
  setupSubscriptionFieldListeners();

  // Delegated listener for DOB auto-formatting (handles all current and future siblings)
  document.addEventListener('input', function(e) {
    const el = e.target;
    if (!el || !el.classList || !el.classList.contains('dob-auto-format')) return;
    const before = el.value;
    const caret = el.selectionStart || 0;
    const next = formatDMYLive(before);
    el.value = next;
    const delta = next.length - before.length;
    const pos = Math.max(0, Math.min(next.length, caret + delta));
    try { el.setSelectionRange(pos, pos); } catch(e) {}
  });

  wireEmploymentEvents();
  applyEmploymentChainingAndValidate(false);

  if (!firebaseReady || !auth) {
    setView("login");
    return;
  }

  auth.onAuthStateChanged(async (user) => {
    console.log("AUTH_STATE", user ? user.email : null);
    currentUser = user;

    if (!user) {
      setView("login");
      return;
    }

    const email = (user.email || "").toLowerCase();
    const isAdmin = ADMIN_EMAILS.includes(email);
    console.log("ADMIN_CHECK", { email, isAdmin });

    if (!isAdmin) {
      popupError("Access denied. Admins only.");
      auth.signOut();
      setView("login");
      return;
    }

    document.getElementById("userEmail").textContent = user.email || "";
    await loadServicesCatalog();
    setView("list");
    wireListEventsOnce();
    wireCredentialsEventsOnce();

    try {
      await syncFromCloud();
    } catch (e) {
      console.error("POST_LOGIN_LOAD_ERROR", e);
    }
  });

  const planEl = document.getElementById("subscriptionPlanType");
  const startEl = document.getElementById("subscriptionStartDate");
  const endEl = document.getElementById("subscriptionEndDate");
  if (planEl) planEl.addEventListener("change", applySubscriptionPlan);
  if (startEl) startEl.addEventListener("change", refreshSubscriptionStatus);
  if (endEl) endEl.addEventListener("change", refreshSubscriptionStatus);
  
  // Wire Export Word button with diagnostics
  const regFormExportBtn = document.getElementById("regFormExportWordBtn");
  if (regFormExportBtn) {
    regFormExportBtn.addEventListener("click", (e) => {
      e.preventDefault();
      console.log("EXPORT_WORD_CLICK");
      exportRegistrationFormWord();
    });
  }
});

// ============================================================
// DATE HELPERS & INDIAN HOLIDAY VALIDATION
// ============================================================

// Parse DD/MM/YYYY -> Date
function parseDateDMY(str) {
  if (!str || typeof str !== 'string') return null;
  const m = str.trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!m) return null;
  const d = new Date(parseInt(m[3]), parseInt(m[2]) - 1, parseInt(m[1]));
  if (isNaN(d.getTime())) return null;
  return d;
}

// Parse MMM DD, YYYY -> Date
function parseDateMMM(str) {
  if (!str || typeof str !== 'string') return null;
  const d = new Date(str.trim());
  if (isNaN(d.getTime())) return null;
  return d;
}

// Format Date -> "MMM DD, YYYY"
function formatDateMMMDDYYYY(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return "";
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  return months[date.getMonth()] + " " + String(date.getDate()).padStart(2, '0') + ", " + date.getFullYear();
}

// Format Date -> "YYYY-MM-DD" (local, no TZ shift)
function toISODate(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return "";
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return y + "-" + m + "-" + d;
}

// Holiday cache: year -> Set("YYYY-MM-DD")
const holidayCache = new Map();

// Fallback Indian holidays (if API fails)
function fallbackHolidaySet(year) {
  return new Set([
    year + "-01-26", // Republic Day
    year + "-08-15", // Independence Day
    year + "-10-02", // Gandhi Jayanti
    year + "-05-01"  // Labour Day (fallback)
  ]);
}

// Fetch Indian holidays from Nager.Date API
async function getIndianHolidaySet(year) {
  if (holidayCache.has(year)) {
    return holidayCache.get(year);
  }
  
  try {
    const resp = await fetch("https://date.nager.at/api/v3/PublicHolidays/" + year + "/IN");
    if (!resp.ok) throw new Error("API returned " + resp.status);
    const data = await resp.json();
    const holidaySet = new Set(data.map(h => h.date));
    holidayCache.set(year, holidaySet);
    console.log("Loaded Indian holidays for " + year + ":", holidaySet.size);
    return holidaySet;
  } catch (err) {
    console.warn("Holiday API failed for " + year + ", using fallback:", err.message);
    const fallbackSet = fallbackHolidaySet(year);
    holidayCache.set(year, fallbackSet);
    return fallbackSet;
  }
}

// Check if date is an Indian public holiday
async function isIndianHoliday(date) {
  if (!date || !(date instanceof Date)) return false;
  const holidaySet = await getIndianHolidaySet(date.getFullYear());
  return holidaySet.has(toISODate(date));
}

// Check if date is weekend (Saturday=6, Sunday=0)
function isWeekend(date) {
  if (!date || !(date instanceof Date)) return false;
  const day = date.getDay();
  return day === 0 || day === 6;
}

// Check if date is a working day
async function isWorkingDay(date) {
  if (!date || !(date instanceof Date)) return false;
  if (isWeekend(date)) return false;
  return !(await isIndianHoliday(date));
}

// Adjust date backward to working day
async function adjustBackwardToWorkingDay(date) {
  if (!date || !(date instanceof Date)) return date;
  const d = new Date(date.getTime());
  while (!(await isWorkingDay(d))) {
    d.setDate(d.getDate() - 1);
  }
  return d;
}

// Compute Offer Date = Joining Date - 10 days (adjusted to working day)
async function computeOfferDate(joiningDate) {
  if (!joiningDate || !(joiningDate instanceof Date)) return null;
  const base = new Date(joiningDate.getTime());
  base.setDate(base.getDate() - 10);
  return await adjustBackwardToWorkingDay(base);
}

// Compute Resignation Date = Relieving Date - 30 days (adjusted to working day)
async function computeResignationDate(relievingDate) {
  if (!relievingDate || !(relievingDate instanceof Date)) return null;
  const base = new Date(relievingDate.getTime());
  base.setDate(base.getDate() - 30);
  return await adjustBackwardToWorkingDay(base);
}

// Compute Hike Date = Today - 8 months (adjusted to working day)
async function computeHikeDate() {
  const base = new Date();
  base.setMonth(base.getMonth() - 8);
  return await adjustBackwardToWorkingDay(base);
}

// ============================================================
// ENHANCED DATE/CTC HELPERS FOR REGISTRATION FORM AUTO-FILL
// ============================================================

// PUBLIC_HOLIDAYS: array of "YYYY-MM-DD" strings for Indian public holidays
// This is a hardcoded list; extend as needed
const PUBLIC_HOLIDAYS = [
  // 2020
  "2020-01-26", "2020-03-10", "2020-04-02", "2020-04-06", "2020-04-10", "2020-04-14",
  "2020-05-01", "2020-05-07", "2020-05-25", "2020-08-01", "2020-08-15", "2020-08-22",
  "2020-10-02", "2020-10-25", "2020-11-14", "2020-11-16", "2020-11-30", "2020-12-25",
  // 2021
  "2021-01-26", "2021-03-11", "2021-03-29", "2021-04-02", "2021-04-14", "2021-04-21",
  "2021-05-01", "2021-05-13", "2021-05-26", "2021-07-21", "2021-08-15", "2021-08-19",
  "2021-08-30", "2021-09-10", "2021-10-02", "2021-10-15", "2021-11-04", "2021-11-05",
  "2021-11-19", "2021-12-25",
  // 2022
  "2022-01-26", "2022-03-01", "2022-03-18", "2022-04-14", "2022-04-15", "2022-05-01",
  "2022-05-03", "2022-05-16", "2022-08-09", "2022-08-15", "2022-08-19", "2022-08-31",
  "2022-10-02", "2022-10-05", "2022-10-24", "2022-10-26", "2022-11-08", "2022-12-25",
  // 2023
  "2023-01-26", "2023-03-07", "2023-03-22", "2023-03-30", "2023-04-04", "2023-04-07",
  "2023-04-14", "2023-05-01", "2023-05-05", "2023-06-29", "2023-08-15", "2023-08-30",
  "2023-09-19", "2023-10-02", "2023-10-24", "2023-11-12", "2023-11-13", "2023-11-14",
  "2023-11-27", "2023-12-25",
  // 2024
  "2024-01-26", "2024-03-08", "2024-03-25", "2024-03-29", "2024-04-11", "2024-04-17",
  "2024-04-21", "2024-05-01", "2024-05-23", "2024-06-17", "2024-07-17", "2024-08-15",
  "2024-08-26", "2024-09-07", "2024-10-02", "2024-10-12", "2024-10-31", "2024-11-01",
  "2024-11-02", "2024-11-15", "2024-12-25",
  // 2025
  "2025-01-26", "2025-02-26", "2025-03-14", "2025-03-31", "2025-04-10", "2025-04-14",
  "2025-04-18", "2025-05-01", "2025-05-12", "2025-06-06", "2025-08-15", "2025-08-16",
  "2025-08-27", "2025-10-02", "2025-10-21", "2025-10-22", "2025-11-03", "2025-11-05",
  "2025-12-25",
  // 2026
  "2026-01-26", "2026-02-17", "2026-03-03", "2026-03-20", "2026-03-31", "2026-04-02",
  "2026-04-06", "2026-05-01", "2026-05-26", "2026-08-15", "2026-08-25", "2026-09-17",
  "2026-10-02", "2026-10-09", "2026-10-10", "2026-10-23", "2026-11-16", "2026-11-25",
  "2026-12-25",
  // 2027
  "2027-01-26", "2027-02-06", "2027-02-20", "2027-03-11", "2027-03-22", "2027-03-26",
  "2027-04-14", "2027-05-01", "2027-05-15", "2027-08-04", "2027-08-15", "2027-08-25",
  "2027-09-06", "2027-09-29", "2027-10-02", "2027-10-28", "2027-11-04", "2027-11-05",
  "2027-11-15", "2027-12-25"
];

// Check if date is in PUBLIC_HOLIDAYS
function isHoliday(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return false;
  const iso = toISODate(date);
  return PUBLIC_HOLIDAYS.includes(iso);
}

// Month arithmetic: add months to date, clamp day if target month shorter
function addMonthsClamped(date, months) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return null;
  const d = new Date(date.getTime());
  d.setMonth(d.getMonth() + months);
  // If day got clamped by JS (e.g., Jan 31 + 1 month -> Feb 28/29), accept it
  return d;
}

function subtractMonthsClamped(date, months) {
  return addMonthsClamped(date, -months);
}

// Adjust date to NEXT working day (forward)
function adjustToNextWorkingDay(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return date;
  const d = new Date(date.getTime());
  while (isWeekend(d) || isHoliday(d)) {
    d.setDate(d.getDate() + 1);
  }
  return d;
}

// Adjust date to PREVIOUS working day (backward)
function adjustToPreviousWorkingDay(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return date;
  const d = new Date(date.getTime());
  while (isWeekend(d) || isHoliday(d)) {
    d.setDate(d.getDate() - 1);
  }
  return d;
}

// Simple hash function for deterministic selection
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = ((h << 5) - h) + str.charCodeAt(i);
    h = h & h; // Convert to 32bit integer
  }
  return Math.abs(h);
}

// Round down to nearest hundred (for salary values)
function roundDownToHundred(n) {
  return Math.floor(n / 100) * 100;
}

// Get Friday of this week (current week containing today)
function getThisWeekFriday(today = new Date()) {
  const d = new Date(today.getTime());
  const dayOfWeek = d.getDay(); // 0=Sun, 1=Mon, ..., 5=Fri, 6=Sat
  const daysToFriday = 5 - dayOfWeek; // Days to advance to reach Friday
  d.setDate(d.getDate() + daysToFriday);
  return adjustToPreviousWorkingDay(d);
}

// Pick integer in range [min, max] excluding forbidden values, deterministically
function pickIntInRange(min, max, forbiddenSet, salt) {
  const allowed = [];
  for (let i = min; i <= max; i++) {
    if (!forbiddenSet.has(i)) {
      allowed.push(i);
    }
  }
  if (allowed.length === 0) return min; // fallback
  const idx = (salt || 0) % allowed.length;
  return allowed[idx];
}

// Parse CTC string to number
function parseCTC(str) {
  if (!str || typeof str !== 'string') return NaN;
  const cleaned = str.replace(/[^0-9.]/g, '');
  return parseFloat(cleaned);
}

// Format numeric values as whole numbers for UI display
function fmtInt(v) {
  if (v === null || v === undefined) return "";
  const n = Number(String(v).replace(/,/g, "").trim());
  if (Number.isNaN(n)) return "";
  return String(Math.round(n));
}

// Round to 2 decimal places
function roundTo2(n) {
  return Math.round(n * 100) / 100;
}

// Round down to nearest thousand (for CTC values)
function roundDownToThousand(n) {
  return Math.floor(n / 1000) * 1000;
}

// Compute Offer Date: 7-15 days before joining (not 10), working day, deterministic
function computeOfferDateDeterministic(joiningDate, hash) {
  if (!joiningDate || !(joiningDate instanceof Date) || isNaN(joiningDate.getTime())) return null;
  const offset = pickIntInRange(7, 15, new Set([10]), hash + 1);
  const candidate = new Date(joiningDate.getTime());
  candidate.setDate(candidate.getDate() - offset);
  return adjustToPreviousWorkingDay(candidate);
}

// Compute Resignation Date: 25-35 days before relieving (not 30), working day, deterministic
function computeResignationDateDeterministic(relievingDate, hash) {
  if (!relievingDate || !(relievingDate instanceof Date) || isNaN(relievingDate.getTime())) return null;
  const offset = pickIntInRange(25, 35, new Set([30]), hash + 2);
  const candidate = new Date(relievingDate.getTime());
  candidate.setDate(candidate.getDate() - offset);
  return adjustToPreviousWorkingDay(candidate);
}

// Compute hike dates with all constraints:
// - First hike: ~1 year after joining, NOT in first 10 days of anniversary month, working day
// - Subsequent hikes: 11-13 months apart, working day
// - Most recent hike: >= 8 months before relieving date
function computeHikeDates(joiningDate, relievingDate, hash) {
  if (!joiningDate || !relievingDate || !(joiningDate instanceof Date) || !(relievingDate instanceof Date)) {
    return [];
  }
  if (isNaN(joiningDate.getTime()) || isNaN(relievingDate.getTime())) return [];
  
  // Last allowed hike date = relieving - 8 months - (2-15 extra days), adjusted to working day
  const base8mo = subtractMonthsClamped(relievingDate, 8);
  if (!base8mo) return [];
  const extraDays = pickIntInRange(2, 15, new Set(), 77); // deterministic 2-15 days, NEVER 0
  const lastAllowedRaw = new Date(base8mo.getTime());
  lastAllowedRaw.setDate(lastAllowedRaw.getDate() - extraDays);
  const lastAllowedHikeDate = adjustToPreviousWorkingDay(lastAllowedRaw);
  
  // Compute first hike date
  const anniversary = addMonthsClamped(joiningDate, 12);
  if (!anniversary) return [];
  
  // Excluded window: first 10 days of anniversary month
  const excludedStart = new Date(anniversary.getFullYear(), anniversary.getMonth(), 1);
  const excludedEnd = new Date(anniversary.getFullYear(), anniversary.getMonth(), 10);
  
  // Try to find first hike in anniversary month or next month
  let firstHikeDate = null;
  
  // Strategy: pick a day deterministically in allowed window
  const monthsToTry = [
    { year: anniversary.getFullYear(), month: anniversary.getMonth() },
    { year: anniversary.getFullYear(), month: anniversary.getMonth() + 1 }
  ];
  
  for (let mi = 0; mi < monthsToTry.length && !firstHikeDate; mi++) {
    const tryMonth = monthsToTry[mi];
    let tryYear = tryMonth.year;
    let tryMonthIdx = tryMonth.month;
    
    // Handle month overflow
    if (tryMonthIdx > 11) {
      tryMonthIdx = tryMonthIdx - 12;
      tryYear++;
    }
    
    const monthStart = new Date(tryYear, tryMonthIdx, 1);
    const monthEnd = new Date(tryYear, tryMonthIdx + 1, 0); // last day of month
    
    // If this is anniversary month, start AFTER excluded window
    let searchStart = monthStart;
    if (mi === 0) {
      searchStart = new Date(excludedEnd.getTime());
      searchStart.setDate(searchStart.getDate() + 1); // day after excluded end
    }
    
    // If searchStart > monthEnd, skip this month
    if (searchStart.getTime() > monthEnd.getTime()) continue;
    
    // If monthEnd > lastAllowedHikeDate, cap at lastAllowedHikeDate
    let searchEnd = monthEnd;
    if (searchEnd.getTime() > lastAllowedHikeDate.getTime()) {
      searchEnd = lastAllowedHikeDate;
    }
    
    // If searchStart > searchEnd, skip
    if (searchStart.getTime() > searchEnd.getTime()) continue;
    
    // Pick a deterministic day in range
    const daysInRange = Math.floor((searchEnd.getTime() - searchStart.getTime()) / (24 * 60 * 60 * 1000)) + 1;
    if (daysInRange < 1) continue;
    
    const pickDay = ((hash + 3) % daysInRange);
    const candidate = new Date(searchStart.getTime());
    candidate.setDate(candidate.getDate() + pickDay);
    
    // Adjust to next working day
    const workingCandidate = adjustToNextWorkingDay(candidate);
    
    // Ensure still within bounds
    if (workingCandidate.getTime() <= lastAllowedHikeDate.getTime()) {
      firstHikeDate = workingCandidate;
    }
  }
  
  if (!firstHikeDate) return []; // Cannot fit first hike
  
  // Generate subsequent hikes
  const hikeDates = [firstHikeDate];
  let prevHike = firstHikeDate;
  let i = 0;
  
  while (true) {
    i++;
    const monthsGap = pickIntInRange(11, 13, new Set(), hash + 20 + i);
    const nextCandidate = addMonthsClamped(prevHike, monthsGap);
    if (!nextCandidate) break;
    const nextWorking = adjustToPreviousWorkingDay(nextCandidate);
    
    if (nextWorking.getTime() > lastAllowedHikeDate.getTime()) break;
    
    hikeDates.push(nextWorking);
    prevHike = nextWorking;
  }
  
  // CRITICAL FIX: Ensure the most recent hike is AT the lastAllowedHikeDate
  // Current CTC reflects salary AFTER the most recent hike, which must be at the boundary
  const lastHikeInArray = hikeDates.length > 0 ? hikeDates[hikeDates.length - 1] : null;
  if (lastHikeInArray && lastHikeInArray.getTime() < lastAllowedHikeDate.getTime()) {
    // Add final hike at lastAllowedHikeDate (already adjusted to working day)
    hikeDates.push(lastAllowedHikeDate);
  }
  
  return hikeDates;
}

// Compute yearly hike percentages (11-15%, deterministic, vary across hikes)
function computeHikePercentages(hikeCount, hash) {
  if (hikeCount === 0) return [];
  const pcts = [];
  for (let i = 0; i < hikeCount; i++) {
    const pct = 0.11 + (((hash + i * 7) % 5) * 0.01);
    pcts.push(pct);
  }
  
  // If >=2 hikes and all same, tweak one
  if (hikeCount >= 2) {
    const allSame = pcts.every(p => p === pcts[0]);
    if (allSame && pcts[0] < 0.15) {
      pcts[hikeCount - 1] = Math.min(0.15, pcts[0] + 0.01);
    }
  }
  
  return pcts;
}

// Reverse-compound CTC: Given currentCTC (after all hikes), compute joiningCTC
function reverseCompoundCTC(currentCTC, hikePcts) {
  if (isNaN(currentCTC) || currentCTC <= 0) return NaN;
  let ctc = currentCTC;
  for (let i = hikePcts.length - 1; i >= 0; i--) {
    ctc = ctc / (1 + hikePcts[i]);
    ctc = roundDownToThousand(ctc);
  }
  return ctc;
}

// Global variable to store CTC calculation details for explanation
let lastCtcCalcDetails = null;

// Registration Form Modal Functions
async function refreshRegistrationFormFields() {
  const selectedIdx = document.getElementById("regFormEmploymentSelect").value;
  if (selectedIdx === "") {
    document.getElementById("regFormFieldsContainer").style.display = "none";
    lastCtcCalcDetails = null;
    return;
  }
  
  const data = collectForm();
  const companies = data.companies || [];
  const selectedCompany = companies[parseInt(selectedIdx)] || {};
  
  // Get regMeta: Priority 1 = persisted model, Priority 2 = DOM dataset fallback
  const section = document.querySelectorAll("#companiesContainer .section")[parseInt(selectedIdx)];
  let regMeta = null;
  
  // Priority 1: persisted model (selectedCompany.regMeta)
  if (selectedCompany && selectedCompany.regMeta) {
    regMeta = selectedCompany.regMeta;
  }
  
  // Priority 2: DOM dataset fallback
  if (!regMeta && section && section.dataset && section.dataset.regMeta) {
    try {
      regMeta = JSON.parse(section.dataset.regMeta);
    } catch(e) {
      console.warn("refreshRegistrationFormFields: failed to parse dataset.regMeta", e);
      regMeta = null;
    }
  }
  
  // ========== PERSONAL INFORMATION ==========
  document.getElementById("regForm_fullName").value = data.fullName || "";
  document.getElementById("regForm_gender").value = data.gender || "";
  document.getElementById("regForm_pan").value = data.pan || "";
  document.getElementById("regForm_father").value = data.father || "";
  document.getElementById("regForm_qualification").value = data.hg?.degree || "";
  document.getElementById("regForm_address").value = data.permanentAddress || "";
  
  // DOB: Convert to MMM DD, YYYY
  const dobDate = parseDateDMY(data.dob) || parseDateMMM(data.dobText);
  document.getElementById("regForm_dob").value = dobDate ? formatDateMMMDDYYYY(dobDate) : "";
  
  // REQUIRED COMPANY NAME = payroll company ONLY
  document.getElementById("regForm_company").value = selectedCompany.payroll || "";
  
  // ========== EXPERIENCE INFORMATION ==========
  
  // Parse Joining Date
  let joiningDate = parseDateDMY(selectedCompany.joiningDate) || parseDateMMM(selectedCompany.joiningDateText);
  
  // Parse Relieving Date (from lastWorkingDate fields)
  let relievingDate = parseDateDMY(selectedCompany.lastWorkingDate) || parseDateMMM(selectedCompany.lastWorkingDateText);
  
  // Validate Joining Date (do NOT auto-adjust, just warn)
  if (joiningDate) {
    if (isWeekend(joiningDate) || isHoliday(joiningDate)) {
      popupError("Joining Date (" + formatDateMMMDDYYYY(joiningDate) + ") is a weekend or holiday. Please correct it in Admin Console.");
    }
    document.getElementById("regForm_joiningDate").value = formatDateMMMDDYYYY(joiningDate);
  } else {
    document.getElementById("regForm_joiningDate").value = "";
  }
  
  // Validate Relieving Date (do NOT auto-adjust, just warn)
  if (relievingDate) {
    if (isWeekend(relievingDate) || isHoliday(relievingDate)) {
      popupError("Relieving Date (" + formatDateMMMDDYYYY(relievingDate) + ") is a weekend or holiday. Please correct it in Admin Console.");
    }
    document.getElementById("regForm_relievingDate").value = formatDateMMMDDYYYY(relievingDate);
  } else {
    document.getElementById("regForm_relievingDate").value = "";
  }
  
  // Deterministic seed for this employment
  const seedStr = (data.candidateId || data.fullName || "default") + "|" + 
                   (selectedCompany.payroll || "") + "|" + 
                   (selectedCompany.joiningDate || "") + "|" + 
                   (selectedCompany.lastWorkingDate || "");
  const hash = simpleHash(seedStr);
  
  // Compute Offer Date (deterministic, 7-15 days before joining, not 10, working day)
  let offerDate = null;
  if (joiningDate) {
    offerDate = computeOfferDateDeterministic(joiningDate, hash);
  }
  // Use persisted regMeta if available, else computed
  document.getElementById("regForm_offerDate").value = regMeta?.offerDate || (offerDate ? formatDateMMMDDYYYY(offerDate) : "");
  
  // Compute Resignation Date (deterministic, 25-35 days before relieving, not 30, working day)
  let resignationDate = null;
  if (relievingDate) {
    resignationDate = computeResignationDateDeterministic(relievingDate, hash);
  }
  // Use persisted regMeta if available, else computed
  document.getElementById("regForm_resignationDate").value = regMeta?.resignationDate || (resignationDate ? formatDateMMMDDYYYY(resignationDate) : "");
  
  // Compute Hike Dates (yearly cadence with constraints)
  let hikeDates = [];
  if (joiningDate && relievingDate) {
    hikeDates = computeHikeDates(joiningDate, relievingDate, hash);
  }
  
  // Display ONLY the most recent hike date (last in array)
  const recentHikeDate = hikeDates.length > 0 ? hikeDates[hikeDates.length - 1] : null;
  
  // Present Designation
  document.getElementById("regForm_presentDesig").value = selectedCompany.designation || "";
  
  // Offer Designation: use persisted value if available, else default to present designation
  document.getElementById("regForm_offerDesig").value = regMeta?.offerDesig || selectedCompany.designation || "";
  
  // Current CTC
  const currentCtcStr = selectedCompany.ctc || "";
  const currentCtcNum = parseCTC(currentCtcStr);
  const currentCtcRounded = !isNaN(currentCtcNum) ? roundDownToThousand(currentCtcNum) : NaN;
  document.getElementById("regForm_currentCtc").value = !isNaN(currentCtcRounded) ? fmtInt(currentCtcRounded) : "";
  
  // Offer CTC: reverse-compound from current CTC using variable hike percentages
  let joiningCTC = NaN;
  let hikePcts = [];
  let computedOfferCtc = "";
  
  // Rule 1: If currentCtcRounded is valid and hikeDates exist, use reverse-compound logic
  if (!isNaN(currentCtcRounded) && currentCtcRounded > 0 && hikeDates.length > 0) {
    hikePcts = computeHikePercentages(hikeDates.length, hash);
    joiningCTC = reverseCompoundCTC(currentCtcRounded, hikePcts);
    if (!isNaN(joiningCTC) && joiningCTC > 0) {
      computedOfferCtc = fmtInt(joiningCTC);
    }
  }
  // Rule 2: If currentCtcRounded is valid but NO hikes, Offer CTC = Current CTC
  else if (!isNaN(currentCtcRounded) && currentCtcRounded > 0 && hikeDates.length === 0) {
    joiningCTC = currentCtcRounded;
    computedOfferCtc = fmtInt(currentCtcRounded);
  }
  
  // Use persisted regMeta if available, else computed
  const offerCtcDisplay = regMeta && regMeta.offerCtc ? fmtInt(regMeta.offerCtc) : computedOfferCtc;
  document.getElementById("regForm_offerCtc").value = offerCtcDisplay;
  
  // Hike Date assignment: show "-" when no hikes but CTC is valid
  let computedHikeDate = "";
  if (hikeDates.length > 0 && recentHikeDate) {
    computedHikeDate = formatDateMMMDDYYYY(recentHikeDate);
  } else if (!isNaN(currentCtcRounded) && currentCtcRounded > 0) {
    computedHikeDate = "-";
  }
  
  // Use persisted regMeta if available, else computed
  document.getElementById("regForm_hikeDate").value = regMeta?.hikeDate || computedHikeDate;
  
  // Store calculation details for explanation button
  const base8mo = subtractMonthsClamped(relievingDate, 8);
  const extraDays = pickIntInRange(2, 15, new Set(), 77);
  const lastAllowedRaw = base8mo ? new Date(base8mo.getTime()) : null;
  if (lastAllowedRaw) lastAllowedRaw.setDate(lastAllowedRaw.getDate() - extraDays);
  const lastAllowedHikeDate = lastAllowedRaw ? adjustToPreviousWorkingDay(lastAllowedRaw) : null;
  
  if (!isNaN(joiningCTC) && joiningCTC > 0 && hikeDates.length > 0) {
    // Case: hikes exist
    lastCtcCalcDetails = {
      currentCTC: currentCtcNum,
      joiningCTC: joiningCTC,
      hikeDates: hikeDates,
      hikePcts: hikePcts,
      relievingDate: relievingDate,
      lastAllowedHikeDate: lastAllowedHikeDate,
      recentHikeDate: recentHikeDate
    };
  } else if (!isNaN(currentCtcRounded) && currentCtcRounded > 0 && hikeDates.length === 0) {
    // Case: no hikes, but valid CTC
    lastCtcCalcDetails = {
      currentCTC: currentCtcNum,
      joiningCTC: currentCtcRounded,
      hikeDates: [],
      hikePcts: [],
      relievingDate: relievingDate,
      lastAllowedHikeDate: lastAllowedHikeDate,
      recentHikeDate: null,
      note: "No hikes possible for the selected dates. Offer CTC equals Current CTC. Hike Date shown as '-'."
    };
  } else {
    lastCtcCalcDetails = null;
  }
  
  // Technology: use persisted value if available, else default to "IT"
  document.getElementById("regForm_technology").value = regMeta?.technology || "IT";
  
  // Bank Account
  document.getElementById("regForm_bankAcct").value = data.bank || "";
  
  // IFSC: from Personal Info ifscCode
  document.getElementById("regForm_ifsc").value = data.ifscCode || "";
  
  // UAN: blank
  document.getElementById("regForm_uan").value = "";
  
  // Note: use persisted value if available, else blank
  document.getElementById("regForm_note").value = regMeta?.note || "";
  
  // Show form fields container
  document.getElementById("regFormFieldsContainer").style.display = "block";
  
  // Sync calculated fields back to Admin Console for selected employment
  syncRegistrationToAdminEmployment(selectedIdx);
}

// Sync Registration Form values back to Admin Console employment fields
function syncRegistrationToAdminEmployment(selectedIdx) {
  if (selectedIdx === "" || selectedIdx === null || selectedIdx === undefined) return;
  
  const data = collectForm();
  const companies = data.companies || [];
  const idx = parseInt(selectedIdx);
  
  if (idx < 0 || idx >= companies.length) return;
  
  // Read Registration Form values
  const offerDate = document.getElementById("regForm_offerDate")?.value || "";
  const resignationDate = document.getElementById("regForm_resignationDate")?.value || "";
  const hikeDate = document.getElementById("regForm_hikeDate")?.value || "";
  const offerCtc = document.getElementById("regForm_offerCtc")?.value || "";
  const offerDesig = document.getElementById("regForm_offerDesig")?.value || "";
  const technology = document.getElementById("regForm_technology")?.value || "";
  const note = document.getElementById("regForm_note")?.value || "";
  
  // Update the selected company object in the companies array
  // Store as custom fields since the employment model doesn't have these fields natively
  const section = document.querySelectorAll("#companiesContainer .section")[idx];
  if (!section) return;
  
  // Store registration metadata separately (DO NOT overwrite remarks)
  // Use a hidden data attribute to store regMeta JSON
  const regMetaData = {
    offerDate: offerDate,
    resignationDate: resignationDate,
    hikeDate: hikeDate,
    offerCtc: offerCtc,
    offerDesig: offerDesig,
    technology: technology,
    note: note
  };
  section.dataset.regMeta = JSON.stringify(regMetaData);
  
  // Save to localStorage
  try {
    const candidateId = document.getElementById("candidateId").value;
    if (candidateId && candidateId.trim() !== "") {
      const updatedData = collectForm();
      localStorage.setItem("candidate_" + candidateId, JSON.stringify(updatedData));
      
      // Optional: sync to cloud silently (non-blocking, no popup)
      if (window.db && typeof cloudUpsertCandidate === "function") {
        cloudUpsertCandidate(candidateId, updatedData, "admin").catch(err => {
          console.warn("syncRegistrationToAdminEmployment: cloud sync failed", err);
        });
      }
    }
  } catch (err) {
    console.error("Sync to Admin Console failed:", err);
  }
}

// Debounce helper for sync triggers
let syncDebounceTimer = null;
function debouncedSync(selectedIdx) {
  clearTimeout(syncDebounceTimer);
  syncDebounceTimer = setTimeout(() => {
    syncRegistrationToAdminEmployment(selectedIdx);
  }, 200);
}

function openRegistrationFormModal() {
  const companies = Array.from(document.querySelectorAll("#companiesContainer .section"));
  const select = document.getElementById("regFormEmploymentSelect");
  select.innerHTML = '<option value="">-- Select an employment --</option>';
  
  companies.forEach((company, idx) => {
    const title = company.querySelector("[data-co-title]")?.textContent || `Company ${idx + 1}`;
    const option = document.createElement("option");
    option.value = idx;
    option.textContent = title;
    select.appendChild(option);
  });
  
  // Auto-select first employment if available and trigger auto-fill
  if (companies.length > 0) {
    select.value = "0";
    refreshRegistrationFormFields().catch(e => console.error("Auto-fill error on modal open:", e));
  }
  
  // Attach debounced sync listener to modal inputs
  const modal = document.getElementById("registrationFormModal");
  const fieldsContainer = document.getElementById("regFormFieldsContainer");
  if (modal && fieldsContainer && !fieldsContainer.hasAttribute("data-sync-attached")) {
    fieldsContainer.setAttribute("data-sync-attached", "true");
    fieldsContainer.addEventListener("input", () => {
      const currentIdx = document.getElementById("regFormEmploymentSelect").value;
      debouncedSync(currentIdx);
    });
    fieldsContainer.addEventListener("change", () => {
      const currentIdx = document.getElementById("regFormEmploymentSelect").value;
      debouncedSync(currentIdx);
    });
  }
  
  // Clear status display
  const statusDiv = document.getElementById("regWordStatus");
  if (statusDiv) statusDiv.textContent = "";
  
  document.getElementById("registrationFormModal").style.display = "flex";
}

function closeRegistrationFormModal() {
  document.getElementById("registrationFormModal").style.display = "none";
}

function toggleCtcExplanation() {
  const panel = document.getElementById("ctcExplainPanel");
  if (panel.style.display === "none") {
    showCtcExplanation();
  } else {
    hideCtcExplanation();
  }
}

function showCtcExplanation() {
  if (!lastCtcCalcDetails) {
    alert("No CTC calculation available. Please ensure an employment is selected and Current CTC is entered.");
    return;
  }
  
  const panel = document.getElementById("ctcExplainPanel");
  const content = document.getElementById("ctcExplainContent");
  
  content.innerHTML = renderCtcExplainHTML(lastCtcCalcDetails);
  panel.style.display = "block";
}

function hideCtcExplanation() {
  document.getElementById("ctcExplainPanel").style.display = "none";
}

function renderCtcExplainHTML(details) {
  let html = "";
  
  // Check for no-hike case
  if (details.hikeDates && details.hikeDates.length === 0) {
    html += "<div style='padding:20px;background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;'>";
    html += "<h4 style='margin:0 0 12px 0;color:#92400e;font-size:16px;font-weight:700;'>No Hikes Applicable</h4>";
    html += "<p style='margin:0 0 10px 0;font-size:14px;color:#92400e;line-height:1.6;'>";
    html += "Based on the selected <strong>Joining Date</strong> and <strong>Relieving Date</strong>, ";
    html += "there is no scope for any salary hike during the employment period.";
    html += "</p>";
    html += "<p style='margin:0 0 10px 0;font-size:14px;color:#92400e;line-height:1.6;'>";
    html += "Therefore: <strong>Offer CTC = Current CTC = " + fmtInt(details.currentCTC) + "</strong>";
    html += "</p>";
    html += "<p style='margin:0;font-size:13px;color:#78350f;line-height:1.6;font-style:italic;'>";
    html += "The <strong>Hike Date</strong> field is shown as <strong>'-'</strong> to indicate no hikes occurred.";
    html += "</p>";
    html += "</div>";
    return html;
  }
  
  // Compute last and previous hike dates
  const lastHikeDate = details.hikeDates.length > 0 ? details.hikeDates[details.hikeDates.length - 1] : null;
  const previousHikeDate = details.hikeDates.length > 1 ? details.hikeDates[details.hikeDates.length - 2] : null;
  
  // OVERVIEW
  html += "<div style='margin-bottom:18px;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#1f3d6b;font-size:15px;font-weight:700;border-bottom:2px solid #e2e8f0;padding-bottom:6px;'>Overview</h4>";
  html += "<ul style='margin:0;padding-left:22px;font-size:13px;line-height:1.7;'>";
  html += "<li><strong>Current CTC</strong> is the salary after the latest hike.</li>";
  html += "<li>We want the <strong>Joining/Offer CTC</strong> (salary at joining).</li>";
  html += "<li>So we go backward and remove hikes.</li>";
  html += "</ul>";
  html += "</div>";
  
  // FORMULA BOX
  html += "<div style='margin-bottom:18px;padding:14px;background:#f0f9ff;border-left:4px solid #1f3d6b;border-radius:6px;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#1f3d6b;font-size:15px;font-weight:700;'>Formula</h4>";
  html += "<div style='font-family:Consolas,monospace;font-size:13px;line-height:1.8;'>";
  html += "<div style='margin-bottom:6px;'><strong>Forward (when hike happens):</strong> New = Old  (1 + %)</div>";
  html += "<div><strong>Backward (to remove hike):</strong> Old = New  (1 + %)</div>";
  html += "</div>";
  html += "</div>";
  
  // IMPORTANT NOTE BOX
  html += "<div style='margin-bottom:18px;padding:14px;background:#fef3c7;border:2px solid #f59e0b;border-radius:6px;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#92400e;font-size:15px;font-weight:700;'>Important Note</h4>";
  html += "<ul style='margin:0;padding-left:22px;color:#92400e;font-size:13px;line-height:1.7;'>";
  html += "<li><strong>Do NOT subtract the percent.</strong></li>";
  html += "<li>Example: 15% hike means <strong>divide by 1.15</strong> when going backward.</li>";
  html += "<li>If you subtract 15%, you get wrong answer!</li>";
  html += "</ul>";
  html += "</div>";
  
  // YOUR VALUES TABLE
  html += "<div style='margin-bottom:18px;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#1f3d6b;font-size:15px;font-weight:700;border-bottom:2px solid #e2e8f0;padding-bottom:6px;'>Your Values</h4>";
  html += "<table style='width:100%;border-collapse:collapse;font-size:13px;'>";
  html += "<tr style='background:#f8fafc;'><td style='padding:8px 10px;font-weight:600;width:45%;border-bottom:1px solid #e2e8f0;'>Current CTC</td><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;'>" + fmtInt(details.currentCTC) + "</td></tr>";
  html += "<tr><td style='padding:8px 10px;font-weight:600;border-bottom:1px solid #e2e8f0;'>Relieving Date</td><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;'>" + formatDateMMMDDYYYY(details.relievingDate) + "</td></tr>";
  html += "<tr style='background:#f8fafc;'><td style='padding:8px 10px;font-weight:600;border-bottom:1px solid #e2e8f0;'>Last Hike Date</td><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;'>" + (lastHikeDate ? formatDateMMMDDYYYY(lastHikeDate) : "N/A") + "</td></tr>";
  html += "<tr><td style='padding:8px 10px;font-weight:600;border-bottom:1px solid #e2e8f0;'>Previous Hike Date</td><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;'>" + (previousHikeDate ? formatDateMMMDDYYYY(previousHikeDate) : "") + "</td></tr>";
  html += "<tr style='background:#f8fafc;'><td style='padding:8px 10px;font-weight:600;'>Total Hike Events</td><td style='padding:8px 10px;'>" + details.hikeDates.length + "</td></tr>";
  html += "</table>";
  html += "<div style='margin-top:6px;font-size:11px;color:#64748b;font-style:italic;'>Last hike must be 8 months before relieving date</div>";
  html += "</div>";
  
  // ALL HIKES TABLE
  html += "<div style='margin-bottom:18px;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#1f3d6b;font-size:15px;font-weight:700;border-bottom:2px solid #e2e8f0;padding-bottom:6px;'>All Hikes</h4>";
  html += "<table style='width:100%;border-collapse:collapse;font-size:13px;'>";
  html += "<thead><tr style='background:#1f3d6b;color:#fff;'><th style='padding:8px 10px;text-align:left;width:20%;'>Hike #</th><th style='padding:8px 10px;text-align:left;width:50%;'>Date</th><th style='padding:8px 10px;text-align:left;width:30%;'>Increase %</th></tr></thead>";
  html += "<tbody>";
  for (let i = 0; i < details.hikeDates.length; i++) {
    const hikeDate = formatDateMMMDDYYYY(details.hikeDates[i]);
    const hikePct = (details.hikePcts[i] * 100).toFixed(1);
    const rowBg = (i % 2 === 0) ? "#f8fafc" : "#fff";
    html += "<tr style='background:" + rowBg + ";'><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;font-weight:600;'>" + (i + 1) + "</td><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;'>" + hikeDate + "</td><td style='padding:8px 10px;border-bottom:1px solid #e2e8f0;color:#2d7d46;font-weight:600;'>+" + hikePct + "%</td></tr>";
  }
  html += "</tbody></table>";
  html += "</div>";
  
  // STEP-BY-STEP BACKWARD CALCULATION
  html += "<div style='margin-bottom:18px;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#1f3d6b;font-size:15px;font-weight:700;border-bottom:2px solid #e2e8f0;padding-bottom:6px;'>Step-by-Step Backward Math</h4>";
  html += "<div style='background:#f9fafb;padding:14px;border-radius:6px;border:1px solid #e2e8f0;'>";
  html += "<div style='margin-bottom:10px;font-family:Consolas,monospace;font-size:13px;font-weight:600;color:#1f3d6b;'>Start: Current CTC = " + fmtInt(details.currentCTC) + "</div>";
  
  let ctc = details.currentCTC;
  for (let i = details.hikePcts.length - 1; i >= 0; i--) {
    const pct = details.hikePcts[i];
    const pctDisplay = (pct * 100).toFixed(1);
    const factor = (1 + pct).toFixed(4);
    const prevCTC = ctc;
    ctc = ctc / (1 + pct);
    ctc = roundDownToThousand(ctc);
    
    html += "<div style='margin-bottom:10px;padding:10px;background:#fff;border-left:3px solid #2d7d46;border-radius:3px;'>";
    html += "<div style='font-weight:600;font-size:13px;margin-bottom:4px;'>Step " + (details.hikePcts.length - i) + ": Before " + pctDisplay + "% hike</div>";
    html += "<div style='font-family:Consolas,monospace;font-size:12px;'>&nbsp;&nbsp;= " + fmtInt(prevCTC) + "  " + factor + " = <strong style='color:#2d7d46;'>" + fmtInt(ctc) + "</strong></div>";
    html += "</div>";
  }
  
  html += "<div style='margin-top:14px;padding:12px;background:#2d7d46;color:#fff;border-radius:6px;text-align:center;font-size:16px;font-weight:700;'>";
  html += "Joining/Offer CTC = " + fmtInt(details.joiningCTC);
  html += "</div>";
  html += "</div>";
  html += "</div>";
  
  // QUICK CHECK
  html += "<div style='margin-bottom:0;padding:14px;background:#e7f0ff;border-radius:6px;border:1px solid #bfdbfe;'>";
  html += "<h4 style='margin:0 0 10px 0;color:#1f3d6b;font-size:15px;font-weight:700;'>Quick Check</h4>";
  html += "<div style='font-size:13px;font-family:Consolas,monospace;'>";
  html += "Joining CTC  ";
  for (let i = 0; i < details.hikePcts.length; i++) {
    html += (1 + details.hikePcts[i]).toFixed(4);
    if (i < details.hikePcts.length - 1) html += "  ";
  }
  html += "  Current CTC";
  html += "<br><span style='color:#64748b;font-size:12px;font-family:system-ui;margin-top:4px;display:inline-block;'>This confirms our calculation is correct.</span>";
  html += "</div>";
  html += "</div>";
  
  return html;
}

function buildCtcExplainPlainText(details) {
  let text = "";
  text += "=".repeat(60) + "\n";
  text += "        CTC CALCULATION EXPLANATION\n";
  text += "=".repeat(60) + "\n\n";
  
  // Compute last and previous hike dates
  const lastHikeDate = details.hikeDates.length > 0 ? details.hikeDates[details.hikeDates.length - 1] : null;
  const previousHikeDate = details.hikeDates.length > 1 ? details.hikeDates[details.hikeDates.length - 2] : null;
  
  text += "OVERVIEW\n";
  text += " Current CTC is the salary after the latest hike.\n";
  text += " We want the Joining/Offer CTC (salary at joining).\n";
  text += " So we go backward and remove hikes.\n\n";
  
  text += "FORMULA\n";
  text += "Forward (when hike happens): New = Old  (1 + %)\n";
  text += "Backward (to remove hike): Old = New  (1 + %)\n\n";
  
  text += "IMPORTANT NOTE\n";
  text += " Do NOT subtract the percent.\n";
  text += " Example: 15% hike means divide by 1.15 when going backward.\n";
  text += " If you subtract 15%, you get wrong answer!\n\n";
  
  text += "YOUR VALUES\n";
  text += "Current CTC: " + fmtInt(details.currentCTC) + "\n";
  text += "Relieving Date: " + formatDateMMMDDYYYY(details.relievingDate) + "\n";
  text += "Last Hike Date: " + (lastHikeDate ? formatDateMMMDDYYYY(lastHikeDate) : "N/A") + "\n";
  text += "Previous Hike Date: " + (previousHikeDate ? formatDateMMMDDYYYY(previousHikeDate) : "") + "\n";
  text += "Total Hike Events: " + details.hikeDates.length + "\n";
  text += "(Last hike must be 8 months before relieving date)\n\n";
  
  text += "ALL HIKES\n";
  for (let i = 0; i < details.hikeDates.length; i++) {
    const hikeDate = formatDateMMMDDYYYY(details.hikeDates[i]);
    const hikePct = (details.hikePcts[i] * 100).toFixed(1);
    text += "Hike #" + (i + 1) + ": " + hikeDate + " (+" + hikePct + "%)\n";
  }
  text += "\n";
  
  text += "STEP-BY-STEP BACKWARD MATH\n";
  text += "Start: Current CTC = " + fmtInt(details.currentCTC) + "\n\n";
  
  let ctc = details.currentCTC;
  for (let i = details.hikePcts.length - 1; i >= 0; i--) {
    const pctDisplay = (details.hikePcts[i] * 100).toFixed(1);
    const factor = (1 + details.hikePcts[i]).toFixed(4);
    const prevCTC = ctc;
    ctc = ctc / (1 + details.hikePcts[i]);
    ctc = roundDownToThousand(ctc);
    text += "Step " + (details.hikePcts.length - i) + ": Before " + pctDisplay + "% hike\n";
    text += "  = " + fmtInt(prevCTC) + "  " + factor + " = " + fmtInt(ctc) + "\n\n";
  }
  
  text += "=" .repeat(60) + "\n";
  text += "JOINING/OFFER CTC = " + fmtInt(details.joiningCTC) + "\n";
  text += "=" .repeat(60) + "\n\n";
  
  text += "QUICK CHECK\n";
  text += "Joining CTC  ";
  for (let i = 0; i < details.hikePcts.length; i++) {
    text += (1 + details.hikePcts[i]).toFixed(4);
    if (i < details.hikePcts.length - 1) text += "  ";
  }
  text += "  Current CTC\n";
  text += "This confirms our calculation is correct.\n";
  
  return text;
}

function copyCtcExplain() {
  if (!lastCtcCalcDetails) {
    alert("No calculation to copy.");
    return;
  }
  
  const plainText = buildCtcExplainPlainText(lastCtcCalcDetails);
  
  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(plainText).then(() => {
      showCopyToast();
    }).catch(err => {
      // Fallback to old method
      copyTextFallback(plainText);
    });
  } else {
    // Fallback for older browsers
    copyTextFallback(plainText);
  }
}

function copyTextFallback(text) {
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.style.position = "fixed";
  textarea.style.top = "0";
  textarea.style.left = "0";
  textarea.style.opacity = "0";
  document.body.appendChild(textarea);
  textarea.focus();
  textarea.select();
  
  try {
    const successful = document.execCommand("copy");
    if (successful) {
      showCopyToast();
    } else {
      alert("Copy failed. Please select and copy manually.");
    }
  } catch (err) {
    alert("Copy failed: " + err.message);
  }
  
  document.body.removeChild(textarea);
}

function showCopyToast() {
  const toast = document.getElementById("ctcCopyToast");
  if (toast) {
    toast.style.display = "block";
    setTimeout(() => {
      toast.style.display = "none";
    }, 2000);
  }
}

function exportRegistrationFormWord() {
  console.log("EXPORT_WORD_CLICK");
  const statusDiv = document.getElementById("regWordStatus");
  
  try {
    // STEP 1: Validate libraries
    console.log("EXPORT_WORD_START");
    if (statusDiv) statusDiv.textContent = "Checking libraries";
    
    if (!window.docx) {
      console.error("EXPORT_WORD_FATAL: window.docx undefined");
      if (statusDiv) statusDiv.textContent = "Export failed: docx library not loaded.";
      popupError("Export failed: docx library not loaded. Refresh page and check Network tab.");
      return;
    }
    
    if (!window.saveAs) {
      console.error("EXPORT_WORD_FATAL: window.saveAs undefined");
      if (statusDiv) statusDiv.textContent = "Export failed: FileSaver library not loaded.";
      popupError("Export failed: FileSaver library not loaded. Refresh page and check Network tab.");
      return;
    }
    
    // STEP 2: Destructure docx API
    const { Document, Paragraph, Table, TableRow, TableCell, WidthType, AlignmentType, Packer } = window.docx;
    
    console.log("EXPORT_WORD_LIBS_OK", { hasDocument: !!Document, hasPacker: !!Packer, hasTable: !!Table });
    if (statusDiv) statusDiv.textContent = "Building document";
    
    // STEP 3: Validate employment selected
    const selectedIdx = document.getElementById("regFormEmploymentSelect").value;
    if (selectedIdx === "") {
      if (statusDiv) statusDiv.textContent = "Please select employment.";
      popupError("Please select an employment record.");
      return;
    }
    
    // STEP 4: Read form data from modal inputs
    const formData = {
      fullName: (document.getElementById("regForm_fullName")?.value || "").trim(),
      gender: (document.getElementById("regForm_gender")?.value || "").trim(),
      pan: (document.getElementById("regForm_pan")?.value || "").trim(),
      father: (document.getElementById("regForm_father")?.value || "").trim(),
      qualification: (document.getElementById("regForm_qualification")?.value || "").trim(),
      address: (document.getElementById("regForm_address")?.value || "").trim(),
      dob: (document.getElementById("regForm_dob")?.value || "").trim(),
      company: (document.getElementById("regForm_company")?.value || "").trim(),
      offerDate: (document.getElementById("regForm_offerDate")?.value || "").trim(),
      joiningDate: (document.getElementById("regForm_joiningDate")?.value || "").trim(),
      offerDesig: (document.getElementById("regForm_offerDesig")?.value || "").trim(),
      presentDesig: (document.getElementById("regForm_presentDesig")?.value || "").trim(),
      offerCtc: fmtInt((document.getElementById("regForm_offerCtc")?.value || "").trim()),
      currentCtc: fmtInt((document.getElementById("regForm_currentCtc")?.value || "").trim()),
      hikeDate: (document.getElementById("regForm_hikeDate")?.value || "").trim(),
      technology: (document.getElementById("regForm_technology")?.value || "").trim(),
      bankAcct: (document.getElementById("regForm_bankAcct")?.value || "").trim(),
      ifsc: (document.getElementById("regForm_ifsc")?.value || "").trim(),
      uan: (document.getElementById("regForm_uan")?.value || "").trim(),
      resignationDate: (document.getElementById("regForm_resignationDate")?.value || "").trim(),
      relievingDate: (document.getElementById("regForm_relievingDate")?.value || "").trim(),
      note: (document.getElementById("regForm_note")?.value || "").trim()
    };
    
    // ========== DATE FORMAT ENFORCEMENT: Convert any DD/MM/YYYY to MMM DD, YYYY ==========
    const ensureMMMFormat = (val) => {
      if (!val) return "";
      // If already MMM format, return as-is
      if (parseDateMMM(val)) return val;
      // Try DD/MM/YYYY conversion
      const d = parseDateDMY(val);
      return d ? formatDateMMMDDYYYY(d) : val;
    };
    
    formData.dob = ensureMMMFormat(formData.dob);
    formData.offerDate = ensureMMMFormat(formData.offerDate);
    formData.joiningDate = ensureMMMFormat(formData.joiningDate);
    formData.hikeDate = ensureMMMFormat(formData.hikeDate);
    formData.resignationDate = ensureMMMFormat(formData.resignationDate);
    formData.relievingDate = ensureMMMFormat(formData.relievingDate);
    
    console.log("EXPORT_WORD_DATA_READ", { fullName: formData.fullName, company: formData.company });
    
    // STEP 5: Create document with valid structure
    // Formatting constants
    const { TextRun, BorderStyle, VerticalAlign, HeightRule } = window.docx;
    const FONT = "Cambria";
    const SIZE = 21; // 10.5pt in half-points
    const BLACK = "000000";
    const blackBorder = {
      style: BorderStyle.SINGLE,
      size: 1,
      color: BLACK
    };
    const cellMargins = { top: 120, left: 180, bottom: 120, right: 180 };
    
    const doc = new Document({
      sections: [{
        properties: {
          page: {
            margin: { top: 1440, right: 720, bottom: 1440, left: 1440 }
          }
        },
        children: [
          // Title
          new Paragraph({
            children: [
              new TextRun({
                text: "REGISTRATION FORM",
                font: FONT,
                size: SIZE,
                color: BLACK
              })
            ],
            alignment: AlignmentType.CENTER,
            spacing: { before: 0, after: 240 }
          }),
          
          // PERSONAL INFORMATION heading
          new Paragraph({
            children: [
              new TextRun({
                text: "PERSONAL INFORMATION",
                font: FONT,
                size: SIZE,
                color: BLACK
              })
            ],
            alignment: AlignmentType.LEFT,
            spacing: { before: 0, after: 120 }
          }),
          
          // Personal Info Table (2 columns, 8 rows)
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
              top: blackBorder,
              bottom: blackBorder,
              left: blackBorder,
              right: blackBorder,
              insideHorizontal: blackBorder,
              insideVertical: blackBorder
            },
            rows: [
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "FULL NAME:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.fullName, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "GENDER:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.gender, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "PAN NO:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.pan, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "FATHER NAME:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.father, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "QUALIFICATION", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.qualification, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                height: { value: 1400, rule: HeightRule.ATLEAST },
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "PERMANENT ADDRESS", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.address, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "DOB", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.dob, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "REQUIRED COMPANY NAME", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 70, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.company, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              })
            ]
          }),
          
          // EXPERIENCE INFORMATION heading
          new Paragraph({
            children: [
              new TextRun({
                text: "EXPERIENCE INFORMATION",
                font: FONT,
                size: SIZE,
                color: BLACK
              })
            ],
            alignment: AlignmentType.LEFT,
            spacing: { before: 240, after: 120 }
          }),
          
          // Experience Info Table (4 columns, 7 rows)
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
              top: blackBorder,
              bottom: blackBorder,
              left: blackBorder,
              right: blackBorder,
              insideHorizontal: blackBorder,
              insideVertical: blackBorder
            },
            rows: [
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Offer Date:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.offerDate, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Joining Date", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.joiningDate, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Offer Designation:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.offerDesig, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Present Designation:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.presentDesig, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Joining CTC:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.offerCtc, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Current CTC:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.currentCtc, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Hike Date:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.hikeDate, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Technology", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.technology, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [
                      new Paragraph({
                        children: [new TextRun({ text: "Resignation Date:", font: FONT, size: SIZE, color: BLACK })],
                        spacing: { before: 0, after: 0 }
                      }),
                      new Paragraph({
                        children: [new TextRun({ text: "(if you want please mention dates otherwise leave it)", font: FONT, size: SIZE, color: BLACK })],
                        spacing: { before: 0, after: 0 }
                      })
                    ]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.resignationDate, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [
                      new Paragraph({
                        children: [new TextRun({ text: "Relieving Date", font: FONT, size: SIZE, color: BLACK })],
                        spacing: { before: 0, after: 0 }
                      }),
                      new Paragraph({
                        children: [new TextRun({ text: "(if you want please mention dates otherwise leave it)", font: FONT, size: SIZE, color: BLACK })],
                        spacing: { before: 0, after: 0 }
                      })
                    ]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.relievingDate, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "Bank account No", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.bankAcct, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 20, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: "IFSC:", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 30, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.ifsc, font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({
                    width: { size: 50, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.uan || "-", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  }),
                  new TableCell({
                    width: { size: 50, type: WidthType.PERCENTAGE },
                    verticalAlign: VerticalAlign.TOP,
                    margins: cellMargins,
                    children: [new Paragraph({
                      children: [new TextRun({ text: formData.note || "Need the new PF account to be created in this UAN", font: FONT, size: SIZE, color: BLACK })],
                      spacing: { before: 0, after: 0 }
                    })]
                  })
                ]
              })
            ]
          })
        ]
      }]
    });
    
    console.log("EXPORT_WORD_DOC_CREATED");
    if (statusDiv) statusDiv.textContent = "Generating file";
    
    // STEP 6: Generate blob
    Packer.toBlob(doc).then(blob => {
      console.log("EXPORT_WORD_BLOB_READY", { size: blob?.size });
      
      if (!blob || blob.size === 0) {
        console.error("EXPORT_WORD_BLOB_EMPTY");
        if (statusDiv) statusDiv.textContent = "Export failed: empty blob generated.";
        popupError("Export Word failed: empty blob.");
        return;
      }
      
      // STEP 7: Sanitize filename and download
      const rawName = (formData.fullName || "Candidate").trim();
      const safeName = rawName
        .replace(/[\\/:*?"<>|]/g, "")
        .replace(/\s+/g, " ")
        .trim()
        .replace(/ /g, "_");
      const filename = `${safeName}_Registration_Form.docx`;
      
      console.log("EXPORT_WORD_DOWNLOADING", filename);
      window.saveAs(blob, filename);
      
      console.log("EXPORT_WORD_SUCCESS", filename);
      if (statusDiv) statusDiv.textContent = "Downloaded: " + filename;
      
      setTimeout(() => closeRegistrationFormModal(), 1000);
    }).catch(err => {
      console.error("EXPORT_WORD_PACKER_ERROR", err, err?.stack);
      const errMsg = "Export failed: " + (err?.message || String(err));
      if (statusDiv) statusDiv.textContent = errMsg;
      popupError(errMsg);
    });
    
  } catch (err) {
    console.error("EXPORT_WORD_FATAL", err, err?.stack);
    const statusDiv = document.getElementById("regWordStatus");
    const errMsg = "Export failed: " + (err?.message || String(err));
    if (statusDiv) statusDiv.textContent = errMsg;
    popupError(errMsg);
  }
}

</script>

<!-- UMD builds for Word export (ensure globals are created) -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<!-- Verify libraries loaded -->
<script>
  console.log("WORD_LIB_CHECK", { docx: typeof window.docx, saveAs: typeof window.saveAs });
  if (typeof window.docx === "undefined" || typeof window.saveAs !== "function") {
    console.error("WORD_LIB_CHECK_FAILED: CDN scripts may be blocked");
  }
</script>

</body>
</html>
